{"version":3,"file":"server-mediaoverlays.js","sourceRoot":"","sources":["../../../../src/http/server-mediaoverlays.ts"],"names":[],"mappings":"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","sourcesContent":["import * as crypto from \"crypto\";\r\nimport * as path from \"path\";\r\n\r\nimport {\r\n    getAllMediaOverlays,\r\n    getMediaOverlay,\r\n    mediaOverlayURLParam,\r\n    mediaOverlayURLPath,\r\n} from \"@parser/epub\";\r\nimport { encodeURIComponent_RFC3986, isHTTP } from \"@utils/http/UrlUtils\";\r\nimport { sortObject, traverseJsonObjects } from \"@utils/JsonUtils\";\r\nimport * as css2json from \"css2json\";\r\nimport * as debug_ from \"debug\";\r\nimport * as express from \"express\";\r\nimport * as jsonMarkup from \"json-markup\";\r\nimport { JSON as TAJSON } from \"ta-json\";\r\n\r\nimport { Publication } from \"@models/publication\";\r\nimport { Server } from \"./server\";\r\n\r\nconst debug = debug_(\"r2:server:mediaoverlays\");\r\n\r\nexport function serverMediaOverlays(server: Server, routerPathBase64: express.Router) {\r\n\r\n    // https://github.com/mafintosh/json-markup/blob/master/style.css\r\n    const jsonStyle = `\r\n.json-markup {\r\n    line-height: 17px;\r\n    font-size: 13px;\r\n    font-family: monospace;\r\n    white-space: pre;\r\n}\r\n.json-markup-key {\r\n    font-weight: bold;\r\n}\r\n.json-markup-bool {\r\n    color: firebrick;\r\n}\r\n.json-markup-string {\r\n    color: green;\r\n}\r\n.json-markup-null {\r\n    color: gray;\r\n}\r\n.json-markup-number {\r\n    color: blue;\r\n}\r\n`;\r\n\r\n    const routerMediaOverlays = express.Router({ strict: false });\r\n    // routerMediaOverlays.use(morgan(\"combined\"));\r\n\r\n    routerMediaOverlays.get([\"/\", \"/show/:\" + mediaOverlayURLParam + \"?\"],\r\n        async (req: express.Request, res: express.Response) => {\r\n\r\n            if (!req.params.pathBase64) {\r\n                req.params.pathBase64 = (req as any).pathBase64;\r\n            }\r\n            if (!req.params.lcpPass64) {\r\n                req.params.lcpPass64 = (req as any).lcpPass64;\r\n            }\r\n\r\n            const isShow = req.url.indexOf(\"/show\") >= 0 || req.query.show;\r\n\r\n            // debug(req.method);\r\n            const isHead = req.method.toLowerCase() === \"head\";\r\n            if (isHead) {\r\n                debug(\"HEAD !!!!!!!!!!!!!!!!!!!\");\r\n            }\r\n\r\n            const isCanonical = req.query.canonical && req.query.canonical === \"true\";\r\n\r\n            const isSecureHttp = req.secure ||\r\n                req.protocol === \"https\" ||\r\n                req.get(\"X-Forwarded-Proto\") === \"https\"\r\n                // (req.headers.host && req.headers.host.indexOf(\"now.sh\") >= 0) ||\r\n                // (req.hostname && req.hostname.indexOf(\"now.sh\") >= 0)\r\n                ;\r\n\r\n            const pathBase64Str = new Buffer(req.params.pathBase64, \"base64\").toString(\"utf8\");\r\n\r\n            // const fileName = path.basename(pathBase64Str);\r\n            // const ext = path.extname(fileName).toLowerCase();\r\n\r\n            let publication: Publication;\r\n            try {\r\n                publication = await server.loadOrGetCachedPublication(pathBase64Str);\r\n            } catch (err) {\r\n                debug(err);\r\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\r\n                    + err + \"</p></body></html>\");\r\n                return;\r\n            }\r\n\r\n            // dumpPublication(publication);\r\n\r\n            const rootUrl = (isSecureHttp ? \"https://\" : \"http://\")\r\n                + req.headers.host + \"/pub/\"\r\n                + (req.params.lcpPass64 ?\r\n                    (server.lcpBeginToken + encodeURIComponent_RFC3986(req.params.lcpPass64) + server.lcpEndToken) :\r\n                    \"\")\r\n                + encodeURIComponent_RFC3986(req.params.pathBase64);\r\n\r\n            function absoluteURL(href: string): string {\r\n                return rootUrl + \"/\" + href;\r\n            }\r\n\r\n            function absolutizeURLs(jsonObject: any) {\r\n                traverseJsonObjects(jsonObject,\r\n                    (obj) => {\r\n                        if (obj.text && typeof obj.text === \"string\"\r\n                            && !isHTTP(obj.text)) {\r\n                            // obj.text_ = obj.text;\r\n                            obj.text = absoluteURL(obj.text);\r\n                        }\r\n\r\n                        if (obj.audio && typeof obj.audio === \"string\"\r\n                            && !isHTTP(obj.audio)) {\r\n                            // obj.audio_ = obj.audio;\r\n                            obj.audio = absoluteURL(obj.audio);\r\n                        }\r\n                    });\r\n            }\r\n\r\n            let objToSerialize: any = null;\r\n\r\n            const resource = isShow ?\r\n                (req.query.show ? req.query.show : req.params[mediaOverlayURLParam]) :\r\n                req.query[mediaOverlayURLParam];\r\n            if (resource && resource !== \"all\") {\r\n                try {\r\n                    objToSerialize = await getMediaOverlay(publication, resource);\r\n                } catch (err) {\r\n                    debug(err);\r\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\r\n                        + err + \"</p></body></html>\");\r\n                    return;\r\n                }\r\n            } else {\r\n                try {\r\n                    objToSerialize = await getAllMediaOverlays(publication);\r\n                } catch (err) {\r\n                    debug(err);\r\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\r\n                        + err + \"</p></body></html>\");\r\n                    return;\r\n                }\r\n            }\r\n\r\n            if (!objToSerialize) {\r\n                objToSerialize = [];\r\n            }\r\n\r\n            let jsonObj = TAJSON.serialize(objToSerialize);\r\n            jsonObj = { \"media-overlay\": jsonObj };\r\n\r\n            if (isShow) {\r\n                absolutizeURLs(jsonObj);\r\n\r\n                // const jsonStr = global.JSON.stringify(jsonObj, null, \"    \");\r\n\r\n                // // breakLength: 100  maxArrayLength: undefined\r\n                // const dumpStr = util.inspect(objToSerialize,\r\n                //     { showHidden: false, depth: 1000, colors: false, customInspect: true });\r\n\r\n                const jsonPretty = jsonMarkup(jsonObj, css2json(jsonStyle));\r\n\r\n                res.status(200).send(\"<html><body>\" +\r\n                    \"<h1>\" + path.basename(pathBase64Str) + \"</h1>\" +\r\n                    \"<p><pre>\" + jsonPretty + \"</pre></p>\" +\r\n                    // \"<p><pre>\" + jsonStr + \"</pre></p>\" +\r\n                    // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\r\n                    \"</body></html>\");\r\n            } else {\r\n                // absolutizeURLs(jsonObj);\r\n\r\n                server.setResponseCORS(res);\r\n                res.set(\"Content-Type\", \"application/vnd.readium.mo+json; charset=utf-8\");\r\n\r\n                const jsonStr = isCanonical ?\r\n                    global.JSON.stringify(sortObject(jsonObj), null, \"\") :\r\n                    global.JSON.stringify(jsonObj, null, \"  \");\r\n\r\n                const checkSum = crypto.createHash(\"sha256\");\r\n                checkSum.update(jsonStr);\r\n                const hash = checkSum.digest(\"hex\");\r\n\r\n                const match = req.header(\"If-None-Match\");\r\n                if (match === hash) {\r\n                    debug(\"smil cache\");\r\n                    res.status(304); // StatusNotModified\r\n                    res.end();\r\n                    return;\r\n                }\r\n\r\n                res.setHeader(\"ETag\", hash);\r\n                // res.setHeader(\"Cache-Control\", \"public,max-age=86400\");\r\n\r\n                res.status(200);\r\n\r\n                if (isHead) {\r\n                    res.end();\r\n                } else {\r\n                    res.send(jsonStr);\r\n                }\r\n            }\r\n        });\r\n\r\n    routerPathBase64.use(\"/:pathBase64/\" + mediaOverlayURLPath, routerMediaOverlays);\r\n}\r\n"]}