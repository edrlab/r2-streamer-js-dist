{"version":3,"file":"server-opds-browse-v2.js","sourceRoot":"","sources":["../../../../src/http/server-opds-browse-v2.ts"],"names":[],"mappings":";;;AAOA,mCAAqC;AACrC,8BAAgC;AAChC,kCAAoC;AACpC,iCAAmC;AACnC,wCAA0C;AAC1C,+BAAiC;AACjC,2BAA6B;AAC7B,iCAAmC;AACnC,uDAAyD;AAEzD,wDAA6E;AAC7E,sDAAwD;AACxD,4FAAwF;AACxF,8EAA2E;AAC3E,8DAE2C;AAC3C,2DAAoE;AACpE,sEAA+E;AAE/E,sEAAmE;AACnE,6CAAsE;AAEtE,+EAAkF;AAClF,mFAAyE;AAEzE,IAAM,KAAK,GAAG,MAAM,CAAC,wCAAwC,CAAC,CAAC;AAGlD,QAAA,yBAAyB,GAAG,iBAAiB,CAAC;AAG9C,QAAA,uBAAuB,GAAG,WAAW,CAAC;AAEnD,SAAgB,oBAAoB,CAAC,OAAe,EAAE,SAA8B;IAApF,iBA0XC;IAvXG,IAAM,SAAS,GAAG,0VAsBrB,CAAC;IAGE,IAAM,oBAAoB,GAAG,OAAO,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;IAC/D,oBAAoB,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE,UAAC,GAAQ,IAAK,OAAA,KAAK,CAAC,GAAG,CAAC,EAAV,CAAU,EAAE,EAAE,CAAC,CAAC,CAAC;IAE9F,oBAAoB,CAAC,GAAG,CAAC,sDAAqB,CAAC,CAAC;IAEhD,oBAAoB,CAAC,GAAG,CAAC,GAAG,EAAE,UAAC,IAAqB,EAAE,GAAqB;QAEvE,IAAI,IAAI,GAAG,cAAc,CAAC;QAC1B,IAAI,IAAI,8EAA4E;YAChF,8DAA8D;YAC9D,oDAAkD;YAClD,oBAAoB;YACpB,+CAA+C;YAC/C,mBAAmB;aAGnB,OAAK,iCAAyB,SAAM,CAAA;YACpC,sEAAoE;YACpE,gCAAgC,CAAC;QACrC,IAAI,IAAI,SAAS,CAAC;QAElB,IAAI,IAAI,kCAAkC,CAAC;QAE3C,IAAI,IAAI,wCAAsC;YAC1C,2DAAmD;YACnD,8CAA0C,CAAC;QAE/C,IAAI,IAAI,gBAAgB,CAAC;QAEzB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC/B,CAAC,CAAC,CAAC;IAEH,oBAAoB,CAAC,KAAK,CAAC,YAAY,EAAE,UAAC,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK;QAClE,GAAgC,CAAC,UAAU,GAAG,KAAK,CAAC;QACrD,IAAI,EAAE,CAAC;IACX,CAAC,CAAC,CAAC;IAEH,oBAAoB,CAAC,GAAG,CAAC,IAAI,GAAG,yBAAW,GAAG,KAAK,EAAE,UAAO,GAAoB,EAAE,GAAqB;;;;;;oBAE7F,SAAS,GAAI,GAAgC,CAAC,MAAM,CAAC;oBAE3D,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE;wBACvB,SAAS,CAAC,UAAU,GAAI,GAAgC,CAAC,UAAU,CAAC;qBACvE;oBAEK,UAAU,GAAG,SAAS,CAAC,UAAU,CAAC;oBAIxC,KAAK,CAAC,UAAU,CAAC,CAAC;oBAEZ,YAAY,GAAG,GAAG,CAAC,MAAM;wBAC3B,GAAG,CAAC,QAAQ,KAAK,OAAO;wBACxB,GAAG,CAAC,GAAG,CAAC,mBAAmB,CAAC,KAAK,OAAO,CAGvC;oBACC,OAAO,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC;0BACjD,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC;oBAEjB,OAAO,GAAG,UAAC,GAAQ;wBACrB,KAAK,CAAC,GAAG,CAAC,CAAC;wBACX,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,6CAA6C;8BAC5D,GAAG,GAAG,oBAAoB,CAAC,CAAC;oBACtC,CAAC,CAAC;oBAEI,OAAO,GAAG,UAAO,QAAiC;;;;;oCAMpD,IAAI,QAAQ,CAAC,UAAU,IAAI,CAAC,QAAQ,CAAC,UAAU,GAAG,GAAG,IAAI,QAAQ,CAAC,UAAU,IAAI,GAAG,CAAC,EAAE;wCAClF,OAAO,CAAC,YAAY,GAAG,QAAQ,CAAC,UAAU,CAAC,CAAC;wCAC5C,WAAO;qCACV;;;;oCAIkB,WAAM,mCAAqB,CAAC,QAAQ,CAAC,EAAA;;oCAApD,YAAY,GAAG,SAAqC,CAAC;;;;oCAErD,KAAK,CAAC,KAAG,CAAC,CAAC;oCACX,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,6CAA6C;0CAC5D,KAAG,GAAG,oBAAoB,CAAC,CAAC;oCAClC,WAAO;;oCAEL,WAAW,GAAG,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oCAC5C,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC;oCAEvC,aAAa,GAAG,CAAC,YAAY,CAAC,YAAY;wCAC5C,CAAC,YAAY,CAAC,UAAU;wCACxB,CAAC,YAAY,CAAC,MAAM;wCACpB,CAAC,YAAY,CAAC,QAAQ;wCACtB,YAAY,CAAC,QAAQ,CAAC;oCACpB,MAAM,GAAG,CAAC,aAAa,IAAI,YAAY,CAAC,cAAc,CAAC;oCAEvD,SAAS,GAEX,aAAa,CAAC,CAAC,CAAC,gCAAiB,CAAkB,YAAY,EAAE,mCAAe,CAAC,CAAC,CAAC;wCAEnF,CAAC,MAAM,CAAC,CAAC,CAAC,gCAAiB,CAAwB,YAAY,EAAE,gDAAqB,CAAC,CAAC,CAAC;4CACzF,gCAAiB,CAAW,YAAY,EAAE,gBAAQ,CAAC,CAAC,CAAC;oCAEnD,aAAa,GAAG,8BAAe,CAAC,SAAS,CAAC,CAAC;oCAG3C,UAAU,GAAG,CAAC,SAAS,CAAC,QAAQ,IAAI,SAAS,CAAC,QAAQ,KAAK,KAAK,CAAC;oCACvE,IAAI,UAAU,EAAE;wCAEN,mBAAmB,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,MAAM,EAAE,aAAa,CAAC,CAAC;wCACtE,gBAAgB,GAAG;4CACrB,kBAAkB;4CAClB,yBAAyB;4CACzB,oBAAoB;4CACpB,iBAAiB;4CACjB,6BAA6B;4CAC7B,oCAAoC;4CACpC,6BAA6B;4CAC7B,sBAAsB;4CACtB,0BAA0B;4CAC1B,+BAA+B;4CAC/B,4BAA4B;4CAC5B,yBAAyB;4CACzB,gCAAgC;4CAChC,0CAA0C;4CAC1C,gDAAgD;4CAChD,4CAA4C;yCAC/C,CAAC;wCACF,IAAI,MAAM,EAAE;4CACR,gBAAgB,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC;yCACnD;6CAAM,IAAI,CAAC,aAAa,EAAE;4CACvB,gBAAgB,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;yCACzC;wCAGK,gBAAgB,GAClB,yCAAkB,CAAC,mBAAmB,EAAE,gBAAgB,EAAE,aAAa,CAAC,CAAC;wCAC7E,IAAI,gBAAgB,EAAE;4CAClB,aAAa,GAAG,EAAE,CAAC;4CAEnB,WAAkC,EAAhB,qCAAgB,EAAhB,8BAAgB,EAAhB,IAAgB,EAAE;gDAAzB,GAAG;gDAEV,KAAK,CAAC,8BAA8B,CAAC,CAAC;gDACtC,KAAK,CAAC,GAAG,CAAC,CAAC;gDAEX,IAAI,aAAa,EAAE;oDACT,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;oDAC/C,QAAQ,GAAG,CAAC,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;wDACxC,KAAG,GAAK,CAAC,CAAC;wDACV,CAAC,CAAC,GAAG,YAAY,KAAK,IAAI,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;4DACpD,KAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAG,CAAC,CAAC;4DACtB,EAAE,CAAC,CAAC;oDACZ,KAAK,CAAC,QAAQ,CAAC,CAAC;oDAEV,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,gBAAgB,CAAC,CAAC;oDAC3D,KAAK,CAAC,KAAK,CAAC,CAAC;oDAEb,aAAa;wDAEb,SAAM,KAAK,cAAQ,GAAG,CAAC,UAAU,UAAK,QAAQ,aAAQ,GAAG,CAAC,WAAW,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,WAAM,GAAG,CAAC,aAAa,UAAO,CAAC;iDAC1H;qDAAM;oDACG,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;oDAC/C,QAAQ,GAAG,CAAC,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;wDACxC,KAAG,GAAK,CAAC,CAAC;wDACV,CAAC,CAAC,GAAG,YAAY,KAAK,IAAI,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;4DACpD,KAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAG,CAAC,CAAC;4DACtB,EAAE,CAAC,CAAC;oDACZ,KAAK,CAAC,QAAQ,CAAC,CAAC;oDAEZ,KAAK,GAAG,EAAE,CAAC;oDACX,QAAQ,GAAG,EAAE,CAAC;oDAClB,IAAI,uBAAuB,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;wDACtC,gBAAgB,GAClB,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,2BAA2B,EAAE,mBAAmB,CAAC,CAAC;wDAC3E,KAAK,CAAC,gBAAgB,CAAC,CAAC;wDACxB,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,gBAAgB,CAAC,CAAC;wDACrD,KAAK,CAAC,KAAK,CAAC,CAAC;wDAEb,QAAQ,GAAG,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,2BAA2B,EAAE,IAAI,CAAC,CAAC;wDACnE,KAAK,CAAC,QAAQ,CAAC,CAAC;qDACnB;oDAED,aAAa;wDAEb,oCAAkC,QAAQ,WAAK,KAAK,cAAQ,GAAG,CAAC,UAAU,UAAK,QAAQ,aAAQ,GAAG,CAAC,WAAW,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,WAAM,GAAG,CAAC,aAAa,UAAO,CAAC;iDACnK;6CACJ;yCACJ;qCACJ;oCAEK,IAAI,GAAG,UAAC,GAAQ;wCAClB,IAAI,CAAC,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,CAAC;4CAC1C,CAAC,GAAG,CAAC,IAAI,IAAI,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ,CAAC,EAAE;4CAE5C,IAAI,QAAQ,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,IAAc,CAAC,CAAC,CAAC,GAAG,CAAC,IAAc,CAAC;4CAElE,IAAM,SAAS,GAAG,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;4CAC1C,IAAM,SAAS,GAAG,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;4CAC5C,IAAM,OAAO,GAAG,CAAC,SAAS,IAAI,CAAC,SAAS,IAAI,CAAC,iBAAM,CAAC,QAAQ,CAAC,CAAC;4CAC9D,IAAI,OAAO,EAAE;gDACT,QAAQ,GAAG,yBAAc,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;6CACnD;4CAED,IAAI,CAAC,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;gDAC5E,CAAC,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,EAAE;gDAE9E,GAAG,CAAC,QAAQ,GAAG,OAAO,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,EAC7C,GAAG,CAAC,WAAW,CAAC,OAAO,CAAC,iCAAyB,GAAG,GAAG,CAAC,CAAC;oDACzD,iCAAyB,GAAG,GAAG,GAAG,qCAA0B,CAAC,QAAQ,CAAC,CAAC;6CAE9E;iDAAM,IAAI,CAAC,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC;gDAClE,CAAC,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC,EAAE;gDAE7D,GAAG,CAAC,QAAQ,GAAG,OAAO,GAAG,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,EAC7C,GAAG,CAAC,WAAW,CAAC,OAAO,CAAC,iCAAyB,GAAG,GAAG,CAAC,CAAC;oDACzD,+DAAgC,GAAG,GAAG,GAAG,qCAA0B,CAAC,QAAQ,CAAC,CAAC;6CAErF;iDAAM,IAAI,SAAS,EAAE;6CAMrB;iDAAM,IAAI,OAAO,IAAI,CAAC,SAAS,EAAE;gDAC9B,GAAG,CAAC,QAAQ,GAAG,QAAQ,CAAC;6CAC3B;yCACJ;oCACL,CAAC,CAAC;oCACF,+BAAmB,CAAC,aAAa,EAAE,IAAI,CAAC,CAAC;oCAEnC,GAAG,GAAG,QAAQ,CAAC,SAAS,CAAC,CAAC;oCAC5B,eAAe,GAAG,UAAU,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;oCAErD,eAAe,GAAG,eAAe,CAAC,OAAO,CAAC,uBAAuB,EAAE,2GAA2G,CAAC,CAAC;oCAEhL,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc;wCAC/B,iBAAiB;wCACjB,CAAC,aAAa,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;wCAChE,eAAe;wCACf,gBAAgB,GAAG,UAAU,GAAG,KAAK,GAAG,UAAU,GAAG,WAAW;wCAChE,MAAM;wCACN,6EAA6E;wCAC7E,eAAe,GAAG,QAAQ;wCAE1B,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,cAAc,GAAG,aAAa,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,CAAC,4BAA4B,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;wCAItH,gBAAgB,CAAC,CAAC;;;;yBACzB,CAAC;oBAEI,OAAO,GAAG;wBACZ,QAAQ,EAAE,kCAAkC;wBAC5C,iBAAiB,EAAE,4BAA4B;wBAC/C,YAAY,EAAE,UAAU;qBAC3B,CAAC;oBAII,sBAAsB,GAAG,IAAI,CAAC;yBAChC,sBAAsB,EAAtB,cAAsB;oBACtB,OAAO,CAAC,GAAG,CAAC;wBACR,OAAO,SAAA;wBACP,MAAM,EAAE,KAAK;wBACb,GAAG,EAAE,UAAU;qBAClB,CAAC;yBACG,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC;yBACvB,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;;;oBAEtB,QAAQ,SAA6B,CAAC;;;;oBAG3B,WAAM,cAAc,CAAC;4BAC5B,OAAO,SAAA;4BACP,MAAM,EAAE,KAAK;4BACb,uBAAuB,EAAE,IAAI;4BAC7B,GAAG,EAAE,UAAU;yBAClB,CAAC,EAAA;;oBALF,QAAQ,GAAG,SAKT,CAAC;;;;oBAEH,OAAO,CAAC,KAAG,CAAC,CAAC;oBACb,WAAO;wBAGX,WAAM,OAAO,CAAC,QAAQ,CAAC,EAAA;;oBAAvB,SAAuB,CAAC;;;;;SAE/B,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,CAAC,iCAAyB,EAAE,oBAAoB,CAAC,CAAC;IAG/D,IAAM,kBAAkB,GAAG,OAAO,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;IAC7D,kBAAkB,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE,UAAC,GAAQ,IAAK,OAAA,KAAK,CAAC,GAAG,CAAC,EAAV,CAAU,EAAE,EAAE,CAAC,CAAC,CAAC;IAE5F,kBAAkB,CAAC,GAAG,CAAC,sDAAqB,CAAC,CAAC;IAE9C,kBAAkB,CAAC,GAAG,CAAC,GAAG,EAAE,UAAC,IAAqB,EAAE,GAAqB;QAErE,IAAI,IAAI,GAAG,cAAc,CAAC;QAC1B,IAAI,IAAI,8EAA4E;YAChF,8DAA8D;YAC9D,oDAAkD;YAClD,oBAAoB;YACpB,+CAA+C;YAC/C,mBAAmB;aAGnB,OAAK,+BAAuB,SAAM,CAAA;YAClC,sEAAoE;YACpE,gCAAgC,CAAC;QACrC,IAAI,IAAI,SAAS,CAAC;QAElB,IAAI,IAAI,gCAAgC,CAAC;QAEzC,IAAI,IAAI,wCAAsC;YAC1C,2DAAmD;YACnD,8CAA0C,CAAC;QAE/C,IAAI,IAAI,gBAAgB,CAAC;QAEzB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC/B,CAAC,CAAC,CAAC;IAEH,kBAAkB,CAAC,KAAK,CAAC,YAAY,EAAE,UAAC,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK;QAChE,GAAgC,CAAC,UAAU,GAAG,KAAK,CAAC;QACrD,IAAI,EAAE,CAAC;IACX,CAAC,CAAC,CAAC;IAEH,kBAAkB,CAAC,GAAG,CAAC,IAAI,GAAG,yBAAW,GAAG,KAAK,EAAE,UAAO,GAAoB,EAAE,GAAqB;;;YAE3F,SAAS,GAAI,GAAgC,CAAC,MAAM,CAAC;YAE3D,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE;gBACvB,SAAS,CAAC,UAAU,GAAI,GAAgC,CAAC,UAAU,CAAC;aACvE;YAEK,UAAU,GAAG,SAAS,CAAC,UAAU,CAAC;YAIxC,KAAK,CAAC,UAAU,CAAC,CAAC;YAElB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc;gBAC/B,mBAAmB;gBACnB,gBAAgB,GAAG,UAAU,GAAG,KAAK,GAAG,UAAU,GAAG,WAAW;gBAChE,MAAM;gBACN,aAAa,GAAG,UAAU,GAAG,OAAO;gBACpC,gBAAgB,CAAC,CAAC;;;SACzB,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,CAAC,+BAAuB,EAAE,kBAAkB,CAAC,CAAC;AAC/D,CAAC;AA1XD,oDA0XC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as css2json from \"css2json\";\nimport * as debug_ from \"debug\";\nimport * as DotProp from \"dot-prop\";\nimport * as express from \"express\";\nimport * as jsonMarkup from \"json-markup\";\nimport * as morgan from \"morgan\";\nimport * as path from \"path\";\nimport * as request from \"request\";\nimport * as requestPromise from \"request-promise-native\";\n\nimport { TaJsonDeserialize, TaJsonSerialize } from \"@r2-lcp-js/serializable\";\nimport { OPDSFeed } from \"@r2-opds-js/opds/opds2/opds2\";\nimport { OPDSAuthenticationDoc } from \"@r2-opds-js/opds/opds2/opds2-authentication-doc\";\nimport { OPDSPublication } from \"@r2-opds-js/opds/opds2/opds2-publication\";\nimport {\n    encodeURIComponent_RFC3986, ensureAbsolute, isHTTP,\n} from \"@r2-utils-js/_utils/http/UrlUtils\";\nimport { traverseJsonObjects } from \"@r2-utils-js/_utils/JsonUtils\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\n\nimport { jsonSchemaValidate } from \"../utils/json-schema-validate\";\nimport { IRequestPayloadExtension, _urlEncoded } from \"./request-ext\";\nimport { Server } from \"./server\";\nimport { serverOPDS_convert_v1_to_v2_PATH } from \"./server-opds-convert-v1-to-v2\";\nimport { trailingSlashRedirect } from \"./server-trailing-slash-redirect\";\n\nconst debug = debug_(\"r2:streamer#http/server-opds-browse-v2\");\n\n// tslint:disable-next-line:variable-name\nexport const serverOPDS_browse_v2_PATH = \"/opds-v2-browse\";\n\n// tslint:disable-next-line:variable-name\nexport const serverOPDS_dataUrl_PATH = \"/data-url\";\n\nexport function serverOPDS_browse_v2(_server: Server, topRouter: express.Application) {\n\n    // https://github.com/mafintosh/json-markup/blob/master/style.css\n    const jsonStyle = `\n.json-markup {\n    line-height: 17px;\n    font-size: 13px;\n    font-family: monospace;\n    white-space: pre;\n}\n.json-markup-key {\n    font-weight: bold;\n}\n.json-markup-bool {\n    color: firebrick;\n}\n.json-markup-string {\n    color: green;\n}\n.json-markup-null {\n    color: gray;\n}\n.json-markup-number {\n    color: blue;\n}\n`;\n\n    // tslint:disable-next-line:variable-name\n    const routerOPDS_browse_v2 = express.Router({ strict: false });\n    routerOPDS_browse_v2.use(morgan(\"combined\", { stream: { write: (msg: any) => debug(msg) } }));\n\n    routerOPDS_browse_v2.use(trailingSlashRedirect);\n\n    routerOPDS_browse_v2.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n        let html = \"<html><head>\";\n        html += `<script type=\"text/javascript\">function encodeURIComponent_RFC3986(str) { ` +\n            `return encodeURIComponent(str).replace(/[!'()*]/g, (c) => { ` +\n            `return \"%\" + c.charCodeAt(0).toString(16); }); }` +\n            `function go(evt) {` +\n            `if (evt) { evt.preventDefault(); } var url = ` +\n            `location.origin +` +\n            // `location.protocol + '//' + location.hostname + ` +\n            // `(location.port ? (':' + location.port) : '') + ` +\n            ` '${serverOPDS_browse_v2_PATH}/' +` +\n            ` encodeURIComponent_RFC3986(document.getElementById(\"url\").value);` +\n            `location.href = url;}</script>`;\n        html += \"</head>\";\n\n        html += \"<body><h1>OPDS feed browser</h1>\";\n\n        html += `<form onsubmit=\"go();return false;\">` +\n            `<input type=\"text\" name=\"url\" id=\"url\" size=\"80\">` +\n            `<input type=\"submit\" value=\"Go!\"></form>`;\n\n        html += \"</body></html>\";\n\n        res.status(200).send(html);\n    });\n\n    routerOPDS_browse_v2.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n        (req as IRequestPayloadExtension).urlEncoded = value;\n        next();\n    });\n\n    routerOPDS_browse_v2.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n        const reqparams = (req as IRequestPayloadExtension).params;\n\n        if (!reqparams.urlEncoded) {\n            reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n        }\n\n        const urlDecoded = reqparams.urlEncoded;\n        // if (urlDecoded.substr(-1) === \"/\") {\n        //     urlDecoded = urlDecoded.substr(0, urlDecoded.length - 1);\n        // }\n        debug(urlDecoded);\n\n        const isSecureHttp = req.secure ||\n            req.protocol === \"https\" ||\n            req.get(\"X-Forwarded-Proto\") === \"https\"\n            // (req.headers.host && req.headers.host.indexOf(\"now.sh\") >= 0) ||\n            // (req.hostname && req.hostname.indexOf(\"now.sh\") >= 0)\n            ;\n        const rootUrl = (isSecureHttp ? \"https://\" : \"http://\")\n            + req.headers.host;\n\n        const failure = (err: any) => {\n            debug(err);\n            res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                + err + \"</p></body></html>\");\n        };\n\n        const success = async (response: request.RequestResponse) => {\n\n            // Object.keys(response.headers).forEach((header: string) => {\n            //     debug(header + \" => \" + response.headers[header]);\n            // });\n\n            if (response.statusCode && (response.statusCode < 200 || response.statusCode >= 300)) {\n                failure(\"HTTP CODE \" + response.statusCode);\n                return;\n            }\n\n            let responseData: Buffer;\n            try {\n                responseData = await streamToBufferPromise(response);\n            } catch (err) {\n                debug(err);\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                    + err + \"</p></body></html>\");\n                return;\n            }\n            const responseStr = responseData.toString(\"utf8\");\n            const responseJson = JSON.parse(responseStr);\n\n            const isPublication = !responseJson.publications &&\n                !responseJson.navigation &&\n                !responseJson.groups &&\n                !responseJson.catalogs &&\n                responseJson.metadata;\n            const isAuth = !isPublication && responseJson.authentication;\n\n            const opds2Feed: OPDSPublication | OPDSFeed | OPDSAuthenticationDoc =\n                // tslint:disable-next-line: max-line-length\n                isPublication ? TaJsonDeserialize<OPDSPublication>(responseJson, OPDSPublication) : // \"application/opds-publication+json\"\n                // tslint:disable-next-line: max-line-length\n                (isAuth ? TaJsonDeserialize<OPDSAuthenticationDoc>(responseJson, OPDSAuthenticationDoc) : // \"application/vnd.opds.authentication.v1.0+json\"\n                TaJsonDeserialize<OPDSFeed>(responseJson, OPDSFeed)); // \"application/opds+json\"\n\n            const opds2FeedJson = TaJsonSerialize(opds2Feed);\n\n            let validationStr: string | undefined;\n            const doValidate = !reqparams.jsonPath || reqparams.jsonPath === \"all\";\n            if (doValidate) {\n\n                const jsonSchemasRootpath = path.join(process.cwd(), \"misc\", \"json-schema\");\n                const jsonSchemasNames = [\n                    \"opds/publication\",\n                    \"opds/acquisition-object\",\n                    \"opds/feed-metadata\",\n                    \"opds/properties\",\n                    \"webpub-manifest/publication\",\n                    \"webpub-manifest/contributor-object\",\n                    \"webpub-manifest/contributor\",\n                    \"webpub-manifest/link\",\n                    \"webpub-manifest/metadata\",\n                    \"webpub-manifest/subcollection\",\n                    \"webpub-manifest/properties\",\n                    \"webpub-manifest/subject\",\n                    \"webpub-manifest/subject-object\",\n                    \"webpub-manifest/extensions/epub/metadata\",\n                    \"webpub-manifest/extensions/epub/subcollections\",\n                    \"webpub-manifest/extensions/epub/properties\",\n                ];\n                if (isAuth) {\n                    jsonSchemasNames.unshift(\"opds/authentication\"); // must be first!\n                } else if (!isPublication) {\n                    jsonSchemasNames.unshift(\"opds/feed\"); // must be first!\n                }\n                // debug(jsonSchemasNames);\n\n                const validationErrors =\n                    jsonSchemaValidate(jsonSchemasRootpath, jsonSchemasNames, opds2FeedJson);\n                if (validationErrors) {\n                    validationStr = \"\";\n\n                    for (const err of validationErrors) {\n\n                        debug(\"JSON Schema validation FAIL.\");\n                        debug(err);\n\n                        if (isPublication) {\n                            const val = DotProp.get(opds2FeedJson, err.jsonPath);\n                            const valueStr = (typeof val === \"string\") ?\n                                `${val}` :\n                                ((val instanceof Array || typeof val === \"object\") ?\n                                `${JSON.stringify(val)}` :\n                                    \"\");\n                            debug(valueStr);\n\n                            const title = DotProp.get(opds2FeedJson, \"metadata.title\");\n                            debug(title);\n\n                            validationStr +=\n                            // tslint:disable-next-line:max-line-length\n                            `\\n\"${title}\"\\n\\n${err.ajvMessage}: ${valueStr}\\n\\n'${err.ajvDataPath.replace(/^\\./, \"\")}' (${err.ajvSchemaPath})\\n\\n`;\n                        } else {\n                            const val = DotProp.get(opds2FeedJson, err.jsonPath);\n                            const valueStr = (typeof val === \"string\") ?\n                                `${val}` :\n                                ((val instanceof Array || typeof val === \"object\") ?\n                                `${JSON.stringify(val)}` :\n                                    \"\");\n                            debug(valueStr);\n\n                            let title = \"\";\n                            let pubIndex = \"\";\n                            if (/^publications\\.[0-9]+/.test(err.jsonPath)) {\n                                const jsonPubTitlePath =\n                                    err.jsonPath.replace(/^(publications\\.[0-9]+).*/, \"$1.metadata.title\");\n                                debug(jsonPubTitlePath);\n                                title = DotProp.get(opds2FeedJson, jsonPubTitlePath);\n                                debug(title);\n\n                                pubIndex = err.jsonPath.replace(/^publications\\.([0-9]+).*/, \"$1\");\n                                debug(pubIndex);\n                            }\n\n                            validationStr +=\n                            // tslint:disable-next-line:max-line-length\n                            `\\n___________INDEX___________ #${pubIndex} \"${title}\"\\n\\n${err.ajvMessage}: ${valueStr}\\n\\n'${err.ajvDataPath.replace(/^\\./, \"\")}' (${err.ajvSchemaPath})\\n\\n`;\n                        }\n                    }\n                }\n            }\n\n            const funk = (obj: any) => {\n                if ((obj.href && typeof obj.href === \"string\") ||\n                    (obj.Href && typeof obj.Href === \"string\")) {\n\n                    let fullHref = obj.href ? obj.href as string : obj.Href as string;\n\n                    const isDataUrl = /^data:/.test(fullHref);\n                    const isMailUrl = /^mailto:/.test(fullHref);\n                    const notFull = !isDataUrl && !isMailUrl && !isHTTP(fullHref);\n                    if (notFull) {\n                        fullHref = ensureAbsolute(urlDecoded, fullHref);\n                    }\n\n                    if ((obj.type && obj.type.indexOf(\"opds\") >= 0 && obj.type.indexOf(\"json\") >= 0) ||\n                        (obj.Type && obj.Type.indexOf(\"opds\") >= 0 && obj.Type.indexOf(\"json\") >= 0)) {\n\n                        obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                            req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                            serverOPDS_browse_v2_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                    } else if ((obj.type && obj.type.indexOf(\"application/atom+xml\") >= 0) ||\n                        (obj.Type && obj.Type.indexOf(\"application/atom+xml\") >= 0)) {\n\n                        obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                            req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                            serverOPDS_convert_v1_to_v2_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                    } else if (isDataUrl) {\n                        // obj.href = obj.href.substr(0, 100) + \"(...)\";\n                        // obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                        //     req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                        //     serverOPDS_dataUrl_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                    } else if (notFull && !isMailUrl) {\n                        obj.__href__ = fullHref;\n                    }\n                }\n            };\n            traverseJsonObjects(opds2FeedJson, funk);\n\n            const css = css2json(jsonStyle);\n            let jsonPrettyOPDS2 = jsonMarkup(opds2FeedJson, css);\n            // tslint:disable-next-line: max-line-length\n            jsonPrettyOPDS2 = jsonPrettyOPDS2.replace(/>\"data:image\\/(.*)\"</g, \"><a href=\\\"data:image/$1\\\" target=\\\"_BLANK\\\"><img style=\\\"max-width: 100px;\\\" src=\\\"data:image/$1\\\"></a><\");\n\n            res.status(200).send(\"<html><body>\" +\n                \"<h1>OPDS2 JSON \" +\n                (isPublication ? \"entry\" : (isAuth ? \"authentication\" : \"feed\")) +\n                \" (OPDS2)</h1>\" +\n                \"<h2><a href=\\\"\" + urlDecoded + \"\\\">\" + urlDecoded + \"</a></h2>\" +\n                \"<hr>\" +\n                \"<div style=\\\"overflow-x: auto;margin:0;padding:0;width:100%;height:auto;\\\">\" +\n                jsonPrettyOPDS2 + \"</div>\" +\n                // tslint:disable-next-line:max-line-length\n                (doValidate ? (validationStr ? (\"<hr><p><pre>\" + validationStr + \"</pre></p>\") : (\"<hr><p>JSON SCHEMA OK.</p>\")) : \"\") +\n                // \"<p><pre>\" + jsonPretty + \"</pre></p>\" +\n                // \"<hr><p><pre>\" + jsonStr + \"</pre></p>\" +\n                // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\n                \"</body></html>\");\n        };\n\n        const headers = {\n            \"Accept\": \"application/json,application/xml\",\n            \"Accept-Language\": \"en-UK,en-US;q=0.7,en;q=0.5\",\n            \"User-Agent\": \"READIUM2\",\n        };\n\n        // No response streaming! :(\n        // https://github.com/request/request-promise/issues/90\n        const needsStreamingResponse = true;\n        if (needsStreamingResponse) {\n            request.get({\n                headers,\n                method: \"GET\",\n                uri: urlDecoded,\n            })\n                .on(\"response\", success)\n                .on(\"error\", failure);\n        } else {\n            let response: requestPromise.FullResponse;\n            try {\n                // tslint:disable-next-line:await-promise no-floating-promises\n                response = await requestPromise({\n                    headers,\n                    method: \"GET\",\n                    resolveWithFullResponse: true,\n                    uri: urlDecoded,\n                });\n            } catch (err) {\n                failure(err);\n                return;\n            }\n\n            await success(response);\n        }\n    });\n\n    topRouter.use(serverOPDS_browse_v2_PATH, routerOPDS_browse_v2);\n\n    // tslint:disable-next-line:variable-name\n    const routerOPDS_dataUrl = express.Router({ strict: false });\n    routerOPDS_dataUrl.use(morgan(\"combined\", { stream: { write: (msg: any) => debug(msg) } }));\n\n    routerOPDS_dataUrl.use(trailingSlashRedirect);\n\n    routerOPDS_dataUrl.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n        let html = \"<html><head>\";\n        html += `<script type=\"text/javascript\">function encodeURIComponent_RFC3986(str) { ` +\n            `return encodeURIComponent(str).replace(/[!'()*]/g, (c) => { ` +\n            `return \"%\" + c.charCodeAt(0).toString(16); }); }` +\n            `function go(evt) {` +\n            `if (evt) { evt.preventDefault(); } var url = ` +\n            `location.origin +` +\n            // `location.protocol + '//' + location.hostname + ` +\n            // `(location.port ? (':' + location.port) : '') + ` +\n            ` '${serverOPDS_dataUrl_PATH}/' +` +\n            ` encodeURIComponent_RFC3986(document.getElementById(\"url\").value);` +\n            `location.href = url;}</script>`;\n        html += \"</head>\";\n\n        html += \"<body><h1>data URL viewer</h1>\";\n\n        html += `<form onsubmit=\"go();return false;\">` +\n            `<input type=\"text\" name=\"url\" id=\"url\" size=\"80\">` +\n            `<input type=\"submit\" value=\"Go!\"></form>`;\n\n        html += \"</body></html>\";\n\n        res.status(200).send(html);\n    });\n\n    routerOPDS_dataUrl.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n        (req as IRequestPayloadExtension).urlEncoded = value;\n        next();\n    });\n\n    routerOPDS_dataUrl.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n        const reqparams = (req as IRequestPayloadExtension).params;\n\n        if (!reqparams.urlEncoded) {\n            reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n        }\n\n        const urlDecoded = reqparams.urlEncoded;\n        // if (urlDecoded.substr(-1) === \"/\") {\n        //     urlDecoded = urlDecoded.substr(0, urlDecoded.length - 1);\n        // }\n        debug(urlDecoded);\n\n        res.status(200).send(\"<html><body>\" +\n            \"<h1>DATA URL</h1>\" +\n            \"<h2><a href=\\\"\" + urlDecoded + \"\\\">\" + urlDecoded + \"</a></h2>\" +\n            \"<hr>\" +\n            \"<img src=\\\"\" + urlDecoded + \"\\\" />\" +\n            \"</body></html>\");\n    });\n\n    topRouter.use(serverOPDS_dataUrl_PATH, routerOPDS_dataUrl);\n}\n"]}