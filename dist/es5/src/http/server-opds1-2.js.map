{"version":3,"file":"server-opds1-2.js","sourceRoot":"","sources":["../../../../src/http/server-opds1-2.ts"],"names":[],"mappings":"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","sourcesContent":["import { convertOpds1ToOpds2 } from \"@opds/converter\";\nimport { OPDS } from \"@opds/opds1/opds\";\nimport { OPDSFeed } from \"@opds/opds2/opds2\";\nimport { encodeURIComponent_RFC3986, ensureAbsolute, isHTTP } from \"@utils/http/UrlUtils\";\nimport { traverseJsonObjects } from \"@utils/JsonUtils\";\nimport { streamToBufferPromise } from \"@utils/stream/BufferUtils\";\nimport { XML } from \"@utils/xml-js-mapper\";\nimport * as css2json from \"css2json\";\nimport * as debug_ from \"debug\";\nimport * as express from \"express\";\nimport * as jsonMarkup from \"json-markup\";\nimport * as morgan from \"morgan\";\nimport * as request from \"request\";\nimport * as requestPromise from \"request-promise-native\";\nimport { JSON as TAJSON } from \"ta-json\";\nimport * as xmldom from \"xmldom\";\n\nimport { IRequestPayloadExtension, _urlEncoded } from \"./request-ext\";\nimport { Server } from \"./server\";\nimport { trailingSlashRedirect } from \"./server-trailing-slash-redirect\";\n\nconst debug = debug_(\"r2:streamer#http/server-opds1-2\");\n\nexport function serverOPDS12(_server: Server, topRouter: express.Application) {\n\n    // https://github.com/mafintosh/json-markup/blob/master/style.css\n    const jsonStyle = `\n.json-markup {\n    line-height: 17px;\n    font-size: 13px;\n    font-family: monospace;\n    white-space: pre;\n}\n.json-markup-key {\n    font-weight: bold;\n}\n.json-markup-bool {\n    color: firebrick;\n}\n.json-markup-string {\n    color: green;\n}\n.json-markup-null {\n    color: gray;\n}\n.json-markup-number {\n    color: blue;\n}\n`;\n\n    const routerOPDS12 = express.Router({ strict: false });\n    routerOPDS12.use(morgan(\"combined\"));\n\n    routerOPDS12.use(trailingSlashRedirect);\n\n    routerOPDS12.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n        let html = \"<html><head>\";\n        html += `<script type=\"text/javascript\">function encodeURIComponent_RFC3986(str) { ` +\n            `return encodeURIComponent(str).replace(/[!'()*]/g, (c) => { ` +\n            `return \"%\" + c.charCodeAt(0).toString(16); }); }` +\n            `function go(evt) {` +\n            `if (evt) { evt.preventDefault(); } var url = ` +\n            `location.origin +` +\n            // `location.protocol + '//' + location.hostname + ` +\n            // `(location.port ? (':' + location.port) : '') + ` +\n            ` '/opds12/' +` +\n            ` encodeURIComponent_RFC3986(document.getElementById(\"url\").value);` +\n            `location.href = url;}</script>`;\n        html += \"</head>\";\n\n        html += \"<body><h1>OPDS 1 -> 2 converter</h1>\";\n\n        html += `<form onsubmit=\"go();return false;\">` +\n            `<input type=\"text\" name=\"url\" id=\"url\" size=\"80\">` +\n            `<input type=\"submit\" value=\"Go!\"></form>`;\n\n        html += \"</body></html>\";\n\n        res.status(200).send(html);\n    });\n\n    routerOPDS12.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n        (req as IRequestPayloadExtension).urlEncoded = value;\n        next();\n    });\n\n    routerOPDS12.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n        const reqparams = req.params as IRequestPayloadExtension;\n\n        if (!reqparams.urlEncoded) {\n            reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n        }\n\n        const urlDecoded = reqparams.urlEncoded;\n        // if (urlDecoded.substr(-1) === \"/\") {\n        //     urlDecoded = urlDecoded.substr(0, urlDecoded.length - 1);\n        // }\n        debug(urlDecoded);\n\n        const isSecureHttp = req.secure ||\n            req.protocol === \"https\" ||\n            req.get(\"X-Forwarded-Proto\") === \"https\"\n            // (req.headers.host && req.headers.host.indexOf(\"now.sh\") >= 0) ||\n            // (req.hostname && req.hostname.indexOf(\"now.sh\") >= 0)\n            ;\n        const rootUrl = (isSecureHttp ? \"https://\" : \"http://\")\n            + req.headers.host;\n\n        const failure = (err: any) => {\n            debug(err);\n            res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                + err + \"</p></body></html>\");\n        };\n\n        const success = async (response: request.RequestResponse) => {\n\n            // Object.keys(response.headers).forEach((header: string) => {\n            //     debug(header + \" => \" + response.headers[header]);\n            // });\n\n            if (response.statusCode && (response.statusCode < 200 || response.statusCode >= 300)) {\n                failure(\"HTTP CODE \" + response.statusCode);\n                return;\n            }\n\n            let responseData: Buffer;\n            try {\n                responseData = await streamToBufferPromise(response);\n            } catch (err) {\n                debug(err);\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                    + err + \"</p></body></html>\");\n                return;\n            }\n            const responseStr = responseData.toString(\"utf8\");\n            const responseXml = new xmldom.DOMParser().parseFromString(responseStr);\n            // debug(responseXml);\n            const isEntry = responseXml.documentElement.localName === \"entry\";\n            let opds1: OPDS | undefined;\n            // let opdsEntry: Entry | undefined;\n            let opds2: OPDSFeed | undefined;\n            if (isEntry) {\n                // opdsEntry = XML.deserialize<Entry>(responseXml, Entry);\n\n                const err = \"OPDS Entry as top-level feed, not supported.\";\n                debug(err);\n\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                    + err + \"</p></body></html>\");\n                return;\n            } else {\n                opds1 = XML.deserialize<OPDS>(responseXml, OPDS);\n\n                try {\n                    opds2 = convertOpds1ToOpds2(opds1);\n                    // debug(opds2);\n\n                    // // breakLength: 100  maxArrayLength: undefined\n                    // console.log(util.inspect(opds2,\n                    //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\n                } catch (err) {\n                    debug(\"OPDS 1 -> 2 conversion FAILED\");\n                    debug(err);\n\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                        + err + \"</p></body></html>\");\n                    return;\n                }\n            }\n\n            const funk = (obj: any) => {\n                if ((obj.href && typeof obj.href === \"string\"\n                    && obj.type && obj.type.indexOf(\"application/atom+xml\") >= 0) ||\n                    (obj.Href && typeof obj.Href === \"string\"\n                        && obj.Type && obj.Type.indexOf(\"application/atom+xml\") >= 0)\n                ) {\n                    let fullHref = obj.href ? obj.href as string : obj.Href as string;\n                    if (!isHTTP(fullHref)) {\n                        fullHref = ensureAbsolute(urlDecoded, fullHref);\n                    }\n                    obj.__href__ = rootUrl +\n                        req.originalUrl.substr(0, req.originalUrl.indexOf(\"/opds12/\")) +\n                        \"/opds12/\" + encodeURIComponent_RFC3986(fullHref);\n                }\n            };\n\n            const jsonObjOPDS1 = TAJSON.serialize(opds1);\n            traverseJsonObjects(jsonObjOPDS1, funk);\n\n            const jsonObjOPDS2 = TAJSON.serialize(opds2);\n            traverseJsonObjects(jsonObjOPDS2, funk);\n\n            const css = css2json(jsonStyle);\n            const jsonPrettyOPDS1 = jsonMarkup(jsonObjOPDS1, css);\n            const jsonPrettyOPDS2 = jsonMarkup(jsonObjOPDS2, css);\n\n            res.status(200).send(\"<html><body>\" +\n                \"<h1>OPDS2 JSON feed (converted from OPDS1 XML/ATOM)</h1>\" +\n                \"<h2><a href=\\\"\" + urlDecoded + \"\\\">\" + urlDecoded + \"</a></h2>\" +\n                \"<hr>\" +\n                \"<table border=\\\"0\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" width=\\\"90%\\\" \" +\n                \"style=\\\"table-layout:fixed;width:90%\\\">\" +\n                \"<thead><tr><th>OPDS1</th><th>OPDS2</th></tr></thead>\" +\n                \"<tbody><tr>\" +\n                \"<td valign=\\\"top\\\" width=\\\"50%\\\">\" +\n                \"<div style=\\\"overflow-x: auto;margin:0;padding:0;width:100%;height:auto;\\\">\" +\n                jsonPrettyOPDS1 + \"</div></td>\" +\n                \"<td valign=\\\"top\\\" width=\\\"50%\\\">\" +\n                \"<div style=\\\"overflow-x: auto;margin:0;padding:0;width:100%;height:auto;\\\">\" +\n                jsonPrettyOPDS2 + \"</div></td>\" +\n                \"</tbody></tr>\" +\n                \"</table>\" +\n                // \"<p><pre>\" + jsonPretty + \"</pre></p>\" +\n                // \"<hr><p><pre>\" + jsonStr + \"</pre></p>\" +\n                // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\n                \"</body></html>\");\n        };\n\n        // No response streaming! :(\n        // https://github.com/request/request-promise/issues/90\n        const needsStreamingResponse = true;\n        if (needsStreamingResponse) {\n            request.get({\n                headers: {},\n                method: \"GET\",\n                uri: urlDecoded,\n            })\n                .on(\"response\", success)\n                .on(\"error\", failure);\n        } else {\n            let response: requestPromise.FullResponse;\n            try {\n                // tslint:disable-next-line:await-promise no-floating-promises\n                response = await requestPromise({\n                    headers: {},\n                    method: \"GET\",\n                    resolveWithFullResponse: true,\n                    uri: urlDecoded,\n                });\n            } catch (err) {\n                failure(err);\n                return;\n            }\n\n            await success(response);\n        }\n    });\n\n    topRouter.use(\"/opds12\", routerOPDS12);\n}\n"]}