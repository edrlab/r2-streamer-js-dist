{"version":3,"file":"epub.js","sourceRoot":"","sources":["../../../../src/parser/epub.ts"],"names":[],"mappings":";AAAA,iBA0vDA;;;AA1vDA,2BAA6B;AAC7B,yCAA2C;AAE3C,uDAA2E;AAC3E,6CAA4C;AAC5C,iEAAuD;AACvD,mEAAyD;AACzD,qEAA2D;AAC3D,iEAAuD;AACvD,yEAA8D;AAE9D,mEAAyD;AACzD,6DAAmD;AACnD,mDAAkD;AAClD,6DAAgD;AAChD,sDAAsD;AACtD,yDAAkE;AAClE,sDAA2C;AAE3C,oDAAuD;AACvD,8BAAgC;AAChC,mCAAqC;AACrC,+BAAiC;AACjC,mCAAyC;AACzC,+BAAiC;AACjC,6BAA+B;AAE/B,8CAA6C;AAE7C,gDAA+C;AAC/C,kCAAiC;AACjC,kCAAiC;AAEjC,kCAAiC;AACjC,gDAA2C;AAI3C,oCAAmC;AAEnC,4CAAsC;AAGtC,IAAM,KAAK,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC;AAEhC,IAAM,KAAK,GAAG,KAAK,CAAC;AACpB,IAAM,OAAO,GAAG,OAAO,CAAC;AACxB,IAAM,MAAM,GAAG,KAAK,CAAC;AAGrB,IAAM,QAAQ,GAAG,MAAM,CAAC;AACxB,IAAM,QAAQ,GAAG,MAAM,CAAC;AACxB,IAAM,cAAc,GAAG,YAAY,CAAC;AAEvB,QAAA,mBAAmB,GAAG,oBAAoB,CAAC;AAC3C,QAAA,oBAAoB,GAAG,UAAU,CAAC;AAElC,QAAA,kBAAkB,GAAG,UAAO,WAAwB,EAAE,SAAe;;;;;gBAExE,WAAW,GAAG,WAAW,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;qBACpD,WAAW,EAAX,cAAW;gBACL,GAAG,GAAG,WAAW,CAAC,KAAa,CAAC;qBAClC,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,EAA5B,cAA4B;gBACxB,SAAS,SAAkB,CAAC;;;;gBAEhB,WAAM,GAAG,CAAC,kBAAkB,CAAC,SAAS,CAAC,IAAI,CAAC,EAAA;;gBAAxD,SAAS,GAAG,SAA4C,CAAC;;;;gBAEzD,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;gBACtB,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;gBAC1B,KAAK,CAAC,KAAG,CAAC,CAAC;gBACX,WAAO;;gBAGP,OAAO,SAAQ,CAAC;;;;gBAEN,WAAM,mCAAqB,CAAC,SAAS,CAAC,MAAM,CAAC,EAAA;;gBAAvD,OAAO,GAAG,SAA6C,CAAC;gBAElD,SAAS,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;gBAClC,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACZ,SAAS,CAAC,KAAK,GAAG,SAAS,CAAC,KAAK,CAAC;oBAClC,SAAS,CAAC,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC;oBAEpC,EAAE,CAAC,CAAC,SAAS,CAAC,QAAQ;wBAClB,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC;gCACzD,CAAC,QAAQ,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;wBAClC,KAAK,CAAC,uBAAqB,SAAS,CAAC,QAAQ,YAAO,SAAS,CAAC,IAAM,CAAC,CAAC;oBAC1E,CAAC;gBACL,CAAC;;;;gBAED,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;gBACtB,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;gBAC1B,KAAK,CAAC,KAAG,CAAC,CAAC;;;;;KAI1B,CAAC;AAEF,0BAAuC,QAAgB;;;;;;;oBAGzC,WAAM,2BAAc,CAAC,QAAQ,CAAC,EAAA;;oBAApC,GAAG,GAAG,SAA8B,CAAC;;;;oBAErC,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAG/B,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;wBACpB,MAAM,KAAC,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,EAAC;oBAC5C,CAAC;oBAEK,WAAW,GAAG,IAAI,yBAAW,EAAE,CAAC;oBACtC,WAAW,CAAC,OAAO,GAAG,CAAC,0CAA0C,CAAC,CAAC;oBACnE,WAAW,CAAC,QAAQ,GAAG,IAAI,mBAAQ,EAAE,CAAC;oBACtC,WAAW,CAAC,QAAQ,CAAC,OAAO,GAAG,wBAAwB,CAAC;oBACxD,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;oBAE5D,WAAW,CAAC,aAAa,CAAC,UAAU,EAAE,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oBAE/D,WAAW,CAAC,aAAa,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;oBAC1C,WAAW,CAAC,aAAa,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;oBAGhC,WAAW,GAAG,uBAAuB,CAAC;yBACxC,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAzB,eAAyB;oBACrB,cAAc,SAAkB,CAAC;;;;oBAEhB,WAAM,GAAG,CAAC,kBAAkB,CAAC,WAAW,CAAC,EAAA;;oBAA1D,cAAc,GAAG,SAAyC,CAAC;;;;oBAE3D,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAEzB,aAAa,GAAG,cAAc,CAAC,MAAM,CAAC;oBAExC,WAAW,SAAQ,CAAC;;;;oBAEN,WAAM,mCAAqB,CAAC,aAAa,CAAC,EAAA;;oBAAxD,WAAW,GAAG,SAA0C,CAAC;;;;oBAEzD,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAGzB,OAAO,GAAG,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oBACvC,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;oBAC5C,KAAK,CAAC,QAAQ,CAAC,CAAC;oBAChB,IAAI,GAAG,cAAM,CAAC,WAAW,CAAM,QAAQ,EAAE,SAAG,CAAC,CAAC;oBAC9C,IAAI,CAAC,OAAO,GAAG,WAAW,CAAC;oBAC3B,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC;oBAC1B,IAAI,CAAC,IAAI,EAAE,CAAC;oBAMZ,WAAW,CAAC,GAAG,GAAG,IAAI,CAAC;oBAMvB,WAAW,CAAC,OAAO,CAAC,8CAA8C,EAAE,CAAC,SAAS,CAAC,EAC3E,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;;;oBAIvB,UAAU,GAAG,yBAAyB,CAAC;yBACzC,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAxB,eAAwB;oBAEpB,uBAAuB,SAAkB,CAAC;;;;oBAEhB,WAAM,GAAG,CAAC,kBAAkB,CAAC,UAAU,CAAC,EAAA;;oBAAlE,uBAAuB,GAAG,SAAwC,CAAC;;;;oBAEnE,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAEzB,sBAAsB,GAAG,uBAAuB,CAAC,MAAM,CAAC;oBAE1D,oBAAoB,SAAQ,CAAC;;;;oBAEN,WAAM,mCAAqB,CAAC,sBAAsB,CAAC,EAAA;;oBAA1E,oBAAoB,GAAG,SAAmD,CAAC;;;;oBAE3E,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAGzB,gBAAgB,GAAG,oBAAoB,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oBACzD,gBAAgB,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,gBAAgB,CAAC,CAAC;oBAElF,UAAU,GAAG,mBAAG,CAAC,WAAW,CAAa,gBAAgB,EAAE,uBAAU,CAAC,CAAC;oBACvE,UAAU,CAAC,OAAO,GAAG,UAAU,CAAC;;;oBAO9B,gBAAgB,GAAG,wBAAwB,CAAC;;;;oBAIrB,WAAM,GAAG,CAAC,kBAAkB,CAAC,gBAAgB,CAAC,EAAA;;oBAAvE,sBAAsB,GAAG,SAA8C,CAAC;;;;oBAExE,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAEzB,qBAAqB,GAAG,sBAAsB,CAAC,MAAM,CAAC;;;;oBAIlC,WAAM,mCAAqB,CAAC,qBAAqB,CAAC,EAAA;;oBAAxE,mBAAmB,GAAG,SAAkD,CAAC;;;;oBAEzE,KAAK,CAAC,KAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,KAAG,CAAC,EAAC;;oBAGzB,eAAe,GAAG,mBAAmB,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oBACvD,eAAe,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,eAAe,CAAC,CAAC;oBAO1E,SAAS,GAAG,mBAAG,CAAC,WAAW,CAAY,eAAe,EAAE,qBAAS,CAAC,CAAC;oBACzE,SAAS,CAAC,OAAO,GAAG,gBAAgB,CAAC;oBAK/B,QAAQ,GAAG,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;;;;oBAQnB,WAAM,GAAG,CAAC,kBAAkB,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAA;;oBAA3D,aAAa,GAAG,SAA2C,CAAC;;;;oBAE5D,KAAK,CAAC,MAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBAEzB,YAAY,GAAG,aAAa,CAAC,MAAM,CAAC;;;;oBAQzB,WAAM,mCAAqB,CAAC,YAAY,CAAC,EAAA;;oBAAtD,UAAU,GAAG,SAAyC,CAAC;;;;oBAEvD,KAAK,CAAC,MAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBASzB,MAAM,GAAG,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oBAUrC,MAAM,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC;oBAaxD,GAAG,GAAG,mBAAG,CAAC,WAAW,CAAM,MAAM,EAAE,SAAG,CAAC,CAAC;oBAO9C,GAAG,CAAC,OAAO,GAAG,QAAQ,CAAC,IAAI,CAAC;yBASxB,GAAG,CAAC,KAAK,CAAC,GAAG,EAAb,eAAa;oBACP,UAAU,GAAG,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAC,YAAY;wBAC9C,MAAM,CAAC,YAAY,CAAC,EAAE,KAAK,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC;oBAC7C,CAAC,CAAC,CAAC;yBACC,UAAU,EAAV,eAAU;oBACJ,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,UAAU,CAAC,IAAI,CAAC;yBACpE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;oBAQrB,aAAa,SAAkB,CAAC;;;;oBAEhB,WAAM,GAAG,CAAC,kBAAkB,CAAC,WAAW,CAAC,EAAA;;oBAAzD,aAAa,GAAG,SAAyC,CAAC;;;;oBAE1D,KAAK,CAAC,MAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBAEzB,YAAY,GAAG,aAAa,CAAC,MAAM,CAAC;oBAEtC,UAAU,SAAQ,CAAC;;;;oBAEN,WAAM,mCAAqB,CAAC,YAAY,CAAC,EAAA;;oBAAtD,UAAU,GAAG,SAAyC,CAAC;;;;oBAEvD,KAAK,CAAC,MAAG,CAAC,CAAC;oBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBAGzB,MAAM,GAAG,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;oBACrC,MAAM,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC;oBAC9D,GAAG,GAAG,mBAAG,CAAC,WAAW,CAAM,MAAM,EAAE,SAAG,CAAC,CAAC;oBACxC,GAAG,CAAC,OAAO,GAAG,WAAW,CAAC;;;oBAQlC,QAAQ,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBAErC,aAAa,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBAE1C,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;wBACf,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;4BACxB,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC;wBAC1D,CAAC;wBACD,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,MAAM,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;4BACpD,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;wBAChE,CAAC;wBACD,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,WAAW,IAAI,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;4BAC9D,WAAW,CAAC,QAAQ,CAAC,WAAW,GAAG,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;wBACnE,CAAC;wBACD,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,SAAS,IAAI,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC;4BAC1D,WAAW,CAAC,QAAQ,CAAC,SAAS,GAAG,EAAE,CAAC;4BAEpC,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,OAAO,CAAC,UAAC,GAAG;gCAC/B,IAAM,OAAO,GAAG,IAAI,kCAAW,EAAE,CAAC;gCAClC,OAAO,CAAC,IAAI,GAAG,GAAG,CAAC;gCACnB,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;4BACjD,CAAC,CAAC,CAAC;wBACP,CAAC;wBACD,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,MAAM,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;4BACpD,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;wBACzD,CAAC;wBAED,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,WAAW,IAAI,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;4BAC9D,GAAG,CAAC,QAAQ,CAAC,WAAW,CAAC,OAAO,CAAC,UAAC,IAAI;gCAClC,cAAc,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;4BAChE,CAAC,CAAC,CAAC;wBACP,CAAC;wBACD,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,OAAO,IAAI,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;4BACtD,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,UAAC,IAAI;gCAC9B,cAAc,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;4BAC5D,CAAC,CAAC,CAAC;wBACP,CAAC;wBAED,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;4BACd,kBAA6B,EAAE,CAAC;4BAChC,kBAA6B,EAAE,CAAC;4BAChC,qBAAgC,EAAE,CAAC;4BACnC,6BAAwC,EAAE,CAAC;4BAEjD,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,OAAO;gCAC9B,EAAE,CAAC,CAAC,OAAO,CAAC,QAAQ,KAAK,gBAAgB,CAAC,CAAC,CAAC;oCACxC,eAAa,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gCAChC,CAAC;gCACD,EAAE,CAAC,CAAC,OAAO,CAAC,QAAQ,KAAK,gBAAgB,CAAC,CAAC,CAAC;oCACxC,eAAa,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gCAChC,CAAC;gCACD,EAAE,CAAC,CAAC,OAAO,CAAC,QAAQ,KAAK,oBAAoB,CAAC,CAAC,CAAC;oCAC5C,kBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gCACnC,CAAC;gCACD,EAAE,CAAC,CAAC,OAAO,CAAC,QAAQ,KAAK,6BAA6B,CAAC,CAAC,CAAC;oCACrD,0BAAwB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gCAC3C,CAAC;4BACL,CAAC,CAAC,CAAC;4BAEH,EAAE,CAAC,CAAC,eAAa,CAAC,MAAM,CAAC,CAAC,CAAC;gCACvB,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,gCAAgB,CAAC,eAAa,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;4BAC5E,CAAC;4BACD,EAAE,CAAC,CAAC,eAAa,CAAC,MAAM,CAAC,CAAC,CAAC;gCACvB,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oCACjC,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;gCACvC,CAAC;gCACD,eAAa,CAAC,OAAO,CAAC,UAAC,YAAY;oCAC/B,IAAM,IAAI,GAAG,IAAI,kCAAW,EAAE,CAAC;oCAC/B,IAAI,CAAC,IAAI,GAAG,YAAY,CAAC,IAAI,CAAC;oCAC9B,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gCAC7C,CAAC,CAAC,CAAC;4BACP,CAAC;4BACD,EAAE,CAAC,CAAC,kBAAgB,CAAC,MAAM,CAAC,CAAC,CAAC;gCAC1B,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC;oCACrC,WAAW,CAAC,QAAQ,CAAC,YAAY,GAAG,IAAI,qCAAY,EAAE,CAAC;gCAC3D,CAAC;gCACD,WAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,WAAW,GAAG,kBAAgB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;4BAC7E,CAAC;4BACD,EAAE,CAAC,CAAC,0BAAwB,CAAC,MAAM,CAAC,CAAC,CAAC;gCAClC,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC;oCACrC,WAAW,CAAC,QAAQ,CAAC,YAAY,GAAG,IAAI,qCAAY,EAAE,CAAC;gCAC3D,CAAC;gCACD,WAAW,CAAC,QAAQ,CAAC,YAAY,CAAC,mBAAmB,GAAG,0BAAwB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;4BAC7F,CAAC;wBACL,CAAC;oBACL,CAAC;oBAED,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,eAAe,CAAC,CAAC,CAAC;wBACzC,WAAW,CAAC,QAAQ,CAAC,SAAS,GAAG,GAAG,CAAC,KAAK,CAAC,eAAe,CAAC;oBAC/D,CAAC;oBAKD,EAAE,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;wBAC/B,qBAAqB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBACtD,CAAC;oBACD,WAAM,oBAAoB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,EAAA;;oBAAtD,SAAsD,CAAC;oBAEvD,YAAY,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBAEzC,WAAM,WAAW,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,EAAA;;oBAA7C,SAA6C,CAAC;oBAE9C,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;wBACb,kBAAkB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,UAAU,EAAE,IAAI,CAAC,CAAC;oBACrE,CAAC;oBAED,WAAM,iBAAiB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,CAAC,EAAA;;oBAAxD,SAAwD,CAAC;oBAEzD,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;wBAC9C,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;4BACN,cAAc,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,CAAC,CAAC;4BAChD,mBAAmB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,CAAC,CAAC;wBACzD,CAAC;wBACD,sBAAsB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBACvD,CAAC;oBAED,oBAAoB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBACjD,WAAW,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBAExC,mBAAmB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;oBAEhD,WAAM,gBAAgB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,CAAC,EAAA;;oBAAvD,SAAuD,CAAC;oBAExD,WAAO,WAAW,EAAC;;;;CACtB;AAlXD,4CAkXC;AAOD,6BAA0C,WAAwB;;;;;;oBACxD,GAAG,GAAuB,EAAE,CAAC;yBAE/B,WAAW,CAAC,KAAK,EAAjB,cAAiB;0BACmB,EAAjB,KAAA,WAAW,CAAC,KAAK;;;yBAAjB,CAAA,cAAiB,CAAA;oBAAzB,IAAI;yBAEP,IAAI,CAAC,aAAa,EAAlB,cAAkB;0BACiB,EAAlB,KAAA,IAAI,CAAC,aAAa;;;yBAAlB,CAAA,cAAkB,CAAA;oBAAxB,EAAE;;;;oBAGL,WAAM,qBAAqB,CAAC,WAAW,EAAE,EAAE,CAAC,EAAA;;oBAA5C,SAA4C,CAAC;;;;oBAE7C,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBAE/B,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;;;oBAPA,IAAkB,CAAA;;;oBAHxB,IAAiB,CAAA;;wBAkBxC,WAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,EAAC;;;;CAC/B;AAvBD,kDAuBC;AAED,yBAAsC,WAAwB,EAAE,SAAiB;;;;;;oBACvE,GAAG,GAAuB,EAAE,CAAC;yBAE/B,WAAW,CAAC,KAAK,EAAjB,cAAiB;0BACmB,EAAjB,KAAA,WAAW,CAAC,KAAK;;;yBAAjB,CAAA,cAAiB,CAAA;oBAAzB,IAAI;yBAEP,CAAA,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,CAAA,EAAvD,cAAuD;0BACpB,EAAlB,KAAA,IAAI,CAAC,aAAa;;;yBAAlB,CAAA,cAAkB,CAAA;oBAAxB,EAAE;;;;oBAGL,WAAM,qBAAqB,CAAC,WAAW,EAAE,EAAE,CAAC,EAAA;;oBAA5C,SAA4C,CAAC;;;;oBAE7C,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;oBAE/B,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;;;oBAPA,IAAkB,CAAA;;;oBAHxB,IAAiB,CAAA;;wBAkBxC,WAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,EAAC;;;;CAC/B;AAvBD,0CAuBC;AAED,IAAM,qBAAqB,GACvB,UAAO,WAAwB,EAAE,EAAoB;;;;;gBAErD,EAAE,CAAC,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC;oBACjB,MAAM,KAAC;gBACX,CAAC;gBAGD,EAAE,CAAC,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC;oBAElB,iBAAe,EAAE,CAAC,aAAa,CAAC;oBAEtC,EAAE,CAAC,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC;wBACxB,IAAI,GAAG,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,UAAC,CAAC;4BAChC,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,cAAY,CAAC,CAAC,CAAC;gCAC1B,MAAM,CAAC,IAAI,CAAC;4BAChB,CAAC;4BACD,MAAM,CAAC,KAAK,CAAC;wBACjB,CAAC,CAAC,CAAC;oBACP,CAAC;oBACD,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;wBACR,EAAE,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC;4BACpB,IAAI,GAAG,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,CAAC;gCAC5B,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,cAAY,CAAC,CAAC,CAAC;oCAC1B,MAAM,CAAC,IAAI,CAAC;gCAChB,CAAC;gCACD,MAAM,CAAC,KAAK,CAAC;4BACjB,CAAC,CAAC,CAAC;wBACP,CAAC;oBACL,CAAC;oBACD,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;wBACF,GAAG,GAAG,qDAAqD,GAAG,cAAY,CAAC;wBACjF,KAAK,CAAC,GAAG,CAAC,CAAC;wBACX,MAAM,KAAC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,EAAC;oBAC/B,CAAC;gBACL,CAAC;gBAEK,WAAW,GAAG,WAAW,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;gBACxD,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;oBACf,MAAM,KAAC;gBACX,CAAC;gBACK,GAAG,GAAG,WAAW,CAAC,KAAa,CAAC;;;;gBAIjB,WAAM,GAAG,CAAC,kBAAkB,CAAC,EAAE,CAAC,aAAa,CAAC,EAAA;;gBAA/D,cAAc,GAAG,SAA8C,CAAC;;;;gBAEhE,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;qBAG3B,CAAA,IAAI,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,SAAS,CAAA,EAApD,cAAoD;gBAChD,WAAW,GAAG,KAAK,CAAC;gBACpB,iBAAiB,SAAkB,CAAC;;;;gBAEhB,WAAM,0BAAY,CAAC,SAAS,CAC5C,WAAW,EAAE,IAAI,EACjB,cAAc,EACd,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC,EAAA;;gBAHhB,iBAAiB,GAAG,SAGJ,CAAC;;;;gBAEjB,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;gBAE/B,EAAE,CAAC,CAAC,iBAAiB,CAAC,CAAC,CAAC;oBACpB,cAAc,GAAG,iBAAiB,CAAC;gBACvC,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACJ,WAAW,GAAG,IAAI,CAAC;gBACvB,CAAC;gBAED,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;oBACR,GAAG,GAAG,kCAAkC,CAAC;oBAC/C,KAAK,CAAC,GAAG,CAAC,CAAC;oBACX,MAAM,KAAC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,EAAC;gBAC/B,CAAC;;;gBAGC,aAAa,GAAG,cAAc,CAAC,MAAM,CAAC;;;;gBAI1B,WAAM,mCAAqB,CAAC,aAAa,CAAC,EAAA;;gBAAxD,WAAW,GAAG,SAA0C,CAAC;;;;gBAEzD,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;gBAGzB,OAAO,GAAG,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBACvC,UAAU,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;gBAC7D,IAAI,GAAG,mBAAG,CAAC,WAAW,CAAO,UAAU,EAAE,WAAI,CAAC,CAAC;gBACrD,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC,aAAa,CAAC;gBAEhC,EAAE,CAAC,WAAW,GAAG,IAAI,CAAC;gBACtB,KAAK,CAAC,eAAe,GAAG,EAAE,CAAC,aAAa,CAAC,CAAC;gBAM1C,EAAE,CAAC,IAAI,GAAG,EAAE,CAAC;gBACb,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBAExB,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;oBACZ,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;wBACrB,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,UAAC,IAAI;4BAC9C,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;gCACf,MAAM,CAAC;4BACX,CAAC;4BACD,EAAE,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;gCAC5B,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;4BACvB,CAAC;wBACL,CAAC,CAAC,CAAC;oBACP,CAAC;oBACD,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;wBACd,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC;6BACnE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;wBACzB,EAAE,CAAC,IAAI,GAAG,OAAO,CAAC;oBAEtB,CAAC;oBACD,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;wBAClD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAC,QAAQ;4BAChC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC;gCACf,EAAE,CAAC,QAAQ,GAAG,EAAE,CAAC;4BACrB,CAAC;4BACD,oBAAoB,CAAC,IAAI,EAAE,WAAW,EAAE,EAAE,EAAE,EAAE,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;wBACvE,CAAC,CAAC,CAAC;oBACP,CAAC;gBACL,CAAC;gBAED,WAAO;;;KACV,CAAC;AAEF,IAAM,gBAAgB,GAClB,UAAO,WAAwB,EAAE,QAAkB,EAAE,GAAQ,EAAE,GAAS;;;QAEpE,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC;YACzB,MAAM,KAAC;QACX,CAAC;4BAIU,IAAI;YACX,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,KAAK,sBAAsB,CAAC,CAAC,CAAC;;YAE/C,CAAC;YAED,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;;YAE/B,CAAC;YAED,IAAM,oBAAoB,GAAe,EAAE,CAAC;YAC5C,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAC,mBAAmB;gBACrC,EAAE,CAAC,CAAC,mBAAmB,CAAC,YAAY,CAAC,CAAC,CAAC;oBACnC,IAAM,WAAW,GAAG,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAC,EAAE;wBACrC,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,KAAK,mBAAmB,CAAC,YAAY,CAAC,CAAC,CAAC;4BAC7C,MAAM,CAAC,IAAI,CAAC;wBAChB,CAAC;wBACD,MAAM,CAAC,KAAK,CAAC;oBACjB,CAAC,CAAC,CAAC;oBACH,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;wBACd,IAAM,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,WAAW,CAAC,IAAI,CAAC;6BACvE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;wBACzB,EAAE,CAAC,CAAC,aAAa,KAAK,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;4BAC9B,oBAAoB,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;wBACnD,CAAC;oBACL,CAAC;gBACL,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,IAAM,EAAE,GAAG,IAAI,gCAAgB,EAAE,CAAC;YAClC,EAAE,CAAC,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC;YAC7B,EAAE,CAAC,WAAW,GAAG,KAAK,CAAC;YAEvB,oBAAoB,CAAC,OAAO,CAAC,UAAC,mBAAmB;gBAE7C,IAAM,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,mBAAmB,CAAC,IAAI,CAAC;qBAC/E,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;gBAEzB,IAAM,IAAI,GAAG,cAAc,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,aAAa,CAAC,CAAC;gBACvE,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;oBACP,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC;wBACtB,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;oBAC5B,CAAC;oBAED,IAAM,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,UAAC,GAAG;wBAC9C,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC;4BAClC,MAAM,CAAC,IAAI,CAAC;wBAChB,CAAC;wBACD,MAAM,CAAC,KAAK,CAAC;oBACjB,CAAC,CAAC,CAAC;oBACH,EAAE,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;wBACjB,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;oBAChC,CAAC;oBAED,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;wBACnB,IAAI,CAAC,UAAU,GAAG,IAAI,gCAAU,EAAE,CAAC;oBACvC,CAAC;oBACD,IAAI,CAAC,UAAU,CAAC,YAAY,GAAG,2BAAmB,GAAG,GAAG;wBACpD,4BAAoB,GAAG,GAAG,GAAG,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACnE,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,CAAC,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC;gBAC/C,KAAK,CAAC,gCAAgC,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC;;YAExD,CAAC;QAGL,CAAC;QAnED,GAAG,CAAC,OAAoC,EAArB,KAAA,WAAW,CAAC,SAAS,EAArB,cAAqB,EAArB,IAAqB;YAA7B,IAAI;oBAAJ,IAAI;SAmEd;QAED,WAAO;;KACV,CAAC;AAEN,IAAM,oBAAoB,GAAG,UACzB,IAAU,EAAE,WAAwB,EACpC,MAAwB,EAAE,EAAsB,EAAE,QAAkB;IAEpE,IAAM,GAAG,GAAG,IAAI,gCAAgB,EAAE,CAAC;IACnC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC,WAAW,CAAC;IACrC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAEb,EAAE,CAAC,CAAC,QAAQ,YAAY,cAAG,CAAC,CAAC,CAAC;QAC1B,GAAG,CAAC,IAAI,GAAG,EAAE,CAAC;QACd,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAEzB,IAAM,GAAG,GAAG,QAAe,CAAC;QAE5B,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;YACf,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,UAAC,IAAI;gBACxC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;oBACf,MAAM,CAAC;gBACX,CAAC;gBACD,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;oBAC7B,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACxB,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;QAED,EAAE,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;YACd,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,OAAO,CAAC;iBAC7D,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YACzB,GAAG,CAAC,IAAI,GAAG,OAAO,CAAC;QACvB,CAAC;QAED,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;YACtC,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAC,KAAK;gBACvB,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;oBAChB,GAAG,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACtB,CAAC;gBACD,oBAAoB,CAAC,IAAI,EAAE,WAAW,EAAE,MAAM,EAAE,GAAG,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;YACzE,CAAC,CAAC,CAAC;QACP,CAAC;IACL,CAAC;IAAC,IAAI,CAAC,CAAC;QACJ,IAAM,GAAG,GAAG,QAAe,CAAC;QAE5B,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;YACf,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,UAAC,IAAI;gBACxC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;oBACf,MAAM,CAAC;gBACX,CAAC;gBACD,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;oBACZ,GAAG,CAAC,IAAI,GAAG,EAAE,CAAC;gBAClB,CAAC;gBACD,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;oBAC7B,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBACxB,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;QAED,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;YAC3B,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC;iBAC9D,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YACzB,GAAG,CAAC,IAAI,GAAG,OAAO,CAAC;QACvB,CAAC;QACD,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YAC7B,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC;iBAC/D,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YACzB,GAAG,CAAC,KAAK,GAAG,OAAO,CAAC;YACpB,GAAG,CAAC,KAAK,IAAI,KAAK,CAAC;YACnB,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,gCAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;YAC/E,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;gBACpB,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC;gBACjB,GAAG,CAAC,KAAK,IAAI,gCAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YACrD,CAAC;QACL,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,mBAAmB,GAAG,UAAC,WAAwB,EAAE,QAAkB,EAAE,GAAQ;IAE/E,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QAEhE,EAAE,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;YACpF,WAAW,CAAC,QAAQ,CAAC,eAAe,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,CAAC;YAClF,MAAM,CAAC;QACX,CAAC;QAED,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,IAAI;YAC3B,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;gBACpE,WAAW,CAAC,QAAQ,CAAC,eAAe,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,CAAC;YACtE,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,qBAAqB,GAAG,UAAC,WAAwB,EAAE,QAAkB,EAAE,GAAQ;IAEjF,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;QACpC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,IAAI;YAC3B,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,KAAK,iBAAiB,IAAI,IAAI,CAAC,QAAQ,KAAK,qBAAqB,CAAC,CAAC,CAAC;gBACjF,IAAM,IAAI,GAAG,IAAI,mBAAM,EAAE,CAAC;gBAC1B,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;gBACtB,IAAI,CAAC,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC;gBAClB,cAAc,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;YAChE,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,cAAc,GAAG,UACnB,WAAwB,EAAE,QAAkB,EAAE,GAAQ,EAAE,IAAY,EAAE,UAA8B;IAEpG,IAAM,WAAW,GAAG,IAAI,kCAAW,EAAE,CAAC;IACtC,IAAI,IAAwB,CAAC;IAI7B,EAAE,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;QAE/B,IAAM,IAAI,GAAG,2BAA2B,CAAC,QAAQ,EAAE,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;QACzE,EAAE,CAAC,CAAC,IAAI,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,CAAC,CAAC,CAAC;YACnC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACrB,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,UAAU,CAAC,CAAC,CAAC;YACtB,IAAI,GAAG,UAAU,CAAC;QACtB,CAAC;QAED,IAAM,OAAO,GAAG,8BAA8B,CAAC,QAAQ,EAAE,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,kBAAkB,CAAC,CAAC;QAC3F,EAAE,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;YAC5B,WAAW,CAAC,IAAI,GAAG,EAAgB,CAAC;YAEpC,EAAE,CAAC,CAAC,WAAW,CAAC,QAAQ;gBACpB,WAAW,CAAC,QAAQ,CAAC,QAAQ;gBAC7B,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;gBAEvC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC;YACjF,CAAC;YAED,OAAO,CAAC,OAAO,CAAC,UAAC,CAAC;gBACd,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;oBACR,WAAW,CAAC,IAAmB,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACtD,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,WAAW,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACjC,CAAC;IACL,CAAC;IAAC,IAAI,CAAC,CAAC;QACJ,WAAW,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QAC7B,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACjB,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,UAAU,CAAC,CAAC,CAAC;YACtB,IAAI,GAAG,UAAU,CAAC;QACtB,CAAC;IACL,CAAC;IAED,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;QACP,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;YACX,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;oBAC/B,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,EAAE,CAAC;gBACrC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAC9C,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC;oBACnC,WAAW,CAAC,QAAQ,CAAC,UAAU,GAAG,EAAE,CAAC;gBACzC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAClD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;oBAC/B,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,EAAE,CAAC;gBACrC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAC9C,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;oBAC/B,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,EAAE,CAAC;gBACrC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAC9C,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC;oBACpC,WAAW,CAAC,QAAQ,CAAC,WAAW,GAAG,EAAE,CAAC;gBAC1C,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBACnD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACjC,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACvC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAChD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACjC,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACvC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAChD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACjC,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACvC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAChD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;oBAC9B,WAAW,CAAC,QAAQ,CAAC,KAAK,GAAG,EAAE,CAAC;gBACpC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAC7C,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACjC,WAAW,CAAC,QAAQ,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACvC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAChD,KAAK,CAAC;YACV,CAAC;YACD,KAAK,KAAK,EAAE,CAAC;gBACT,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;oBAClC,WAAW,CAAC,QAAQ,CAAC,SAAS,GAAG,EAAE,CAAC;gBACxC,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBACjD,KAAK,CAAC;YACV,CAAC;YACD,SAAS,CAAC;gBACN,WAAW,CAAC,IAAI,GAAG,IAAI,CAAC;gBAExB,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC;oBACpC,WAAW,CAAC,QAAQ,CAAC,WAAW,GAAG,EAAE,CAAC;gBAC1C,CAAC;gBACD,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YACvD,CAAC;QACL,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,aAAa,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,GAAQ;IAC1E,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC;QAC1C,EAAE,CAAC,CAAC,GAAG,CAAC,gBAAgB,IAAI,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;YAC7D,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,OAAO,CAAC,UAAC,IAAI;gBACjC,EAAE,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,GAAG,CAAC,gBAAgB,CAAC,CAAC,CAAC;oBACnC,WAAW,CAAC,QAAQ,CAAC,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC;gBAChD,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;YAC5C,WAAW,CAAC,QAAQ,CAAC,UAAU,GAAG,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QACtE,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,QAAQ,GAAG,UAAC,WAAwB,EAAE,QAAkB,EAAE,GAAQ;IAEpE,EAAE,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;QAC/B,IAAI,SAAS,SAAmB,CAAC;QAEjC,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ;YACZ,GAAG,CAAC,QAAQ,CAAC,KAAK;YAClB,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;YAE5B,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;gBACpB,IAAM,EAAE,GAAG,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAK;oBACrC,IAAM,QAAQ,GAAG,GAAG,GAAG,KAAK,CAAC,EAAE,CAAC;oBAEhC,IAAM,CAAC,GAAG,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,UAAC,IAAI;wBAClC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,MAAM,IAAI,IAAI,CAAC,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC;4BACnD,MAAM,CAAC,IAAI,CAAC;wBAChB,CAAC;wBACD,MAAM,CAAC,KAAK,CAAC;oBACjB,CAAC,CAAC,CAAC;oBACH,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;wBACJ,MAAM,CAAC,IAAI,CAAC;oBAChB,CAAC;oBACD,MAAM,CAAC,KAAK,CAAC;gBACjB,CAAC,CAAC,CAAC;gBACH,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBACL,SAAS,GAAG,EAAE,CAAC;gBACnB,CAAC;YACL,CAAC;YAED,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;gBACb,SAAS,GAAG,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YACtC,CAAC;QACL,CAAC;QAED,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;YACZ,IAAM,OAAO,GAAG,8BAA8B,CAAC,QAAQ,EAAE,GAAG,EAAE,SAAS,CAAC,EAAE,EAAE,kBAAkB,CAAC,CAAC;YAChG,EAAE,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;gBAC5B,WAAW,CAAC,QAAQ,CAAC,KAAK,GAAG,EAAgB,CAAC;gBAE9C,EAAE,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC;oBACjB,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,GAAG,SAAS,CAAC,IAAI,CAAC;gBAC9E,CAAC;gBAED,OAAO,CAAC,OAAO,CAAC,UAAC,CAAC;oBACd,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;wBACR,WAAW,CAAC,QAAQ,CAAC,KAAoB,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;oBAC9E,CAAC;gBACL,CAAC,CAAC,CAAC;YACP,CAAC;YAAC,IAAI,CAAC,CAAC;gBACJ,WAAW,CAAC,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,IAAI,CAAC;YAChD,CAAC;QACL,CAAC;IAEL,CAAC;IAAC,IAAI,CAAC,CAAC;QACJ,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ;YACZ,GAAG,CAAC,QAAQ,CAAC,KAAK;YAClB,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;YAE5B,WAAW,CAAC,QAAQ,CAAC,KAAK,GAAG,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QAC5D,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,yBAAyB,GAC3B,UAAO,WAAwB,EAAE,IAAU,EAAE,QAAkB,EAAE,QAAkB,EAAE,GAAQ;;;;;qBAErF,QAAQ,CAAC,UAAU,EAAnB,cAAmB;gBACnB,WAAM,uBAAuB,CAAC,WAAW,EAAE,IAAI,EAAE,QAAQ,CAAC,UAAU,CAAC,EAAA;;gBAArE,SAAqE,CAAC;;;gBAEpE,eAAe,GAAG,gCAAgC,CAAC,QAAQ,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;qBAC9E,eAAe,EAAf,cAAe;gBACf,WAAM,uBAAuB,CAAC,WAAW,EAAE,IAAI,EAAE,eAAe,CAAC,EAAA;;gBAAjE,SAAiE,CAAC;;;;;KAEzE,CAAC;AAEN,IAAM,uBAAuB,GAAG,UAAO,WAAwB,EAAE,IAAU,EAAE,gBAAwB;;;;;gBAE3F,UAAU,GAAG,gBAAgB,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAEhD,gBAAgB,GAAG,IAAI,gCAAU,EAAE,CAAC;sBAMhB,EAAV,yBAAU;;;qBAAV,CAAA,wBAAU,CAAA;gBAAf,CAAC;gBACA,KAAA,CAAC,CAAA;;yBACA,aAAa,EAAb,MAAM,QAAO;yBAKb,KAAK,EAAL,MAAM,QAAD;yBAIL,UAAU,EAAV,MAAM,QAAI;yBAOV,QAAQ,EAAR,MAAM,QAAE;yBAOR,aAAa,EAAb,MAAM,QAAO;yBAOb,KAAK,EAAL,MAAM,QAAD;yBAOL,YAAY,EAAZ,MAAM,QAAM;yBAOZ,kBAAkB,EAAlB,MAAM,SAAY;yBAOlB,kBAAkB,EAAlB,MAAM,SAAY;yBAIlB,mBAAmB,EAAnB,MAAM,SAAa;yBAInB,oBAAoB,EAApB,MAAM,SAAc;yBAIpB,uBAAuB,EAAvB,MAAM,SAAiB;yBAIvB,uBAAuB,EAAvB,MAAM,SAAiB;yBAIvB,4BAA4B,EAA5B,MAAM,SAAsB;yBAI5B,2BAA2B,EAA3B,MAAM,SAAqB;yBAI3B,uBAAuB,EAAvB,MAAM,SAAiB;yBAIvB,6BAA6B,EAA7B,MAAM,SAAuB;yBAI7B,gCAAgC,EAAhC,MAAM,SAA0B;yBAIhC,4BAA4B,EAA5B,MAAM,SAAsB;yBAI5B,iCAAiC,EAAjC,MAAM,SAA2B;yBAIjC,gCAAgC,EAAhC,MAAM,SAA0B;yBAIhC,qBAAqB,EAArB,MAAM,SAAe;yBAIrB,0BAA0B,EAA1B,MAAM,SAAoB;yBAI1B,oCAAoC,EAApC,MAAM,SAA8B;yBAIpC,6BAA6B,EAA7B,MAAM,SAAuB;;;;gBAlH9B,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;gBACrB,WAAM,0BAAkB,CAAC,WAAW,EAAE,IAAI,CAAC,EAAA;;gBAA3C,SAA2C,CAAC;gBAC5C,eAAM;;gBAEE,CAAC;oBACT,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;oBACxB,MAAM,SAAA;gBACV,CAAC;;;gBACgB,CAAC;oBACd,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;oBACrC,MAAM,SAAA;gBACV,CAAC;;;gBACc,CAAC;oBACZ,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBACzC,MAAM,SAAA;gBACV,CAAC;;;gBACmB,CAAC;oBACjB,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;oBACvC,MAAM,SAAA;gBACV,CAAC;;;gBACW,CAAC;oBACT,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBACtC,MAAM,SAAA;gBACV,CAAC;;;gBACkB,CAAC;oBAChB,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBACtC,MAAM,SAAA;gBACV,CAAC;;;gBACwB,CAAC;oBACtB,EAAE,CAAC,CAAC,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC7B,gBAAgB,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACnC,CAAC;oBACD,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;oBACnD,MAAM,SAAA;gBACV,CAAC;;;gBACwB,CAAC;oBACtB,gBAAgB,CAAC,IAAI,GAAG,MAAM,CAAC;oBAC/B,MAAM,SAAA;gBACV,CAAC;;;gBACyB,CAAC;oBACvB,gBAAgB,CAAC,IAAI,GAAG,OAAO,CAAC;oBAChC,MAAM,SAAA;gBACV,CAAC;;;gBAC0B,CAAC;oBACxB,gBAAgB,CAAC,IAAI,GAAG,QAAQ,CAAC;oBACjC,MAAM,SAAA;gBACV,CAAC;;;gBAC6B,CAAC;oBAC3B,gBAAgB,CAAC,MAAM,GAAG,QAAQ,CAAC;oBACnC,MAAM,SAAA;gBACV,CAAC;;;gBAC6B,CAAC;oBAC3B,gBAAgB,CAAC,MAAM,GAAG,QAAQ,CAAC;oBACnC,MAAM,SAAA;gBACV,CAAC;;;gBACkC,CAAC;oBAChC,gBAAgB,CAAC,MAAM,GAAG,WAAW,CAAC;oBACtC,MAAM,SAAA;gBACV,CAAC;;;gBACiC,CAAC;oBAC/B,gBAAgB,CAAC,MAAM,GAAG,UAAU,CAAC;oBACrC,MAAM,SAAA;gBACV,CAAC;;;gBAC6B,CAAC;oBAC3B,gBAAgB,CAAC,MAAM,GAAG,MAAM,CAAC;oBACjC,MAAM,SAAA;gBACV,CAAC;;;gBACmC,CAAC;oBACjC,gBAAgB,CAAC,MAAM,GAAG,cAAc,CAAC;oBACzC,MAAM,SAAA;gBACV,CAAC;;;gBACsC,CAAC;oBACpC,gBAAgB,CAAC,MAAM,GAAG,OAAO,CAAC;oBAClC,MAAM,SAAA;gBACV,CAAC;;;gBACkC,CAAC;oBAChC,gBAAgB,CAAC,WAAW,GAAG,MAAM,CAAC;oBACtC,MAAM,SAAA;gBACV,CAAC;;;gBACuC,CAAC;oBACrC,gBAAgB,CAAC,WAAW,GAAG,WAAW,CAAC;oBAC3C,MAAM,SAAA;gBACV,CAAC;;;gBACsC,CAAC;oBACpC,gBAAgB,CAAC,WAAW,GAAG,UAAU,CAAC;oBAC1C,MAAM,SAAA;gBACV,CAAC;;;gBAC2B,CAAC;oBACzB,gBAAgB,CAAC,QAAQ,GAAG,QAAQ,CAAC;oBACrC,MAAM,SAAA;gBACV,CAAC;;;gBACgC,CAAC;oBAC9B,gBAAgB,CAAC,QAAQ,GAAG,WAAW,CAAC;oBACxC,MAAM,SAAA;gBACV,CAAC;;;gBAC0C,CAAC;oBACxC,gBAAgB,CAAC,QAAQ,GAAG,qBAAqB,CAAC;oBAClD,MAAM,SAAA;gBACV,CAAC;;;gBACmC,CAAC;oBACjC,gBAAgB,CAAC,QAAQ,GAAG,UAAU,CAAC;oBACvC,MAAM,SAAA;gBACV,CAAC;;;gBACQ,CAAC;oBACN,MAAM,SAAA;gBACV,CAAC;;;gBAGL,EAAE,CAAC,CAAC,gBAAgB,CAAC,MAAM;oBACvB,gBAAgB,CAAC,WAAW;oBAC5B,gBAAgB,CAAC,QAAQ;oBACzB,gBAAgB,CAAC,IAAI;oBACrB,gBAAgB,CAAC,MAAM;oBACvB,CAAC,gBAAgB,CAAC,QAAQ,IAAI,gBAAgB,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;oBAElE,IAAI,CAAC,UAAU,GAAG,gBAAgB,CAAC;gBACvC,CAAC;;;gBAtIW,IAAU,CAAA;;;;;KAwI7B,CAAC;AAEF,IAAM,eAAe,GAAG,UAAC,IAAU,EAAE,QAAkB,EAAE,QAAkB,EAAE,GAAQ;IACjF,EAAE,CAAC,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC;QACxB,IAAM,IAAI,GAAG,2BAA2B,CAAC,QAAQ,EAAE,GAAG,EAAE,QAAQ,CAAC,YAAY,EAAE,gBAAgB,CAAC,CAAC;QACjG,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;YACP,IAAI,CAAC,QAAQ,GAAG,gCAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAChD,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,kBAAkB,GACpB,UAAO,WAAwB,EAAE,QAAkB,EAAE,GAAQ,EAAE,EAAU;;;;;qBAEjE,CAAA,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAA,EAAnC,cAAmC;gBAC7B,IAAI,GAAG,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAC,OAAO;oBACnC,EAAE,CAAC,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;wBACpB,MAAM,CAAC,IAAI,CAAC;oBAChB,CAAC;oBACD,MAAM,CAAC,KAAK,CAAC;gBACjB,CAAC,CAAC,CAAC;qBACC,IAAI,EAAJ,cAAI;gBACE,QAAQ,GAAG,IAAI,uBAAI,EAAE,CAAC;gBAC5B,QAAQ,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC;gBAC7B,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC;qBAC1D,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;gBACzB,QAAQ,CAAC,IAAI,GAAG,OAAO,CAAC;gBACxB,WAAM,yBAAyB,CAAC,WAAW,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,EAAA;;gBAA3E,SAA2E,CAAC;gBAC5E,eAAe,CAAC,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;gBAC/C,WAAO,QAAQ,EAAC;oBAGxB,WAAO,OAAO,CAAC,MAAM,CAAI,EAAE,eAAY,CAAC,EAAC;;;KAC5C,CAAC;AAEN,IAAM,YAAY,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,GAAQ;IAEzE,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QAChE,IAAM,WAAS,GAAG,IAAI,gCAAU,EAAE,CAAC;QAEnC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,IAAI;YAC3B,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACpB,KAAK,kBAAkB,EAAE,CAAC;oBACtB,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,eAAe,CAAC,CAAC,CAAC;wBAChC,WAAS,CAAC,MAAM,GAAG,OAAO,CAAC;oBAC/B,CAAC;oBAAC,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,YAAY,CAAC,CAAC,CAAC;wBACpC,WAAS,CAAC,MAAM,GAAG,YAAY,CAAC;oBACpC,CAAC;oBACD,KAAK,CAAC;gBACV,CAAC;gBACD,KAAK,uBAAuB,EAAE,CAAC;oBAC3B,WAAS,CAAC,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC;oBAClC,KAAK,CAAC;gBACV,CAAC;gBACD,KAAK,kBAAkB,EAAE,CAAC;oBACtB,WAAS,CAAC,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC;oBAC7B,KAAK,CAAC;gBACV,CAAC;gBACD,KAAK,gBAAgB,EAAE,CAAC;oBACpB,WAAS,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC;oBAC/B,KAAK,CAAC;gBACV,CAAC;gBACD,SAAS,CAAC;oBACN,KAAK,CAAC;gBACV,CAAC;YACL,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,CAAC,WAAS,CAAC,MAAM,IAAI,WAAS,CAAC,WAAW,IAAI,WAAS,CAAC,QAAQ,IAAI,WAAS,CAAC,IAAI,IAAI,WAAS,CAAC,MAAM,CAAC,CAAC,CAAC;YACxG,WAAW,CAAC,QAAQ,CAAC,SAAS,GAAG,WAAS,CAAC;QAC/C,CAAC;IACL,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,oBAAoB,GAAG,UAAO,WAAwB,EAAE,QAAkB,EAAE,GAAQ;;;;;qBAElF,CAAA,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAA,EAAtD,cAAsD;sBAGpB,EAAf,KAAA,GAAG,CAAC,KAAK,CAAC,KAAK;;;qBAAf,CAAA,cAAe,CAAA;gBAAvB,IAAI;qBAEP,CAAA,CAAC,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,KAAK,KAAK,CAAA,EAArC,cAAqC;gBAEjC,QAAQ,SAAM,CAAC;;;;gBAEJ,WAAM,kBAAkB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,EAAA;;gBAA3E,QAAQ,GAAG,SAAgE,CAAC;;;;gBAE5E,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,cAAS;;gBAGb,EAAE,CAAC,CAAC,QAAQ,IAAI,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;oBAC5B,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC;wBACrB,WAAW,CAAC,KAAK,GAAG,EAAE,CAAC;oBAC3B,CAAC;oBACD,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACrC,CAAC;;;gBAjBU,IAAe,CAAA;;;qBAsBlC,CAAA,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAA,EAAnC,eAAmC;sBAIJ,EAAZ,KAAA,GAAG,CAAC,QAAQ;;;qBAAZ,CAAA,cAAY,CAAA;gBAApB,IAAI;gBAEL,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC;qBAC1D,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;gBACnB,SAAS,GAAG,iBAAiB,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;qBACtD,CAAA,CAAC,SAAS,IAAI,CAAC,SAAS,CAAC,IAAI,CAAA,EAA7B,eAA6B;gBAEvB,QAAQ,GAAG,IAAI,uBAAI,EAAE,CAAC;gBAC5B,QAAQ,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC;gBACnC,QAAQ,CAAC,IAAI,GAAG,OAAO,CAAC;gBACxB,WAAM,yBAAyB,CAAC,WAAW,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,EAAA;;gBAA3E,SAA2E,CAAC;gBAC5E,eAAe,CAAC,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC;gBAE/C,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC;oBACzB,WAAW,CAAC,SAAS,GAAG,EAAE,CAAC;gBAC/B,CAAC;gBACD,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;;;gBAhB1B,IAAY,CAAA;;;;;KAoBtC,CAAC;AAEF,IAAM,kBAAkB,GACpB,UAAC,WAAwB,EAAE,SAAmB,EAAE,IAAS,EAAE,UAAsB,EAAE,GAAoB;IAEnG,UAAU,CAAC,aAAa,CAAC,OAAO,CAAC,UAAC,OAAO;QACrC,IAAM,SAAS,GAAG,IAAI,8BAAS,EAAE,CAAC;QAClC,SAAS,CAAC,SAAS,GAAG,OAAO,CAAC,gBAAgB,CAAC,SAAS,CAAC;QAEzD,EAAE,CAAC,CAAC,GAAG;YACH,SAAS,CAAC,SAAS,KAAK,oCAAoC;YAC5D,SAAS,CAAC,SAAS,KAAK,gCAAgC,CAAC,CAAC,CAAC;YAC3D,SAAS,CAAC,OAAO,GAAG,GAAG,CAAC,UAAU,CAAC,OAAO,CAAC;YAC3C,SAAS,CAAC,MAAM,GAAG,gCAAgC,CAAC;QACxD,CAAC;QACD,EAAE,CAAC,CAAC,OAAO,CAAC,oBAAoB,IAAI,OAAO,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC;YAEtE,OAAO,CAAC,oBAAoB,CAAC,OAAO,CAAC,UAAC,IAAI;gBAEtC,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;oBACnB,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC,CAAC;wBAClC,SAAS,CAAC,cAAc,GAAG,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC;oBAC3E,CAAC;oBACD,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,KAAK,GAAG,CAAC,CAAC,CAAC;wBAClC,SAAS,CAAC,WAAW,GAAG,SAAS,CAAC;oBACtC,CAAC;oBAAC,IAAI,CAAC,CAAC;wBACJ,SAAS,CAAC,WAAW,GAAG,MAAM,CAAC;oBACnC,CAAC;gBACL,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;QAED,WAAW,CAAC,SAAS,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,EAAE,EAAE,IAAI;YAEtC,IAAM,QAAQ,GAAG,CAAC,CAAC,IAAI,CAAC;YACxB,EAAE,CAAC,CAAC,QAAQ,KAAK,OAAO,CAAC,UAAU,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC;gBACtD,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;oBAChB,CAAC,CAAC,UAAU,GAAG,IAAI,gCAAU,EAAE,CAAC;gBACpC,CAAC;gBACD,CAAC,CAAC,UAAU,CAAC,SAAS,GAAG,SAAS,CAAC;YACvC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,WAAW,CAAC,KAAK,CAAC,OAAO,CAAC,UAAC,CAAC,EAAE,EAAE,EAAE,IAAI;YAClC,IAAM,QAAQ,GAAG,CAAC,CAAC,IAAI,CAAC;YACxB,EAAE,CAAC,CAAC,QAAQ,KAAK,OAAO,CAAC,UAAU,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC;gBACtD,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;oBAChB,CAAC,CAAC,UAAU,GAAG,IAAI,gCAAU,EAAE,CAAC;gBACpC,CAAC;gBACD,CAAC,CAAC,UAAU,CAAC,SAAS,GAAG,SAAS,CAAC;YACvC,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;AACP,CAAC,CAAC;AAEN,IAAM,mBAAmB,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,IAAS,EAAE,GAAQ;IAC3F,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,UAAU,IAAI,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC;QAC5E,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,OAAO,CAAC,UAAC,UAAU;YACvC,IAAM,IAAI,GAAG,IAAI,uBAAI,EAAE,CAAC;YACxB,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,UAAU,CAAC,OAAO,CAAC,GAAG,CAAC;iBACvE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YACzB,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC;YACpB,IAAI,CAAC,KAAK,GAAG,UAAU,CAAC,IAAI,CAAC;YAC7B,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACxB,WAAW,CAAC,QAAQ,GAAG,EAAE,CAAC;YAC9B,CAAC;YACD,WAAW,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACpC,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,cAAc,GAAG,UAAC,WAAwB,EAAE,QAAkB,EAAE,GAAQ,EAAE,GAAQ;IACpF,EAAE,CAAC,CAAC,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;QAClC,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,UAAC,KAAK;YACrB,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;gBACnB,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;YACzB,CAAC;YACD,mBAAmB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,EAAE,KAAK,EAAE,WAAW,CAAC,GAAG,CAAC,CAAC;QACjF,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,sBAAsB,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,GAAQ;IACnF,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QAChC,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,UAAC,GAAG;YAClB,EAAE,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;gBACX,IAAM,IAAI,GAAG,IAAI,uBAAI,EAAE,CAAC;gBACxB,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,IAAI,CAAC;qBACzD,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;gBACzB,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC;gBACpB,IAAI,CAAC,KAAK,GAAG,GAAG,CAAC,KAAK,CAAC;gBACvB,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC;oBACzB,WAAW,CAAC,SAAS,GAAG,EAAE,CAAC;gBAC/B,CAAC;gBACD,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACrC,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,mBAAmB,GACrB,UAAC,WAAwB,EAAE,QAAkB,EAAE,GAAQ,EAAE,GAAQ,EAAE,KAAe,EAAE,IAAY;IAE5F,IAAM,IAAI,GAAG,IAAI,uBAAI,EAAE,CAAC;IACxB,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC;SAClE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;IACzB,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC;IACpB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC;IAExB,EAAE,CAAC,CAAC,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;QACtC,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,UAAC,CAAC;YACnB,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACjB,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;YACvB,CAAC;YACD,mBAAmB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC3E,CAAC,CAAC,CAAC;IACP,CAAC;IAED,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACpB,CAAC,CAAC;AAEN,IAAM,WAAW,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,GAAQ;IACxE,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,OAAO,IAAI,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;QACtE,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,UAAC,CAAC;YAC3B,IAAM,GAAG,GAAG,IAAI,0BAAO,EAAE,CAAC;YAC1B,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,CAAC;YAClB,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,CAAC;YAClB,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,SAAS,CAAC;YACzB,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC;gBAChC,WAAW,CAAC,QAAQ,CAAC,OAAO,GAAG,EAAE,CAAC;YACtC,CAAC;YACD,WAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAC3C,CAAC,CAAC,CAAC;IACP,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,oBAAoB,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,GAAQ;IACjF,IAAI,KAAyB,CAAC;IAC9B,IAAI,aAAiC,CAAC;IAEtC,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QAChE,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,CAAC;YACxB,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,gBAAgB,CAAC,CAAC,CAAC;gBAC9B,KAAK,GAAG,CAAC,CAAC,OAAO,CAAC;YACtB,CAAC;YACD,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,sBAAsB,CAAC,CAAC,CAAC;gBACpC,aAAa,GAAG,UAAU,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YAC1C,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;IAED,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;QACR,IAAM,UAAU,GAAG,IAAI,gCAAU,EAAE,CAAC;QACpC,UAAU,CAAC,IAAI,GAAG,KAAK,CAAC;QACxB,EAAE,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;YAChB,UAAU,CAAC,QAAQ,GAAG,aAAa,CAAC;QACxC,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;YAClC,WAAW,CAAC,QAAQ,CAAC,SAAS,GAAG,IAAI,8BAAS,EAAE,CAAC;QACrD,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC;YACzC,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,MAAM,GAAG,EAAE,CAAC;QAC/C,CAAC;QACD,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;IAC3D,CAAC;AACL,CAAC,CAAC;AAEF,IAAM,iBAAiB,GAAG,UAAO,WAAwB,EAAE,SAAmB,EAAE,IAAS,EAAE,GAAS;;;;;gBAG1F,OAAO,GAAG,WAAW,CAAC,SAAS,EAAE,CAAC;gBACxC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;oBACX,MAAM,KAAC;gBACX,CAAC;gBAEK,cAAc,GAAG,OAAO,CAAC,IAAI,CAAC;gBACpC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;oBAChC,MAAM,KAAC;gBACX,CAAC;;;;gBAIsB,WAAM,GAAG,CAAC,kBAAkB,CAAC,cAAc,CAAC,EAAA;;gBAA/D,gBAAgB,GAAG,SAA4C,CAAC;;;;gBAEhE,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;gBAEzB,eAAe,GAAG,gBAAgB,CAAC,MAAM,CAAC;;;;gBAI5B,WAAM,mCAAqB,CAAC,eAAe,CAAC,EAAA;;gBAA5D,aAAa,GAAG,SAA4C,CAAC;;;;gBAE7D,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO,OAAO,CAAC,MAAM,CAAC,MAAG,CAAC,EAAC;;gBAGzB,SAAS,GAAG,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBAC3C,SAAS,GAAG,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC,eAAe,CAAC,SAAS,CAAC,CAAC;gBAE9D,MAAM,GAAG,KAAK,CAAC,aAAa,CAAC;oBAC/B,IAAI,EAAE,8BAA8B;oBACpC,KAAK,EAAE,8BAA8B;iBACxC,CAAC,CAAC;gBAEG,IAAI,GAAG,MAAM,CAAC,mCAAmC,EAAE,SAAS,CAAc,CAAC;gBACjF,EAAE,CAAC,CAAC,IAAI,IAAI,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;oBAEtB,IAAI,CAAC,OAAO,CAAC,UAAC,UAAmB;wBAE7B,IAAM,OAAO,GAAG,MAAM,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;wBACjD,EAAE,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;4BAE5B,IAAM,MAAM,GAAG,MAAM,CAAC,UAAU,EAAE,UAAU,CAAc,CAAC;4BAE3D,IAAM,KAAK,GAAI,OAAO,CAAC,CAAC,CAAU,CAAC,KAAK,CAAC;4BACzC,IAAM,IAAI,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;4BACxC,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;gCAEX,KAAK,KAAK,EAAE,CAAC;oCACT,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;oCACrB,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCACvE,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,WAAW,EAAE,CAAC;oCACf,WAAW,CAAC,QAAQ,GAAG,EAAE,CAAC;oCAC1B,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,QAAQ,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCAC5E,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,WAAW,EAAE,CAAC;oCACf,WAAW,CAAC,SAAS,GAAG,EAAE,CAAC;oCAC3B,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,SAAS,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCAC7E,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,KAAK,EAAE,CAAC;oCACT,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;oCACrB,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCACvE,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,KAAK,EAAE,CAAC;oCACT,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;oCACrB,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCACvE,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,KAAK,EAAE,CAAC;oCACT,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;oCACrB,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCACvE,KAAK,CAAC;gCACV,CAAC;gCACD,KAAK,KAAK,EAAE,CAAC;oCACT,WAAW,CAAC,GAAG,GAAG,EAAE,CAAC;oCACrB,uBAAuB,CAAC,MAAM,EAAE,MAAM,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;oCACvE,KAAK,CAAC;gCACV,CAAC;gCACD,SAAS,CAAC;oCACN,KAAK,CAAC;gCACV,CAAC;4BACL,CAAC;wBACL,CAAC;oBACL,CAAC,CAAC,CAAC;gBACP,CAAC;;;;KACJ,CAAC;AAEF,IAAM,uBAAuB,GAAG,UAAC,MAAW,EAAE,OAAkB,EAAE,IAAY,EAAE,UAAkB;IAE9F,OAAO,CAAC,OAAO,CAAC,UAAC,MAAe;QAE5B,IAAM,OAAO,GAAG,MAAM,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;QAC3C,EAAE,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;YAE5B,OAAO,CAAC,OAAO,CAAC,UAAC,MAAe;gBAE5B,IAAM,IAAI,GAAG,IAAI,uBAAI,EAAE,CAAC;gBACxB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBAEhB,IAAM,MAAM,GAAG,MAAM,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;gBACzC,EAAE,CAAC,CAAC,MAAM,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;oBAE9B,IAAM,KAAK,GAAG,MAAM,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;oBACzC,EAAE,CAAC,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;wBACxB,IAAI,GAAG,GAAI,KAAK,CAAC,CAAC,CAAU,CAAC,KAAK,CAAC;wBACnC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;4BACjB,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,GAAG,GAAG,CAAC;wBAC1C,CAAC;wBAED,IAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,GAAG,CAAC;6BACnD,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;wBACzB,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC;oBACxB,CAAC;oBAED,IAAI,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC;oBAClC,EAAE,CAAC,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;wBACxB,KAAK,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;wBACrB,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;wBACrC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;oBACvB,CAAC;gBACL,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACJ,IAAM,YAAY,GAAG,MAAM,CAAC,YAAY,EAAE,MAAM,CAAC,CAAC;oBAClD,EAAE,CAAC,CAAC,YAAY,IAAI,YAAY,CAAC,MAAM,IAAI,YAAY,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;wBACrE,IAAI,CAAC,KAAK,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,IAAI,EAAE,CAAC;oBACpD,CAAC;gBACL,CAAC;gBAED,IAAM,WAAW,GAAG,MAAM,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;gBAC/C,EAAE,CAAC,CAAC,WAAW,IAAI,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;oBACpC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;wBACjB,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;oBACvB,CAAC;oBACD,uBAAuB,CAAC,MAAM,EAAE,WAAW,EAAE,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;gBAC5E,CAAC;YACL,CAAC,CAAC,CAAC;QACP,CAAC;IACL,CAAC,CAAC,CAAC;AACP,CAAC,CAAC;AAEF,IAAM,WAAW,GAAG,UAAO,WAAwB,EAAE,QAAkB,EAAE,GAAQ;;;;;gBAI7E,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;oBAChE,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,UAAC,IAAI;wBACxB,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC;4BACxB,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;4BACvB,MAAM,CAAC,IAAI,CAAC;wBAChB,CAAC;wBACD,MAAM,CAAC,KAAK,CAAC;oBACjB,CAAC,CAAC,CAAC;gBACP,CAAC;qBAEG,OAAO,EAAP,cAAO;gBACH,YAAY,SAAM,CAAC;;;;gBAEJ,WAAM,kBAAkB,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,EAAE,OAAO,CAAC,EAAA;;gBAA5E,YAAY,GAAG,SAA6D,CAAC;;;;gBAE7E,KAAK,CAAC,MAAG,CAAC,CAAC;gBACX,WAAO;;qBAEP,CAAA,YAAY,IAAI,YAAY,CAAC,IAAI,IAAI,WAAW,CAAC,SAAS,IAAI,WAAW,CAAC,SAAS,CAAC,MAAM,CAAA,EAA1F,cAA0F;gBAEpF,SAAO,YAAY,CAAC,IAAI,CAAC;gBACzB,KAAK,GAAG,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,UAAC,IAAI,EAAE,EAAE,EAAE,IAAI;oBACpD,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,MAAI,CAAC,CAAC,CAAC;wBACrB,MAAM,CAAC,IAAI,CAAC;oBAChB,CAAC;oBACD,MAAM,CAAC,KAAK,CAAC;gBACjB,CAAC,CAAC,CAAC;qBACC,KAAK,EAAL,cAAK;gBACL,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;gBACtB,WAAM,0BAAkB,CAAC,WAAW,EAAE,KAAK,CAAC,EAAA;;gBAA5C,SAA4C,CAAC;;;;;KAI5D,CAAC;AAEF,IAAM,gCAAgC,GAAG,UAAC,QAAkB,EAAE,SAAmB,EAAE,GAAQ;IAEvF,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,KAAK,IAAI,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QACzD,IAAM,EAAE,GAAG,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,IAAI;YACjC,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,KAAK,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;gBAC7B,MAAM,CAAC,IAAI,CAAC;YAChB,CAAC;YACD,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC;YACtB,MAAM,CAAC,EAAE,CAAC,UAAU,CAAC;QACzB,CAAC;IACL,CAAC;IAED,MAAM,CAAC,SAAS,CAAC;AACrB,CAAC,CAAC;AAEF,IAAM,iBAAiB,GAAG,UAAC,WAAwB,EAAE,IAAY;IAE7D,EAAE,CAAC,CAAC,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QAChD,IAAM,EAAE,GAAG,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,CAAC;YAChC,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC,CAAC,CAAC;gBAClB,MAAM,CAAC,IAAI,CAAC;YAChB,CAAC;YACD,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YACL,MAAM,CAAC,EAAE,CAAC;QACd,CAAC;IACL,CAAC;IAED,MAAM,CAAC,SAAS,CAAC;AACrB,CAAC,CAAC;AAEF,IAAM,2BAA2B,GAAG,UAChC,QAAkB,EAAE,GAAQ,EAAE,EAAU,EAAE,QAAgB;IAE1D,IAAM,GAAG,GAAG,8BAA8B,CAAC,QAAQ,EAAE,GAAG,EAAE,EAAE,EAAE,QAAQ,CAAC,CAAC;IACxE,EAAE,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;QACb,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;IAClB,CAAC;IACD,MAAM,CAAC,SAAS,CAAC;AACrB,CAAC,CAAC;AAEF,IAAM,8BAA8B,GAAG,UAAC,SAAmB,EAAE,GAAQ,EAAE,EAAU,EAAE,QAAgB;IAC/F,IAAM,KAAK,GAAgB,EAAE,CAAC;IAE9B,IAAM,QAAQ,GAAG,GAAG,GAAG,EAAE,CAAC;IAE1B,EAAE,CAAC,CAAC,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;QACpC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,UAAC,OAAO;YAC9B,EAAE,CAAC,CAAC,OAAO,CAAC,MAAM,KAAK,QAAQ,IAAI,OAAO,CAAC,QAAQ,KAAK,QAAQ,CAAC,CAAC,CAAC;gBAC/D,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACxB,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;IAED,MAAM,CAAC,KAAK,CAAC;AACjB,CAAC,CAAC;AAEF,IAAM,cAAc,GAAG,UAAC,QAAkB,EAAE,GAAQ;IAEhD,EAAE,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC;QACnB,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC;IAC5B,CAAC;IAAC,IAAI,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;QACrB,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC;IACvB,CAAC;IAED,MAAM,CAAC,SAAS,CAAC;AACrB,CAAC,CAAC;AAEF,IAAM,aAAa,GAAG,UAAC,QAAkB,EAAE,GAAQ;IAE/C,IAAM,OAAO,GAAG,cAAc,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;IAC9C,MAAM,CAAC,CAAC,OAAO,KAAK,KAAK,IAAI,OAAO,KAAK,OAAO,IAAI,OAAO,KAAK,MAAM,CAAC,CAAC;AAC5E,CAAC,CAAC;AAEF,IAAM,cAAc,GAAG,UAAC,WAAwB,EAAE,SAAmB,EAAE,IAAS,EAAE,IAAY;IAC1F,EAAE,CAAC,CAAC,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QAChD,IAAM,EAAE,GAAG,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,CAAC;YAChC,IAAM,SAAS,GAAG,CAAC,CAAC,IAAI,CAAC;YAEzB,EAAE,CAAC,CAAC,IAAI,KAAK,SAAS,CAAC,CAAC,CAAC;gBACrB,MAAM,CAAC,IAAI,CAAC;YAChB,CAAC;YACD,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YACL,MAAM,CAAC,EAAE,CAAC;QACd,CAAC;IACL,CAAC;IAED,MAAM,CAAC,SAAS,CAAC;AACrB,CAAC,CAAC","sourcesContent":["import * as path from \"path\";\r\nimport * as querystring from \"querystring\";\r\n\r\nimport { MediaOverlayNode, timeStrToSeconds } from \"@models/media-overlay\";\r\nimport { Metadata } from \"@models/metadata\";\r\nimport { BelongsTo } from \"@models/metadata-belongsto\";\r\nimport { Collection } from \"@models/metadata-collection\";\r\nimport { Contributor } from \"@models/metadata-contributor\";\r\nimport { Encrypted } from \"@models/metadata-encrypted\";\r\nimport { MediaOverlay } from \"@models/metadata-media-overlay\";\r\nimport { IStringMap } from \"@models/metadata-multilang\";\r\nimport { Properties } from \"@models/metadata-properties\";\r\nimport { Subject } from \"@models/metadata-subject\";\r\nimport { Publication } from \"@models/publication\";\r\nimport { Link } from \"@models/publication-link\";\r\nimport { Transformers } from \"@transform/transformer\";\r\nimport { streamToBufferPromise } from \"@utils/stream/BufferUtils\";\r\nimport { XML } from \"@utils/xml-js-mapper\";\r\nimport { IStreamAndLength, IZip } from \"@utils/zip/zip\";\r\nimport { zipLoadPromise } from \"@utils/zip/zipFactory\";\r\nimport * as debug_ from \"debug\";\r\nimport * as sizeOf from \"image-size\";\r\nimport * as moment from \"moment\";\r\nimport { JSON as TAJSON } from \"ta-json\";\r\nimport * as xmldom from \"xmldom\";\r\nimport * as xpath from \"xpath\";\r\n\r\nimport { Container } from \"./epub/container\";\r\nimport { Rootfile } from \"./epub/container-rootfile\";\r\nimport { Encryption } from \"./epub/encryption\";\r\nimport { LCP } from \"./epub/lcp\";\r\nimport { NCX } from \"./epub/ncx\";\r\nimport { NavPoint } from \"./epub/ncx-navpoint\";\r\nimport { OPF } from \"./epub/opf\";\r\nimport { Author } from \"./epub/opf-author\";\r\nimport { Manifest } from \"./epub/opf-manifest\";\r\nimport { Metafield } from \"./epub/opf-metafield\";\r\nimport { Title } from \"./epub/opf-title\";\r\nimport { SMIL } from \"./epub/smil\";\r\nimport { Par } from \"./epub/smil-par\";\r\nimport { Seq } from \"./epub/smil-seq\";\r\nimport { SeqOrPar } from \"./epub/smil-seq-or-par\";\r\n\r\nconst debug = debug_(\"r2:epub\");\r\n\r\nconst epub3 = \"3.0\";\r\nconst epub301 = \"3.0.1\";\r\nconst epub31 = \"3.1\";\r\n// const epub2 = \"2.0\";\r\n// const epub201 = \"2.0.1\";\r\nconst autoMeta = \"auto\";\r\nconst noneMeta = \"none\";\r\nconst reflowableMeta = \"reflowable\";\r\n\r\nexport const mediaOverlayURLPath = \"media-overlay.json\";\r\nexport const mediaOverlayURLParam = \"resource\";\r\n\r\nexport const addCoverDimensions = async (publication: Publication, coverLink: Link) => {\r\n\r\n    const zipInternal = publication.findFromInternal(\"zip\");\r\n    if (zipInternal) {\r\n        const zip = zipInternal.Value as IZip;\r\n        if (zip.hasEntry(coverLink.Href)) {\r\n            let zipStream: IStreamAndLength;\r\n            try {\r\n                zipStream = await zip.entryStreamPromise(coverLink.Href);\r\n            } catch (err) {\r\n                debug(coverLink.Href);\r\n                debug(coverLink.TypeLink);\r\n                debug(err);\r\n                return;\r\n            }\r\n\r\n            let zipData: Buffer;\r\n            try {\r\n                zipData = await streamToBufferPromise(zipStream.stream);\r\n\r\n                const imageInfo = sizeOf(zipData);\r\n                if (imageInfo) {\r\n                    coverLink.Width = imageInfo.width;\r\n                    coverLink.Height = imageInfo.height;\r\n\r\n                    if (coverLink.TypeLink &&\r\n                        coverLink.TypeLink.replace(\"jpeg\", \"jpg\").replace(\"+xml\", \"\")\r\n                        !== (\"image/\" + imageInfo.type)) {\r\n                        debug(`Wrong image type? ${coverLink.TypeLink} -- ${imageInfo.type}`);\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                debug(coverLink.Href);\r\n                debug(coverLink.TypeLink);\r\n                debug(err);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nexport async function EpubParsePromise(filePath: string): Promise<Publication> {\r\n    let zip: IZip;\r\n    try {\r\n        zip = await zipLoadPromise(filePath);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    if (!zip.hasEntries()) {\r\n        return Promise.reject(\"EPUB zip empty\");\r\n    }\r\n\r\n    const publication = new Publication();\r\n    publication.Context = [\"http://readium.org/webpub/default.jsonld\"];\r\n    publication.Metadata = new Metadata();\r\n    publication.Metadata.RDFType = \"http://schema.org/Book\";\r\n    publication.Metadata.Modified = moment(Date.now()).toDate();\r\n\r\n    publication.AddToInternal(\"filename\", path.basename(filePath));\r\n\r\n    publication.AddToInternal(\"type\", \"epub\");\r\n    publication.AddToInternal(\"zip\", zip);\r\n\r\n    let lcpl: LCP | undefined;\r\n    const lcplZipPath = \"META-INF/license.lcpl\";\r\n    if (zip.hasEntry(lcplZipPath)) {\r\n        let lcplZipStream_: IStreamAndLength;\r\n        try {\r\n            lcplZipStream_ = await zip.entryStreamPromise(lcplZipPath);\r\n        } catch (err) {\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n        const lcplZipStream = lcplZipStream_.stream;\r\n\r\n        let lcplZipData: Buffer;\r\n        try {\r\n            lcplZipData = await streamToBufferPromise(lcplZipStream);\r\n        } catch (err) {\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n\r\n        const lcplStr = lcplZipData.toString(\"utf8\");\r\n        const lcplJson = global.JSON.parse(lcplStr);\r\n        debug(lcplJson);\r\n        lcpl = TAJSON.deserialize<LCP>(lcplJson, LCP);\r\n        lcpl.ZipPath = lcplZipPath;\r\n        lcpl.JsonSource = lcplStr;\r\n        lcpl.init();\r\n\r\n        // breakLength: 100  maxArrayLength: undefined\r\n        // console.log(util.inspect(lcpl,\r\n        //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n\r\n        publication.LCP = lcpl;\r\n\r\n        // // breakLength: 100  maxArrayLength: undefined\r\n        // console.log(util.inspect(this.LCP,\r\n        //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n\r\n        publication.AddLink(\"application/vnd.readium.lcp.license-1.0+json\", [\"license\"],\r\n            lcpl.ZipPath, false);\r\n    }\r\n\r\n    let encryption: Encryption | undefined;\r\n    const encZipPath = \"META-INF/encryption.xml\";\r\n    if (zip.hasEntry(encZipPath)) {\r\n\r\n        let encryptionXmlZipStream_: IStreamAndLength;\r\n        try {\r\n            encryptionXmlZipStream_ = await zip.entryStreamPromise(encZipPath);\r\n        } catch (err) {\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n        const encryptionXmlZipStream = encryptionXmlZipStream_.stream;\r\n\r\n        let encryptionXmlZipData: Buffer;\r\n        try {\r\n            encryptionXmlZipData = await streamToBufferPromise(encryptionXmlZipStream);\r\n        } catch (err) {\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n\r\n        const encryptionXmlStr = encryptionXmlZipData.toString(\"utf8\");\r\n        const encryptionXmlDoc = new xmldom.DOMParser().parseFromString(encryptionXmlStr);\r\n\r\n        encryption = XML.deserialize<Encryption>(encryptionXmlDoc, Encryption);\r\n        encryption.ZipPath = encZipPath;\r\n\r\n        // breakLength: 100  maxArrayLength: undefined\r\n        // console.log(util.inspect(encryption,\r\n        //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n    }\r\n\r\n    const containerZipPath = \"META-INF/container.xml\";\r\n\r\n    let containerXmlZipStream_: IStreamAndLength;\r\n    try {\r\n        containerXmlZipStream_ = await zip.entryStreamPromise(containerZipPath);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n    const containerXmlZipStream = containerXmlZipStream_.stream;\r\n\r\n    let containerXmlZipData: Buffer;\r\n    try {\r\n        containerXmlZipData = await streamToBufferPromise(containerXmlZipStream);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    const containerXmlStr = containerXmlZipData.toString(\"utf8\");\r\n    const containerXmlDoc = new xmldom.DOMParser().parseFromString(containerXmlStr);\r\n\r\n    // debug(containerXmlDoc);\r\n    // debug(containerXmlStr);\r\n    // const containerXmlRootElement = xpath.select1(\"/\", containerXmlDoc);\r\n    // debug(containerXmlRootElement.toString());\r\n\r\n    const container = XML.deserialize<Container>(containerXmlDoc, Container);\r\n    container.ZipPath = containerZipPath;\r\n    // breakLength: 100  maxArrayLength: undefined\r\n    // console.log(util.inspect(container,\r\n    //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n\r\n    const rootfile = container.Rootfile[0];\r\n\r\n    // debug(`${rootfile.Path}:`);\r\n\r\n    // let timeBegin = process.hrtime();\r\n\r\n    let opfZipStream_: IStreamAndLength;\r\n    try {\r\n        opfZipStream_ = await zip.entryStreamPromise(rootfile.Path);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n    const opfZipStream = opfZipStream_.stream;\r\n\r\n    // const timeElapsed1 = process.hrtime(timeBegin);\r\n    // debug(`1) ${timeElapsed1[0]} seconds + ${timeElapsed1[1]} nanoseconds`);\r\n    // timeBegin = process.hrtime();\r\n\r\n    let opfZipData: Buffer;\r\n    try {\r\n        opfZipData = await streamToBufferPromise(opfZipStream);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    // debug(`${opfZipData.length} bytes`);\r\n\r\n    // const timeElapsed2 = process.hrtime(timeBegin);\r\n    // debug(`2) ${timeElapsed2[0]} seconds + ${timeElapsed2[1]} nanoseconds`);\r\n    // timeBegin = process.hrtime();\r\n\r\n    const opfStr = opfZipData.toString(\"utf8\");\r\n\r\n    // const timeElapsed3 = process.hrtime(timeBegin);\r\n    // debug(`3) ${timeElapsed3[0]} seconds + ${timeElapsed3[1]} nanoseconds`);\r\n    // timeBegin = process.hrtime();\r\n\r\n    // TODO: this takes some time with large OPF XML data\r\n    // (typically: many manifest items),\r\n    // but it remains acceptable.\r\n    // e.g. BasicTechnicalMathWithCalculus.epub with 2.5MB OPF!\r\n    const opfDoc = new xmldom.DOMParser().parseFromString(opfStr);\r\n\r\n    // const timeElapsed4 = process.hrtime(timeBegin);\r\n    // debug(`4) ${timeElapsed4[0]} seconds + ${timeElapsed4[1]} nanoseconds`);\r\n    // const timeBegin = process.hrtime();\r\n\r\n    // tslint:disable-next-line:no-string-literal\r\n    // process.env[\"OPF_PARSE\"] = \"true\";\r\n    // TODO: this takes a MASSIVE amount of time with large OPF XML data\r\n    // (typically: many manifest items)\r\n    // e.g. BasicTechnicalMathWithCalculus.epub with 2.5MB OPF!\r\n    // culprit: XPath lib ... so we use our own mini XPath parser/matcher\r\n    // (=> performance gain in orders of magnitude!)\r\n    const opf = XML.deserialize<OPF>(opfDoc, OPF);\r\n    // tslint:disable-next-line:no-string-literal\r\n    // process.env[\"OPF_PARSE\"] = \"false\";\r\n\r\n    // const timeElapsed5 = process.hrtime(timeBegin);\r\n    // debug(`5) ${timeElapsed5[0]} seconds + ${timeElapsed5[1]} nanoseconds`);\r\n\r\n    opf.ZipPath = rootfile.Path;\r\n\r\n    // breakLength: 100  maxArrayLength: undefined\r\n    // console.log(util.inspect(opf,\r\n    //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n\r\n    // const epubVersion = getEpubVersion(rootfile, opf);\r\n\r\n    let ncx: NCX | undefined;\r\n    if (opf.Spine.Toc) {\r\n        const ncxManItem = opf.Manifest.find((manifestItem) => {\r\n            return manifestItem.ID === opf.Spine.Toc;\r\n        });\r\n        if (ncxManItem) {\r\n            const ncxFilePath = path.join(path.dirname(opf.ZipPath), ncxManItem.Href)\r\n                .replace(/\\\\/g, \"/\");\r\n            // debug(\"########## NCX: \"\r\n            //     + opf.ZipPath\r\n            //     + \" == \"\r\n            //     + ncxManItem.Href\r\n            //     + \" -- \"\r\n            //     + ncxFilePath);\r\n\r\n            let ncxZipStream_: IStreamAndLength;\r\n            try {\r\n                ncxZipStream_ = await zip.entryStreamPromise(ncxFilePath);\r\n            } catch (err) {\r\n                debug(err);\r\n                return Promise.reject(err);\r\n            }\r\n            const ncxZipStream = ncxZipStream_.stream;\r\n\r\n            let ncxZipData: Buffer;\r\n            try {\r\n                ncxZipData = await streamToBufferPromise(ncxZipStream);\r\n            } catch (err) {\r\n                debug(err);\r\n                return Promise.reject(err);\r\n            }\r\n\r\n            const ncxStr = ncxZipData.toString(\"utf8\");\r\n            const ncxDoc = new xmldom.DOMParser().parseFromString(ncxStr);\r\n            ncx = XML.deserialize<NCX>(ncxDoc, NCX);\r\n            ncx.ZipPath = ncxFilePath;\r\n\r\n            // breakLength: 100  maxArrayLength: undefined\r\n            // console.log(util.inspect(ncx,\r\n            //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n        }\r\n    }\r\n\r\n    addTitle(publication, rootfile, opf);\r\n\r\n    addIdentifier(publication, rootfile, opf);\r\n\r\n    if (opf.Metadata) {\r\n        if (opf.Metadata.Language) {\r\n            publication.Metadata.Language = opf.Metadata.Language;\r\n        }\r\n        if (opf.Metadata.Rights && opf.Metadata.Rights.length) {\r\n            publication.Metadata.Rights = opf.Metadata.Rights.join(\" \");\r\n        }\r\n        if (opf.Metadata.Description && opf.Metadata.Description.length) {\r\n            publication.Metadata.Description = opf.Metadata.Description[0];\r\n        }\r\n        if (opf.Metadata.Publisher && opf.Metadata.Publisher.length) {\r\n            publication.Metadata.Publisher = [];\r\n\r\n            opf.Metadata.Publisher.forEach((pub) => {\r\n                const contrib = new Contributor();\r\n                contrib.Name = pub;\r\n                publication.Metadata.Publisher.push(contrib);\r\n            });\r\n        }\r\n        if (opf.Metadata.Source && opf.Metadata.Source.length) {\r\n            publication.Metadata.Source = opf.Metadata.Source[0];\r\n        }\r\n\r\n        if (opf.Metadata.Contributor && opf.Metadata.Contributor.length) {\r\n            opf.Metadata.Contributor.forEach((cont) => {\r\n                addContributor(publication, rootfile, opf, cont, undefined);\r\n            });\r\n        }\r\n        if (opf.Metadata.Creator && opf.Metadata.Creator.length) {\r\n            opf.Metadata.Creator.forEach((cont) => {\r\n                addContributor(publication, rootfile, opf, cont, \"aut\");\r\n            });\r\n        }\r\n\r\n        if (opf.Metadata.Meta) {\r\n            const metasDuration: Metafield[] = [];\r\n            const metasNarrator: Metafield[] = [];\r\n            const metasActiveClass: Metafield[] = [];\r\n            const metasPlaybackActiveClass: Metafield[] = [];\r\n\r\n            opf.Metadata.Meta.forEach((metaTag) => {\r\n                if (metaTag.Property === \"media:duration\") {\r\n                    metasDuration.push(metaTag);\r\n                }\r\n                if (metaTag.Property === \"media:narrator\") {\r\n                    metasNarrator.push(metaTag);\r\n                }\r\n                if (metaTag.Property === \"media:active-class\") {\r\n                    metasActiveClass.push(metaTag);\r\n                }\r\n                if (metaTag.Property === \"media:playback-active-class\") {\r\n                    metasPlaybackActiveClass.push(metaTag);\r\n                }\r\n            });\r\n\r\n            if (metasDuration.length) {\r\n                publication.Metadata.Duration = timeStrToSeconds(metasDuration[0].Data);\r\n            }\r\n            if (metasNarrator.length) {\r\n                if (!publication.Metadata.Narrator) {\r\n                    publication.Metadata.Narrator = [];\r\n                }\r\n                metasNarrator.forEach((metaNarrator) => {\r\n                    const cont = new Contributor();\r\n                    cont.Name = metaNarrator.Data;\r\n                    publication.Metadata.Narrator.push(cont);\r\n                });\r\n            }\r\n            if (metasActiveClass.length) {\r\n                if (!publication.Metadata.MediaOverlay) {\r\n                    publication.Metadata.MediaOverlay = new MediaOverlay();\r\n                }\r\n                publication.Metadata.MediaOverlay.ActiveClass = metasActiveClass[0].Data;\r\n            }\r\n            if (metasPlaybackActiveClass.length) {\r\n                if (!publication.Metadata.MediaOverlay) {\r\n                    publication.Metadata.MediaOverlay = new MediaOverlay();\r\n                }\r\n                publication.Metadata.MediaOverlay.PlaybackActiveClass = metasPlaybackActiveClass[0].Data;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (opf.Spine && opf.Spine.PageProgression) {\r\n        publication.Metadata.Direction = opf.Spine.PageProgression;\r\n    }\r\n    // else {\r\n    //     publication.Metadata.Direction = \"default\";\r\n    // }\r\n\r\n    if (isEpub3OrMore(rootfile, opf)) {\r\n        findContributorInMeta(publication, rootfile, opf);\r\n    }\r\n    await fillSpineAndResource(publication, rootfile, opf);\r\n\r\n    addRendition(publication, rootfile, opf);\r\n\r\n    await addCoverRel(publication, rootfile, opf);\r\n\r\n    if (encryption) {\r\n        fillEncryptionInfo(publication, rootfile, opf, encryption, lcpl);\r\n    }\r\n\r\n    await fillTOCFromNavDoc(publication, rootfile, opf, zip);\r\n\r\n    if (!publication.TOC || !publication.TOC.length) {\r\n        if (ncx) {\r\n            fillTOCFromNCX(publication, rootfile, opf, ncx);\r\n            fillPageListFromNCX(publication, rootfile, opf, ncx);\r\n        }\r\n        fillLandmarksFromGuide(publication, rootfile, opf);\r\n    }\r\n\r\n    fillCalibreSerieInfo(publication, rootfile, opf);\r\n    fillSubject(publication, rootfile, opf);\r\n\r\n    fillPublicationDate(publication, rootfile, opf);\r\n\r\n    await fillMediaOverlay(publication, rootfile, opf, zip);\r\n\r\n    return publication;\r\n}\r\n\r\n// private filePathToTitle(filePath: string): string {\r\n//     const fileName = path.basename(filePath);\r\n//     return slugify(fileName, \"_\").replace(/[\\.]/g, \"_\");\r\n// }\r\n\r\nexport async function getAllMediaOverlays(publication: Publication): Promise<MediaOverlayNode[]> {\r\n    const mos: MediaOverlayNode[] = [];\r\n\r\n    if (publication.Spine) {\r\n        for (const link of publication.Spine) {\r\n            // publication.Spine.forEach((link) => {\r\n            if (link.MediaOverlays) {\r\n                for (const mo of link.MediaOverlays) {\r\n                    // link.MediaOverlays.forEach((mo) => {\r\n                    try {\r\n                        await fillMediaOverlayParse(publication, mo);\r\n                    } catch (err) {\r\n                        return Promise.reject(err);\r\n                    }\r\n                    mos.push(mo);\r\n                    // });\r\n                }\r\n            }\r\n            // });\r\n        }\r\n    }\r\n\r\n    return Promise.resolve(mos);\r\n}\r\n\r\nexport async function getMediaOverlay(publication: Publication, spineHref: string): Promise<MediaOverlayNode[]> {\r\n    const mos: MediaOverlayNode[] = [];\r\n\r\n    if (publication.Spine) {\r\n        for (const link of publication.Spine) {\r\n            // publication.Spine.forEach((link) => {\r\n            if (link.MediaOverlays && link.Href.indexOf(spineHref) >= 0) {\r\n                for (const mo of link.MediaOverlays) {\r\n                    // link.MediaOverlays.forEach((mo) => {\r\n                    try {\r\n                        await fillMediaOverlayParse(publication, mo);\r\n                    } catch (err) {\r\n                        return Promise.reject(err);\r\n                    }\r\n                    mos.push(mo);\r\n                    // });\r\n                }\r\n            }\r\n            // });\r\n        }\r\n    }\r\n\r\n    return Promise.resolve(mos);\r\n}\r\n\r\nconst fillMediaOverlayParse =\r\n    async (publication: Publication, mo: MediaOverlayNode) => {\r\n\r\n    if (mo.initialized) {\r\n        return;\r\n    }\r\n\r\n    let link: Link | undefined;\r\n    if (publication.Resources) {\r\n\r\n        const relativePath = mo.SmilPathInZip;\r\n\r\n        if (publication.Resources) {\r\n            link = publication.Resources.find((l) => {\r\n                if (l.Href === relativePath) {\r\n                    return true;\r\n                }\r\n                return false;\r\n            });\r\n        }\r\n        if (!link) {\r\n            if (publication.Spine) {\r\n                link = publication.Spine.find((l) => {\r\n                    if (l.Href === relativePath) {\r\n                        return true;\r\n                    }\r\n                    return false;\r\n                });\r\n            }\r\n        }\r\n        if (!link) {\r\n            const err = \"Asset not declared in publication spine/resources! \" + relativePath;\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n    }\r\n\r\n    const zipInternal = publication.findFromInternal(\"zip\");\r\n    if (!zipInternal) {\r\n        return;\r\n    }\r\n    const zip = zipInternal.Value as IZip;\r\n\r\n    let smilZipStream_: IStreamAndLength;\r\n    try {\r\n        smilZipStream_ = await zip.entryStreamPromise(mo.SmilPathInZip);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    if (link && link.Properties && link.Properties.Encrypted) {\r\n        let decryptFail = false;\r\n        let transformedStream: IStreamAndLength;\r\n        try {\r\n            transformedStream = await Transformers.tryStream(\r\n                publication, link,\r\n                smilZipStream_,\r\n                false, 0, 0);\r\n        } catch (err) {\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n        if (transformedStream) {\r\n            smilZipStream_ = transformedStream;\r\n        } else {\r\n            decryptFail = true;\r\n        }\r\n\r\n        if (decryptFail) {\r\n            const err = \"Encryption scheme not supported.\";\r\n            debug(err);\r\n            return Promise.reject(err);\r\n        }\r\n    }\r\n\r\n    const smilZipStream = smilZipStream_.stream;\r\n\r\n    let smilZipData: Buffer;\r\n    try {\r\n        smilZipData = await streamToBufferPromise(smilZipStream);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    const smilStr = smilZipData.toString(\"utf8\");\r\n    const smilXmlDoc = new xmldom.DOMParser().parseFromString(smilStr);\r\n    const smil = XML.deserialize<SMIL>(smilXmlDoc, SMIL);\r\n    smil.ZipPath = mo.SmilPathInZip;\r\n\r\n    mo.initialized = true;\r\n    debug(\"PARSED SMIL: \" + mo.SmilPathInZip);\r\n\r\n    // breakLength: 100  maxArrayLength: undefined\r\n    // console.log(util.inspect(smil,\r\n    //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\r\n\r\n    mo.Role = [];\r\n    mo.Role.push(\"section\");\r\n\r\n    if (smil.Body) {\r\n        if (smil.Body.EpubType) {\r\n            smil.Body.EpubType.trim().split(\" \").forEach((role) => {\r\n                if (!role.length) {\r\n                    return;\r\n                }\r\n                if (mo.Role.indexOf(role) < 0) {\r\n                    mo.Role.push(role);\r\n                }\r\n            });\r\n        }\r\n        if (smil.Body.TextRef) {\r\n            const zipPath = path.join(path.dirname(smil.ZipPath), smil.Body.TextRef)\r\n                .replace(/\\\\/g, \"/\");\r\n            mo.Text = zipPath;\r\n\r\n        }\r\n        if (smil.Body.Children && smil.Body.Children.length) {\r\n            smil.Body.Children.forEach((seqChild) => {\r\n                if (!mo.Children) {\r\n                    mo.Children = [];\r\n                }\r\n                addSeqToMediaOverlay(smil, publication, mo, mo.Children, seqChild);\r\n            });\r\n        }\r\n    }\r\n\r\n    return;\r\n};\r\n\r\nconst fillMediaOverlay =\r\n    async (publication: Publication, rootfile: Rootfile, opf: OPF, zip: IZip) => {\r\n\r\n        if (!publication.Resources) {\r\n            return;\r\n        }\r\n\r\n        // no forEach(), because of await/async within the iteration body\r\n        // publication.Resources.forEach(async (item) => {\r\n        for (const item of publication.Resources) {\r\n            if (item.TypeLink !== \"application/smil+xml\") {\r\n                continue;\r\n            }\r\n\r\n            if (!zip.hasEntry(item.Href)) {\r\n                continue;\r\n            }\r\n\r\n            const manItemsHtmlWithSmil: Manifest[] = [];\r\n            opf.Manifest.forEach((manItemHtmlWithSmil) => {\r\n                if (manItemHtmlWithSmil.MediaOverlay) { // HTML\r\n                    const manItemSmil = opf.Manifest.find((mi) => {\r\n                        if (mi.ID === manItemHtmlWithSmil.MediaOverlay) {\r\n                            return true;\r\n                        }\r\n                        return false;\r\n                    });\r\n                    if (manItemSmil) {\r\n                        const smilFilePath2 = path.join(path.dirname(opf.ZipPath), manItemSmil.Href)\r\n                            .replace(/\\\\/g, \"/\");\r\n                        if (smilFilePath2 === item.Href) {\r\n                            manItemsHtmlWithSmil.push(manItemHtmlWithSmil);\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            const mo = new MediaOverlayNode();\r\n            mo.SmilPathInZip = item.Href;\r\n            mo.initialized = false;\r\n\r\n            manItemsHtmlWithSmil.forEach((manItemHtmlWithSmil) => {\r\n\r\n                const htmlPathInZip = path.join(path.dirname(opf.ZipPath), manItemHtmlWithSmil.Href)\r\n                    .replace(/\\\\/g, \"/\");\r\n\r\n                const link = findLinKByHref(publication, rootfile, opf, htmlPathInZip);\r\n                if (link) {\r\n                    if (!link.MediaOverlays) {\r\n                        link.MediaOverlays = [];\r\n                    }\r\n\r\n                    const alreadyExists = link.MediaOverlays.find((moo) => {\r\n                        if (item.Href === moo.SmilPathInZip) {\r\n                            return true;\r\n                        }\r\n                        return false;\r\n                    });\r\n                    if (!alreadyExists) {\r\n                        link.MediaOverlays.push(mo);\r\n                    }\r\n\r\n                    if (!link.Properties) {\r\n                        link.Properties = new Properties();\r\n                    }\r\n                    link.Properties.MediaOverlay = mediaOverlayURLPath + \"?\" +\r\n                        mediaOverlayURLParam + \"=\" + querystring.escape(link.Href);\r\n                }\r\n            });\r\n\r\n            if (item.Properties && item.Properties.Encrypted) {\r\n                debug(\"ENCRYPTED SMIL MEDIA OVERLAY: \" + item.Href);\r\n                continue;\r\n            }\r\n            // LAZY\r\n            // await fillMediaOverlayParse(publication, mo);\r\n        }\r\n\r\n        return;\r\n    };\r\n\r\nconst addSeqToMediaOverlay = (\r\n    smil: SMIL, publication: Publication,\r\n    rootMO: MediaOverlayNode, mo: MediaOverlayNode[], seqChild: SeqOrPar) => {\r\n\r\n    const moc = new MediaOverlayNode();\r\n    moc.initialized = rootMO.initialized;\r\n    mo.push(moc);\r\n\r\n    if (seqChild instanceof Seq) {\r\n        moc.Role = [];\r\n        moc.Role.push(\"section\");\r\n\r\n        const seq = seqChild as Seq;\r\n\r\n        if (seq.EpubType) {\r\n            seq.EpubType.trim().split(\" \").forEach((role) => {\r\n                if (!role.length) {\r\n                    return;\r\n                }\r\n                if (moc.Role.indexOf(role) < 0) {\r\n                    moc.Role.push(role);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (seq.TextRef) {\r\n            const zipPath = path.join(path.dirname(smil.ZipPath), seq.TextRef)\r\n                .replace(/\\\\/g, \"/\");\r\n            moc.Text = zipPath;\r\n        }\r\n\r\n        if (seq.Children && seq.Children.length) {\r\n            seq.Children.forEach((child) => {\r\n                if (!moc.Children) {\r\n                    moc.Children = [];\r\n                }\r\n                addSeqToMediaOverlay(smil, publication, rootMO, moc.Children, child);\r\n            });\r\n        }\r\n    } else { // Par\r\n        const par = seqChild as Par;\r\n\r\n        if (par.EpubType) {\r\n            par.EpubType.trim().split(\" \").forEach((role) => {\r\n                if (!role.length) {\r\n                    return;\r\n                }\r\n                if (!moc.Role) {\r\n                    moc.Role = [];\r\n                }\r\n                if (moc.Role.indexOf(role) < 0) {\r\n                    moc.Role.push(role);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (par.Text && par.Text.Src) {\r\n            const zipPath = path.join(path.dirname(smil.ZipPath), par.Text.Src)\r\n                .replace(/\\\\/g, \"/\");\r\n            moc.Text = zipPath;\r\n        }\r\n        if (par.Audio && par.Audio.Src) {\r\n            const zipPath = path.join(path.dirname(smil.ZipPath), par.Audio.Src)\r\n                .replace(/\\\\/g, \"/\");\r\n            moc.Audio = zipPath;\r\n            moc.Audio += \"#t=\";\r\n            moc.Audio += par.Audio.ClipBegin ? timeStrToSeconds(par.Audio.ClipBegin) : \"0\";\r\n            if (par.Audio.ClipEnd) {\r\n                moc.Audio += \",\";\r\n                moc.Audio += timeStrToSeconds(par.Audio.ClipEnd);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nconst fillPublicationDate = (publication: Publication, rootfile: Rootfile, opf: OPF) => {\r\n\r\n    if (opf.Metadata && opf.Metadata.Date && opf.Metadata.Date.length) {\r\n\r\n        if (isEpub3OrMore(rootfile, opf) && opf.Metadata.Date[0] && opf.Metadata.Date[0].Data) {\r\n            publication.Metadata.PublicationDate = moment(opf.Metadata.Date[0].Data).toDate();\r\n            return;\r\n        }\r\n\r\n        opf.Metadata.Date.forEach((date) => {\r\n            if (date.Data && date.Event && date.Event.indexOf(\"publication\") >= 0) {\r\n                publication.Metadata.PublicationDate = moment(date.Data).toDate();\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nconst findContributorInMeta = (publication: Publication, rootfile: Rootfile, opf: OPF) => {\r\n\r\n    if (opf.Metadata && opf.Metadata.Meta) {\r\n        opf.Metadata.Meta.forEach((meta) => {\r\n            if (meta.Property === \"dcterms:creator\" || meta.Property === \"dcterms:contributor\") {\r\n                const cont = new Author();\r\n                cont.Data = meta.Data;\r\n                cont.ID = meta.ID;\r\n                addContributor(publication, rootfile, opf, cont, undefined);\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nconst addContributor = (\r\n    publication: Publication, rootfile: Rootfile, opf: OPF, cont: Author, forcedRole: string | undefined) => {\r\n\r\n    const contributor = new Contributor();\r\n    let role: string | undefined;\r\n\r\n    // const epubVersion = getEpubVersion(rootfile, opf);\r\n\r\n    if (isEpub3OrMore(rootfile, opf)) {\r\n\r\n        const meta = findMetaByRefineAndProperty(rootfile, opf, cont.ID, \"role\");\r\n        if (meta && meta.Property === \"role\") {\r\n            role = meta.Data;\r\n        }\r\n        if (!role && forcedRole) {\r\n            role = forcedRole;\r\n        }\r\n\r\n        const metaAlt = findAllMetaByRefineAndProperty(rootfile, opf, cont.ID, \"alternate-script\");\r\n        if (metaAlt && metaAlt.length) {\r\n            contributor.Name = {} as IStringMap;\r\n\r\n            if (publication.Metadata &&\r\n                publication.Metadata.Language &&\r\n                publication.Metadata.Language.length) {\r\n\r\n                contributor.Name[publication.Metadata.Language[0].toLowerCase()] = cont.Data;\r\n            }\r\n\r\n            metaAlt.forEach((m) => {\r\n                if (m.Lang) {\r\n                    (contributor.Name as IStringMap)[m.Lang] = m.Data;\r\n                }\r\n            });\r\n        } else {\r\n            contributor.Name = cont.Data;\r\n        }\r\n    } else {\r\n        contributor.Name = cont.Data;\r\n        role = cont.Role;\r\n        if (!role && forcedRole) {\r\n            role = forcedRole;\r\n        }\r\n    }\r\n\r\n    if (role) {\r\n        switch (role) {\r\n            case \"aut\": {\r\n                if (!publication.Metadata.Author) {\r\n                    publication.Metadata.Author = [];\r\n                }\r\n                publication.Metadata.Author.push(contributor);\r\n                break;\r\n            }\r\n            case \"trl\": {\r\n                if (!publication.Metadata.Translator) {\r\n                    publication.Metadata.Translator = [];\r\n                }\r\n                publication.Metadata.Translator.push(contributor);\r\n                break;\r\n            }\r\n            case \"art\": {\r\n                if (!publication.Metadata.Artist) {\r\n                    publication.Metadata.Artist = [];\r\n                }\r\n                publication.Metadata.Artist.push(contributor);\r\n                break;\r\n            }\r\n            case \"edt\": {\r\n                if (!publication.Metadata.Editor) {\r\n                    publication.Metadata.Editor = [];\r\n                }\r\n                publication.Metadata.Editor.push(contributor);\r\n                break;\r\n            }\r\n            case \"ill\": {\r\n                if (!publication.Metadata.Illustrator) {\r\n                    publication.Metadata.Illustrator = [];\r\n                }\r\n                publication.Metadata.Illustrator.push(contributor);\r\n                break;\r\n            }\r\n            case \"ltr\": {\r\n                if (!publication.Metadata.Letterer) {\r\n                    publication.Metadata.Letterer = [];\r\n                }\r\n                publication.Metadata.Letterer.push(contributor);\r\n                break;\r\n            }\r\n            case \"pen\": {\r\n                if (!publication.Metadata.Penciler) {\r\n                    publication.Metadata.Penciler = [];\r\n                }\r\n                publication.Metadata.Penciler.push(contributor);\r\n                break;\r\n            }\r\n            case \"clr\": {\r\n                if (!publication.Metadata.Colorist) {\r\n                    publication.Metadata.Colorist = [];\r\n                }\r\n                publication.Metadata.Colorist.push(contributor);\r\n                break;\r\n            }\r\n            case \"ink\": {\r\n                if (!publication.Metadata.Inker) {\r\n                    publication.Metadata.Inker = [];\r\n                }\r\n                publication.Metadata.Inker.push(contributor);\r\n                break;\r\n            }\r\n            case \"nrt\": {\r\n                if (!publication.Metadata.Narrator) {\r\n                    publication.Metadata.Narrator = [];\r\n                }\r\n                publication.Metadata.Narrator.push(contributor);\r\n                break;\r\n            }\r\n            case \"pbl\": {\r\n                if (!publication.Metadata.Publisher) {\r\n                    publication.Metadata.Publisher = [];\r\n                }\r\n                publication.Metadata.Publisher.push(contributor);\r\n                break;\r\n            }\r\n            default: {\r\n                contributor.Role = role;\r\n\r\n                if (!publication.Metadata.Contributor) {\r\n                    publication.Metadata.Contributor = [];\r\n                }\r\n                publication.Metadata.Contributor.push(contributor);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nconst addIdentifier = (publication: Publication, _rootfile: Rootfile, opf: OPF) => {\r\n    if (opf.Metadata && opf.Metadata.Identifier) {\r\n        if (opf.UniqueIdentifier && opf.Metadata.Identifier.length > 1) {\r\n            opf.Metadata.Identifier.forEach((iden) => {\r\n                if (iden.ID === opf.UniqueIdentifier) {\r\n                    publication.Metadata.Identifier = iden.Data;\r\n                }\r\n            });\r\n        } else if (opf.Metadata.Identifier.length > 0) {\r\n            publication.Metadata.Identifier = opf.Metadata.Identifier[0].Data;\r\n        }\r\n    }\r\n};\r\n\r\nconst addTitle = (publication: Publication, rootfile: Rootfile, opf: OPF) => {\r\n\r\n    if (isEpub3OrMore(rootfile, opf)) {\r\n        let mainTitle: Title | undefined;\r\n\r\n        if (opf.Metadata &&\r\n            opf.Metadata.Title &&\r\n            opf.Metadata.Title.length) {\r\n\r\n            if (opf.Metadata.Meta) {\r\n                const tt = opf.Metadata.Title.find((title) => {\r\n                    const refineID = \"#\" + title.ID;\r\n\r\n                    const m = opf.Metadata.Meta.find((meta) => {\r\n                        if (meta.Data === \"main\" && meta.Refine === refineID) {\r\n                            return true;\r\n                        }\r\n                        return false;\r\n                    });\r\n                    if (m) {\r\n                        return true;\r\n                    }\r\n                    return false;\r\n                });\r\n                if (tt) {\r\n                    mainTitle = tt;\r\n                }\r\n            }\r\n\r\n            if (!mainTitle) {\r\n                mainTitle = opf.Metadata.Title[0];\r\n            }\r\n        }\r\n\r\n        if (mainTitle) {\r\n            const metaAlt = findAllMetaByRefineAndProperty(rootfile, opf, mainTitle.ID, \"alternate-script\");\r\n            if (metaAlt && metaAlt.length) {\r\n                publication.Metadata.Title = {} as IStringMap;\r\n\r\n                if (mainTitle.Lang) {\r\n                    publication.Metadata.Title[mainTitle.Lang.toLowerCase()] = mainTitle.Data;\r\n                }\r\n\r\n                metaAlt.forEach((m) => {\r\n                    if (m.Lang) {\r\n                        (publication.Metadata.Title as IStringMap)[m.Lang.toLowerCase()] = m.Data;\r\n                    }\r\n                });\r\n            } else {\r\n                publication.Metadata.Title = mainTitle.Data;\r\n            }\r\n        }\r\n\r\n    } else {\r\n        if (opf.Metadata &&\r\n            opf.Metadata.Title &&\r\n            opf.Metadata.Title.length) {\r\n\r\n            publication.Metadata.Title = opf.Metadata.Title[0].Data;\r\n        }\r\n    }\r\n};\r\n\r\nconst addRelAndPropertiesToLink =\r\n    async (publication: Publication, link: Link, linkEpub: Manifest, rootfile: Rootfile, opf: OPF) => {\r\n\r\n        if (linkEpub.Properties) {\r\n            await addToLinkFromProperties(publication, link, linkEpub.Properties);\r\n        }\r\n        const spineProperties = findPropertiesInSpineForManifest(linkEpub, rootfile, opf);\r\n        if (spineProperties) {\r\n            await addToLinkFromProperties(publication, link, spineProperties);\r\n        }\r\n    };\r\n\r\nconst addToLinkFromProperties = async (publication: Publication, link: Link, propertiesString: string) => {\r\n\r\n    const properties = propertiesString.trim().split(\" \");\r\n\r\n    const propertiesStruct = new Properties();\r\n\r\n    // https://idpf.github.io/epub-vocabs/rendition/\r\n\r\n    // no forEach(), because of await/async within the iteration body\r\n    // properties.forEach(async (p) => {\r\n    for (const p of properties) {\r\n        switch (p) {\r\n            case \"cover-image\": {\r\n                link.AddRel(\"cover\");\r\n                await addCoverDimensions(publication, link);\r\n                break;\r\n            }\r\n            case \"nav\": {\r\n                link.AddRel(\"contents\");\r\n                break;\r\n            }\r\n            case \"scripted\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"js\");\r\n                break;\r\n            }\r\n            case \"mathml\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"mathml\");\r\n                break;\r\n            }\r\n            case \"onix-record\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"onix\");\r\n                break;\r\n            }\r\n            case \"svg\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"svg\");\r\n                break;\r\n            }\r\n            case \"xmp-record\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"xmp\");\r\n                break;\r\n            }\r\n            case \"remote-resources\": {\r\n                if (!propertiesStruct.Contains) {\r\n                    propertiesStruct.Contains = [];\r\n                }\r\n                propertiesStruct.Contains.push(\"remote-resources\");\r\n                break;\r\n            }\r\n            case \"page-spread-left\": {\r\n                propertiesStruct.Page = \"left\";\r\n                break;\r\n            }\r\n            case \"page-spread-right\": {\r\n                propertiesStruct.Page = \"right\";\r\n                break;\r\n            }\r\n            case \"page-spread-center\": {\r\n                propertiesStruct.Page = \"center\";\r\n                break;\r\n            }\r\n            case \"rendition:spread-none\": {\r\n                propertiesStruct.Spread = noneMeta;\r\n                break;\r\n            }\r\n            case \"rendition:spread-auto\": {\r\n                propertiesStruct.Spread = autoMeta;\r\n                break;\r\n            }\r\n            case \"rendition:spread-landscape\": {\r\n                propertiesStruct.Spread = \"landscape\";\r\n                break;\r\n            }\r\n            case \"rendition:spread-portrait\": {\r\n                propertiesStruct.Spread = \"portrait\";\r\n                break;\r\n            }\r\n            case \"rendition:spread-both\": {\r\n                propertiesStruct.Spread = \"both\";\r\n                break;\r\n            }\r\n            case \"rendition:layout-reflowable\": {\r\n                propertiesStruct.Layout = reflowableMeta;\r\n                break;\r\n            }\r\n            case \"rendition:layout-pre-paginated\": {\r\n                propertiesStruct.Layout = \"fixed\";\r\n                break;\r\n            }\r\n            case \"rendition:orientation-auto\": {\r\n                propertiesStruct.Orientation = \"auto\";\r\n                break;\r\n            }\r\n            case \"rendition:orientation-landscape\": {\r\n                propertiesStruct.Orientation = \"landscape\";\r\n                break;\r\n            }\r\n            case \"rendition:orientation-portrait\": {\r\n                propertiesStruct.Orientation = \"portrait\";\r\n                break;\r\n            }\r\n            case \"rendition:flow-auto\": {\r\n                propertiesStruct.Overflow = autoMeta;\r\n                break;\r\n            }\r\n            case \"rendition:flow-paginated\": {\r\n                propertiesStruct.Overflow = \"paginated\";\r\n                break;\r\n            }\r\n            case \"rendition:flow-scrolled-continuous\": {\r\n                propertiesStruct.Overflow = \"scrolled-continuous\";\r\n                break;\r\n            }\r\n            case \"rendition:flow-scrolled-doc\": {\r\n                propertiesStruct.Overflow = \"scrolled\";\r\n                break;\r\n            }\r\n            default: {\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (propertiesStruct.Layout ||\r\n            propertiesStruct.Orientation ||\r\n            propertiesStruct.Overflow ||\r\n            propertiesStruct.Page ||\r\n            propertiesStruct.Spread ||\r\n            (propertiesStruct.Contains && propertiesStruct.Contains.length)) {\r\n\r\n            link.Properties = propertiesStruct;\r\n        }\r\n    }\r\n};\r\n\r\nconst addMediaOverlay = (link: Link, linkEpub: Manifest, rootfile: Rootfile, opf: OPF) => {\r\n    if (linkEpub.MediaOverlay) {\r\n        const meta = findMetaByRefineAndProperty(rootfile, opf, linkEpub.MediaOverlay, \"media:duration\");\r\n        if (meta) {\r\n            link.Duration = timeStrToSeconds(meta.Data);\r\n        }\r\n    }\r\n};\r\n\r\nconst findInManifestByID =\r\n    async (publication: Publication, rootfile: Rootfile, opf: OPF, ID: string): Promise<Link> => {\r\n\r\n        if (opf.Manifest && opf.Manifest.length) {\r\n            const item = opf.Manifest.find((manItem) => {\r\n                if (manItem.ID === ID) {\r\n                    return true;\r\n                }\r\n                return false;\r\n            });\r\n            if (item) {\r\n                const linkItem = new Link();\r\n                linkItem.TypeLink = item.MediaType;\r\n                const zipPath = path.join(path.dirname(opf.ZipPath), item.Href)\r\n                    .replace(/\\\\/g, \"/\");\r\n                linkItem.Href = zipPath;\r\n                await addRelAndPropertiesToLink(publication, linkItem, item, rootfile, opf);\r\n                addMediaOverlay(linkItem, item, rootfile, opf);\r\n                return linkItem;\r\n            }\r\n        }\r\n        return Promise.reject(`${ID} not found`);\r\n    };\r\n\r\nconst addRendition = (publication: Publication, _rootfile: Rootfile, opf: OPF) => {\r\n\r\n    if (opf.Metadata && opf.Metadata.Meta && opf.Metadata.Meta.length) {\r\n        const rendition = new Properties();\r\n\r\n        opf.Metadata.Meta.forEach((meta) => {\r\n            switch (meta.Property) {\r\n                case \"rendition:layout\": {\r\n                    if (meta.Data === \"pre-paginated\") {\r\n                        rendition.Layout = \"fixed\";\r\n                    } else if (meta.Data === \"reflowable\") {\r\n                        rendition.Layout = \"reflowable\";\r\n                    }\r\n                    break;\r\n                }\r\n                case \"rendition:orientation\": {\r\n                    rendition.Orientation = meta.Data;\r\n                    break;\r\n                }\r\n                case \"rendition:spread\": {\r\n                    rendition.Spread = meta.Data;\r\n                    break;\r\n                }\r\n                case \"rendition:flow\": {\r\n                    rendition.Overflow = meta.Data;\r\n                    break;\r\n                }\r\n                default: {\r\n                    break;\r\n                }\r\n            }\r\n        });\r\n\r\n        if (rendition.Layout || rendition.Orientation || rendition.Overflow || rendition.Page || rendition.Spread) {\r\n            publication.Metadata.Rendition = rendition;\r\n        }\r\n    }\r\n};\r\n\r\nconst fillSpineAndResource = async (publication: Publication, rootfile: Rootfile, opf: OPF) => {\r\n\r\n    if (opf.Spine && opf.Spine.Items && opf.Spine.Items.length) {\r\n        // no forEach(), because of await/async within the iteration body\r\n        // opf.Spine.Items.forEach(async (item) => {\r\n        for (const item of opf.Spine.Items) {\r\n\r\n            if (!item.Linear || item.Linear === \"yes\") {\r\n\r\n                let linkItem: Link;\r\n                try {\r\n                    linkItem = await findInManifestByID(publication, rootfile, opf, item.IDref);\r\n                } catch (err) {\r\n                    debug(err);\r\n                    continue;\r\n                }\r\n\r\n                if (linkItem && linkItem.Href) {\r\n                    if (!publication.Spine) {\r\n                        publication.Spine = [];\r\n                    }\r\n                    publication.Spine.push(linkItem);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (opf.Manifest && opf.Manifest.length) {\r\n\r\n        // no forEach(), because of await/async within the iteration body\r\n        // opf.Manifest.forEach(async (item) => {\r\n        for (const item of opf.Manifest) {\r\n\r\n            const zipPath = path.join(path.dirname(opf.ZipPath), item.Href)\r\n                .replace(/\\\\/g, \"/\");\r\n            const linkSpine = findInSpineByHref(publication, zipPath);\r\n            if (!linkSpine || !linkSpine.Href) {\r\n\r\n                const linkItem = new Link();\r\n                linkItem.TypeLink = item.MediaType;\r\n                linkItem.Href = zipPath;\r\n                await addRelAndPropertiesToLink(publication, linkItem, item, rootfile, opf);\r\n                addMediaOverlay(linkItem, item, rootfile, opf);\r\n\r\n                if (!publication.Resources) {\r\n                    publication.Resources = [];\r\n                }\r\n                publication.Resources.push(linkItem);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nconst fillEncryptionInfo =\r\n    (publication: Publication, _rootfile: Rootfile, _opf: OPF, encryption: Encryption, lcp: LCP | undefined) => {\r\n\r\n        encryption.EncryptedData.forEach((encInfo) => {\r\n            const encrypted = new Encrypted();\r\n            encrypted.Algorithm = encInfo.EncryptionMethod.Algorithm;\r\n\r\n            if (lcp &&\r\n                encrypted.Algorithm !== \"http://www.idpf.org/2008/embedding\" &&\r\n                encrypted.Algorithm !== \"http://ns.adobe.com/pdf/enc#RC\") {\r\n                encrypted.Profile = lcp.Encryption.Profile;\r\n                encrypted.Scheme = \"http://readium.org/2014/01/lcp\";\r\n            }\r\n            if (encInfo.EncryptionProperties && encInfo.EncryptionProperties.length) {\r\n\r\n                encInfo.EncryptionProperties.forEach((prop) => {\r\n\r\n                    if (prop.Compression) {\r\n                        if (prop.Compression.OriginalLength) {\r\n                            encrypted.OriginalLength = parseFloat(prop.Compression.OriginalLength);\r\n                        }\r\n                        if (prop.Compression.Method === \"8\") {\r\n                            encrypted.Compression = \"deflate\";\r\n                        } else {\r\n                            encrypted.Compression = \"none\";\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            publication.Resources.forEach((l, _i, _arr) => {\r\n\r\n                const filePath = l.Href;\r\n                if (filePath === encInfo.CipherData.CipherReference.URI) {\r\n                    if (!l.Properties) {\r\n                        l.Properties = new Properties();\r\n                    }\r\n                    l.Properties.Encrypted = encrypted;\r\n                }\r\n            });\r\n\r\n            publication.Spine.forEach((l, _i, _arr) => {\r\n                const filePath = l.Href;\r\n                if (filePath === encInfo.CipherData.CipherReference.URI) {\r\n                    if (!l.Properties) {\r\n                        l.Properties = new Properties();\r\n                    }\r\n                    l.Properties.Encrypted = encrypted;\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\nconst fillPageListFromNCX = (publication: Publication, _rootfile: Rootfile, _opf: OPF, ncx: NCX) => {\r\n    if (ncx.PageList && ncx.PageList.PageTarget && ncx.PageList.PageTarget.length) {\r\n        ncx.PageList.PageTarget.forEach((pageTarget) => {\r\n            const link = new Link();\r\n            const zipPath = path.join(path.dirname(ncx.ZipPath), pageTarget.Content.Src)\r\n                .replace(/\\\\/g, \"/\");\r\n            link.Href = zipPath;\r\n            link.Title = pageTarget.Text;\r\n            if (!publication.PageList) {\r\n                publication.PageList = [];\r\n            }\r\n            publication.PageList.push(link);\r\n        });\r\n    }\r\n};\r\n\r\nconst fillTOCFromNCX = (publication: Publication, rootfile: Rootfile, opf: OPF, ncx: NCX) => {\r\n    if (ncx.Points && ncx.Points.length) {\r\n        ncx.Points.forEach((point) => {\r\n            if (!publication.TOC) {\r\n                publication.TOC = [];\r\n            }\r\n            fillTOCFromNavPoint(publication, rootfile, opf, ncx, point, publication.TOC);\r\n        });\r\n    }\r\n};\r\n\r\nconst fillLandmarksFromGuide = (publication: Publication, _rootfile: Rootfile, opf: OPF) => {\r\n    if (opf.Guide && opf.Guide.length) {\r\n        opf.Guide.forEach((ref) => {\r\n            if (ref.Href) {\r\n                const link = new Link();\r\n                const zipPath = path.join(path.dirname(opf.ZipPath), ref.Href)\r\n                    .replace(/\\\\/g, \"/\");\r\n                link.Href = zipPath;\r\n                link.Title = ref.Title;\r\n                if (!publication.Landmarks) {\r\n                    publication.Landmarks = [];\r\n                }\r\n                publication.Landmarks.push(link);\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nconst fillTOCFromNavPoint =\r\n    (publication: Publication, rootfile: Rootfile, opf: OPF, ncx: NCX, point: NavPoint, node: Link[]) => {\r\n\r\n        const link = new Link();\r\n        const zipPath = path.join(path.dirname(ncx.ZipPath), point.Content.Src)\r\n            .replace(/\\\\/g, \"/\");\r\n        link.Href = zipPath;\r\n        link.Title = point.Text;\r\n\r\n        if (point.Points && point.Points.length) {\r\n            point.Points.forEach((p) => {\r\n                if (!link.Children) {\r\n                    link.Children = [];\r\n                }\r\n                fillTOCFromNavPoint(publication, rootfile, opf, ncx, p, link.Children);\r\n            });\r\n        }\r\n\r\n        node.push(link);\r\n    };\r\n\r\nconst fillSubject = (publication: Publication, _rootfile: Rootfile, opf: OPF) => {\r\n    if (opf.Metadata && opf.Metadata.Subject && opf.Metadata.Subject.length) {\r\n        opf.Metadata.Subject.forEach((s) => {\r\n            const sub = new Subject();\r\n            sub.Name = s.Data;\r\n            sub.Code = s.Term;\r\n            sub.Scheme = s.Authority;\r\n            if (!publication.Metadata.Subject) {\r\n                publication.Metadata.Subject = [];\r\n            }\r\n            publication.Metadata.Subject.push(sub);\r\n        });\r\n    }\r\n};\r\n\r\nconst fillCalibreSerieInfo = (publication: Publication, _rootfile: Rootfile, opf: OPF) => {\r\n    let serie: string | undefined;\r\n    let seriePosition: number | undefined;\r\n\r\n    if (opf.Metadata && opf.Metadata.Meta && opf.Metadata.Meta.length) {\r\n        opf.Metadata.Meta.forEach((m) => {\r\n            if (m.Name === \"calibre:series\") {\r\n                serie = m.Content;\r\n            }\r\n            if (m.Name === \"calibre:series_index\") {\r\n                seriePosition = parseFloat(m.Content);\r\n            }\r\n        });\r\n    }\r\n\r\n    if (serie) {\r\n        const collection = new Collection();\r\n        collection.Name = serie;\r\n        if (seriePosition) {\r\n            collection.Position = seriePosition;\r\n        }\r\n        if (!publication.Metadata.BelongsTo) {\r\n            publication.Metadata.BelongsTo = new BelongsTo();\r\n        }\r\n        if (!publication.Metadata.BelongsTo.Series) {\r\n            publication.Metadata.BelongsTo.Series = [];\r\n        }\r\n        publication.Metadata.BelongsTo.Series.push(collection);\r\n    }\r\n};\r\n\r\nconst fillTOCFromNavDoc = async (publication: Publication, _rootfile: Rootfile, _opf: OPF, zip: IZip):\r\n    Promise<void> => {\r\n\r\n    const navLink = publication.GetNavDoc();\r\n    if (!navLink) {\r\n        return;\r\n    }\r\n\r\n    const navDocFilePath = navLink.Href;\r\n    if (!zip.hasEntry(navDocFilePath)) {\r\n        return;\r\n    }\r\n\r\n    let navDocZipStream_: IStreamAndLength;\r\n    try {\r\n        navDocZipStream_ = await zip.entryStreamPromise(navDocFilePath);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n    const navDocZipStream = navDocZipStream_.stream;\r\n\r\n    let navDocZipData: Buffer;\r\n    try {\r\n        navDocZipData = await streamToBufferPromise(navDocZipStream);\r\n    } catch (err) {\r\n        debug(err);\r\n        return Promise.reject(err);\r\n    }\r\n\r\n    const navDocStr = navDocZipData.toString(\"utf8\");\r\n    const navXmlDoc = new xmldom.DOMParser().parseFromString(navDocStr);\r\n\r\n    const select = xpath.useNamespaces({\r\n        epub: \"http://www.idpf.org/2007/ops\",\r\n        xhtml: \"http://www.w3.org/1999/xhtml\",\r\n    });\r\n\r\n    const navs = select(\"/xhtml:html/xhtml:body//xhtml:nav\", navXmlDoc) as Element[];\r\n    if (navs && navs.length) {\r\n\r\n        navs.forEach((navElement: Element) => {\r\n\r\n            const typeNav = select(\"@epub:type\", navElement);\r\n            if (typeNav && typeNav.length) {\r\n\r\n                const olElem = select(\"xhtml:ol\", navElement) as Element[];\r\n\r\n                const roles = (typeNav[0] as Attr).value;\r\n                const role = roles.trim().split(\" \")[0]; // TODO assumes only single epub:type in space-separated value?\r\n                switch (role) {\r\n\r\n                    case \"toc\": {\r\n                        publication.TOC = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.TOC, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"page-list\": {\r\n                        publication.PageList = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.PageList, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"landmarks\": {\r\n                        publication.Landmarks = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.Landmarks, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"lot\": {\r\n                        publication.LOT = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.LOT, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"loa\": {\r\n                        publication.LOA = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.LOA, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"loi\": {\r\n                        publication.LOI = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.LOI, navLink.Href);\r\n                        break;\r\n                    }\r\n                    case \"lov\": {\r\n                        publication.LOV = [];\r\n                        fillTOCFromNavDocWithOL(select, olElem, publication.LOV, navLink.Href);\r\n                        break;\r\n                    }\r\n                    default: {\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nconst fillTOCFromNavDocWithOL = (select: any, olElems: Element[], node: Link[], navDocPath: string) => {\r\n\r\n    olElems.forEach((olElem: Element) => {\r\n\r\n        const liElems = select(\"xhtml:li\", olElem);\r\n        if (liElems && liElems.length) {\r\n\r\n            liElems.forEach((liElem: Element) => {\r\n\r\n                const link = new Link();\r\n                node.push(link);\r\n\r\n                const aElems = select(\"xhtml:a\", liElem);\r\n                if (aElems && aElems.length > 0) {\r\n\r\n                    const aHref = select(\"@href\", aElems[0]);\r\n                    if (aHref && aHref.length) {\r\n                        let val = (aHref[0] as Attr).value;\r\n                        if (val[0] === \"#\") {\r\n                            val = path.basename(navDocPath) + val;\r\n                        }\r\n\r\n                        const zipPath = path.join(path.dirname(navDocPath), val)\r\n                            .replace(/\\\\/g, \"/\");\r\n                        link.Href = zipPath;\r\n                    }\r\n\r\n                    let aText = aElems[0].textContent; // select(\"text()\", aElems[0])[0].data;\r\n                    if (aText && aText.length) {\r\n                        aText = aText.trim();\r\n                        aText = aText.replace(/\\s\\s+/g, \" \");\r\n                        link.Title = aText;\r\n                    }\r\n                } else {\r\n                    const liFirstChild = select(\"xhtml:*[1]\", liElem);\r\n                    if (liFirstChild && liFirstChild.length && liFirstChild[0].textContent) {\r\n                        link.Title = liFirstChild[0].textContent.trim();\r\n                    }\r\n                }\r\n\r\n                const olElemsNext = select(\"xhtml:ol\", liElem);\r\n                if (olElemsNext && olElemsNext.length) {\r\n                    if (!link.Children) {\r\n                        link.Children = [];\r\n                    }\r\n                    fillTOCFromNavDocWithOL(select, olElemsNext, link.Children, navDocPath);\r\n                }\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\nconst addCoverRel = async (publication: Publication, rootfile: Rootfile, opf: OPF) => {\r\n\r\n    let coverID: string | undefined;\r\n\r\n    if (opf.Metadata && opf.Metadata.Meta && opf.Metadata.Meta.length) {\r\n        opf.Metadata.Meta.find((meta) => {\r\n            if (meta.Name === \"cover\") {\r\n                coverID = meta.Content;\r\n                return true;\r\n            }\r\n            return false;\r\n        });\r\n    }\r\n\r\n    if (coverID) {\r\n        let manifestInfo: Link;\r\n        try {\r\n            manifestInfo = await findInManifestByID(publication, rootfile, opf, coverID);\r\n        } catch (err) {\r\n            debug(err);\r\n            return;\r\n        }\r\n        if (manifestInfo && manifestInfo.Href && publication.Resources && publication.Resources.length) {\r\n\r\n            const href = manifestInfo.Href;\r\n            const linky = publication.Resources.find((item, _i, _arr) => {\r\n                if (item.Href === href) {\r\n                    return true;\r\n                }\r\n                return false;\r\n            });\r\n            if (linky) { // publication.Resources[i]\r\n                linky.AddRel(\"cover\");\r\n                await addCoverDimensions(publication, linky);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nconst findPropertiesInSpineForManifest = (linkEpub: Manifest, _rootfile: Rootfile, opf: OPF): string | undefined => {\r\n\r\n    if (opf.Spine && opf.Spine.Items && opf.Spine.Items.length) {\r\n        const it = opf.Spine.Items.find((item) => {\r\n            if (item.IDref === linkEpub.ID) {\r\n                return true;\r\n            }\r\n            return false;\r\n        });\r\n        if (it && it.Properties) {\r\n            return it.Properties;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n};\r\n\r\nconst findInSpineByHref = (publication: Publication, href: string): Link | undefined => {\r\n\r\n    if (publication.Spine && publication.Spine.length) {\r\n        const ll = publication.Spine.find((l) => {\r\n            if (l.Href === href) {\r\n                return true;\r\n            }\r\n            return false;\r\n        });\r\n        if (ll) {\r\n            return ll;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n};\r\n\r\nconst findMetaByRefineAndProperty = (\r\n    rootfile: Rootfile, opf: OPF, ID: string, property: string): Metafield | undefined => {\r\n\r\n    const ret = findAllMetaByRefineAndProperty(rootfile, opf, ID, property);\r\n    if (ret.length) {\r\n        return ret[0];\r\n    }\r\n    return undefined;\r\n};\r\n\r\nconst findAllMetaByRefineAndProperty = (_rootfile: Rootfile, opf: OPF, ID: string, property: string): Metafield[] => {\r\n    const metas: Metafield[] = [];\r\n\r\n    const refineID = \"#\" + ID;\r\n\r\n    if (opf.Metadata && opf.Metadata.Meta) {\r\n        opf.Metadata.Meta.forEach((metaTag) => {\r\n            if (metaTag.Refine === refineID && metaTag.Property === property) {\r\n                metas.push(metaTag);\r\n            }\r\n        });\r\n    }\r\n\r\n    return metas;\r\n};\r\n\r\nconst getEpubVersion = (rootfile: Rootfile, opf: OPF): string | undefined => {\r\n\r\n    if (rootfile.Version) {\r\n        return rootfile.Version;\r\n    } else if (opf.Version) {\r\n        return opf.Version;\r\n    }\r\n\r\n    return undefined;\r\n};\r\n\r\nconst isEpub3OrMore = (rootfile: Rootfile, opf: OPF): boolean => {\r\n\r\n    const version = getEpubVersion(rootfile, opf);\r\n    return (version === epub3 || version === epub301 || version === epub31);\r\n};\r\n\r\nconst findLinKByHref = (publication: Publication, _rootfile: Rootfile, _opf: OPF, href: string): Link | undefined => {\r\n    if (publication.Spine && publication.Spine.length) {\r\n        const ll = publication.Spine.find((l) => {\r\n            const pathInZip = l.Href;\r\n\r\n            if (href === pathInZip) {\r\n                return true;\r\n            }\r\n            return false;\r\n        });\r\n        if (ll) {\r\n            return ll;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n};\r\n"]}