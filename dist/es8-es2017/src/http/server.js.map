{"version":3,"file":"server.js","sourceRoot":"","sources":["../../../../src/http/server.ts"],"names":[],"mappings":"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","sourcesContent":["import * as child_process from \"child_process\";\r\nimport * as crypto from \"crypto\";\r\nimport * as fs from \"fs\";\r\nimport * as http from \"http\";\r\nimport * as path from \"path\";\r\n\r\nimport { Publication } from \"@models/publication\";\r\nimport { OPDSFeed } from \"@opds/opds2/opds2\";\r\nimport { encodeURIComponent_RFC3986, isHTTP } from \"@utils/http/UrlUtils\";\r\nimport * as css2json from \"css2json\";\r\nimport * as debug_ from \"debug\";\r\nimport * as express from \"express\";\r\nimport * as jsonMarkup from \"json-markup\";\r\nimport { JSON as TAJSON } from \"ta-json\";\r\nimport { tmpNameSync } from \"tmp\";\r\n\r\nimport { PublicationParsePromise } from \"@parser/publication-parser\";\r\nimport { serverAssets } from \"./server-assets\";\r\nimport { serverManifestJson } from \"./server-manifestjson\";\r\nimport { serverMediaOverlays } from \"./server-mediaoverlays\";\r\nimport { serverOPDS } from \"./server-opds\";\r\nimport { serverOPDS12 } from \"./server-opds1-2\";\r\nimport { serverOPDS2 } from \"./server-opds2\";\r\nimport { serverPub } from \"./server-pub\";\r\nimport { serverUrl } from \"./server-url\";\r\n\r\nconst debug = debug_(\"r2:server:main\");\r\n\r\ninterface IPathPublicationMap { [key: string]: any; }\r\n\r\n// https://github.com/mafintosh/json-markup/blob/master/style.css\r\nconst jsonStyle = `\r\n.json-markup {\r\n    line-height: 17px;\r\n    font-size: 13px;\r\n    font-family: monospace;\r\n    white-space: pre;\r\n}\r\n.json-markup-key {\r\n    font-weight: bold;\r\n}\r\n.json-markup-bool {\r\n    color: firebrick;\r\n}\r\n.json-markup-string {\r\n    color: green;\r\n}\r\n.json-markup-null {\r\n    color: gray;\r\n}\r\n.json-markup-number {\r\n    color: blue;\r\n}\r\n`;\r\n\r\nexport interface IServerOptions {\r\n    disableReaders?: boolean;\r\n    disableDecryption?: boolean; /* excludes obfuscated fonts */\r\n}\r\n\r\nexport class Server {\r\n    public readonly disableReaders: boolean;\r\n    public readonly disableDecryption: boolean;\r\n\r\n    public readonly lcpBeginToken = \"*-\";\r\n    public readonly lcpEndToken = \"-*\";\r\n\r\n    private readonly publications: string[];\r\n    private publicationsOPDSfeed: OPDSFeed | undefined;\r\n    private publicationsOPDSfeedNeedsUpdate: boolean;\r\n    private readonly pathPublicationMap: IPathPublicationMap;\r\n    private creatingPublicationsOPDS: boolean;\r\n    private readonly opdsJsonFilePath: string;\r\n\r\n    private readonly expressApp: express.Application;\r\n    private httpServer: http.Server;\r\n\r\n    private started: boolean;\r\n\r\n    constructor(options?: IServerOptions) {\r\n\r\n        this.disableReaders = options && options.disableReaders ? options.disableReaders : false;\r\n        this.disableDecryption = options && options.disableDecryption ? options.disableDecryption : false;\r\n\r\n        this.publications = [];\r\n        this.pathPublicationMap = {};\r\n        this.publicationsOPDSfeed = undefined;\r\n        this.publicationsOPDSfeedNeedsUpdate = true;\r\n        this.creatingPublicationsOPDS = false;\r\n\r\n        this.opdsJsonFilePath = tmpNameSync({ prefix: \"readium2-OPDS2-\", postfix: \".json\" });\r\n\r\n        this.started = false;\r\n\r\n        this.expressApp = express();\r\n        // this.expressApp.enable('strict routing');\r\n\r\n        // https://expressjs.com/en/4x/api.html#express.static\r\n        const staticOptions = {\r\n            etag: false,\r\n        };\r\n\r\n        if (!this.disableReaders) {\r\n            this.expressApp.use(\"/readerNYPL\", express.static(\"misc/readers/reader-NYPL\", staticOptions));\r\n            this.expressApp.use(\"/readerHADRIEN\", express.static(\"misc/readers/reader-HADRIEN\", staticOptions));\r\n        }\r\n\r\n        this.expressApp.get(\"/\", (_req: express.Request, res: express.Response) => {\r\n\r\n            let html = \"<html><body><h1>Publications</h1>\";\r\n\r\n            this.publications.forEach((pub) => {\r\n                const filePathBase64 = new Buffer(pub).toString(\"base64\");\r\n\r\n                html += \"<p><strong>\"\r\n                    + (isHTTP(pub) ? pub : path.basename(pub))\r\n                    + \"</strong><br> => <a href='./pub/\" + encodeURIComponent_RFC3986(filePathBase64)\r\n                    + \"'>\" + \"./pub/\" + filePathBase64 + \"</a></p>\";\r\n            });\r\n            html += \"<h1>OPDS2 feed</h1><p><a href='./opds2'>CLICK HERE</a></p>\";\r\n            html += \"<h1>Load HTTP publication URL</h1><p><a href='./url'>CLICK HERE</a></p>\";\r\n            html += \"<h1>Browse HTTP OPDS1 feed</h1><p><a href='./opds'>CLICK HERE</a></p>\";\r\n            html += \"<h1>Convert OPDS feed v1 to v2</h1><p><a href='./opds12'>CLICK HERE</a></p>\";\r\n            html += \"<h1>Server version</h1><p><a href='./version/show'>CLICK HERE</a></p>\";\r\n            html += \"</body></html>\";\r\n\r\n            res.status(200).send(html);\r\n        });\r\n\r\n        this.expressApp.get([\"/version\", \"/version/show/:jsonPath?\"],\r\n            (req: express.Request, res: express.Response) => {\r\n\r\n                const isShow = req.url.indexOf(\"/show\") >= 0 || req.query.show;\r\n                if (!req.params.jsonPath && req.query.show) {\r\n                    req.params.jsonPath = req.query.show;\r\n                }\r\n\r\n                const gitRevJson = \"../../../gitrev.json\";\r\n                if (!fs.existsSync(path.resolve(path.join(__dirname, gitRevJson)))) {\r\n\r\n                    const err = \"Missing Git rev JSON! \";\r\n                    debug(err + gitRevJson);\r\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\r\n                        + err + \"</p></body></html>\");\r\n                    return;\r\n                }\r\n\r\n                const jsonObj = require(gitRevJson);\r\n                // debug(jsonObj);\r\n\r\n                if (isShow) {\r\n                    const jsonPretty = jsonMarkup(jsonObj, css2json(jsonStyle));\r\n\r\n                    res.status(200).send(\"<html><body>\" +\r\n                        \"<h1>R2-STREAMER-JS VERSION INFO</h1>\" +\r\n                        \"<hr><p><pre>\" + jsonPretty + \"</pre></p>\" +\r\n                        // \"<hr><p><pre>\" + jsonStr + \"</pre></p>\" +\r\n                        // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\r\n                        \"</body></html>\");\r\n                } else {\r\n                    this.setResponseCORS(res);\r\n                    res.set(\"Content-Type\", \"application/json; charset=utf-8\");\r\n\r\n                    const jsonStr = JSON.stringify(jsonObj, null, \"  \");\r\n\r\n                    const checkSum = crypto.createHash(\"sha256\");\r\n                    checkSum.update(jsonStr);\r\n                    const hash = checkSum.digest(\"hex\");\r\n\r\n                    const match = req.header(\"If-None-Match\");\r\n                    if (match === hash) {\r\n                        debug(\"publications.json cache\");\r\n                        res.status(304); // StatusNotModified\r\n                        res.end();\r\n                        return;\r\n                    }\r\n\r\n                    res.setHeader(\"ETag\", hash);\r\n                    // res.setHeader(\"Cache-Control\", \"public,max-age=86400\");\r\n\r\n                    res.status(200).send(jsonStr);\r\n                }\r\n            });\r\n\r\n        serverUrl(this, this.expressApp);\r\n        serverOPDS(this, this.expressApp);\r\n        serverOPDS2(this, this.expressApp);\r\n        serverOPDS12(this, this.expressApp);\r\n\r\n        const routerPathBase64: express.Router = serverPub(this, this.expressApp);\r\n        serverManifestJson(this, routerPathBase64);\r\n        serverMediaOverlays(this, routerPathBase64);\r\n        serverAssets(this, routerPathBase64);\r\n    }\r\n\r\n    public expressUse(pathf: string, func: express.Handler) {\r\n        this.expressApp.use(pathf, func);\r\n    }\r\n\r\n    public expressGet(paths: string[], func: express.Handler) {\r\n        this.expressApp.get(paths, func);\r\n    }\r\n\r\n    public start(port: number): string {\r\n\r\n        if (this.started) {\r\n            return this.url() as string;\r\n        }\r\n\r\n        const p = port || process.env.PORT || 3000;\r\n        debug(`PORT: ${p} || ${process.env.PORT} || 3000 => ${p}`);\r\n\r\n        this.httpServer = this.expressApp.listen(p, () => {\r\n            debug(`http://localhost:${p}`);\r\n        });\r\n\r\n        this.started = true;\r\n\r\n        return `http://127.0.0.1:${p}`; // this.httpServer.address().port\r\n    }\r\n\r\n    public stop() {\r\n        if (this.started) {\r\n            this.httpServer.close();\r\n            this.started = false;\r\n            this.uncachePublications();\r\n        }\r\n    }\r\n\r\n    public url(): string | undefined {\r\n        return this.started ?\r\n            `http://127.0.0.1:${this.httpServer.address().port}` :\r\n            undefined;\r\n    }\r\n\r\n    public setResponseCORS(res: express.Response) {\r\n        res.setHeader(\"Access-Control-Allow-Origin\",\r\n            \"*\");\r\n\r\n        res.setHeader(\"Access-Control-Allow-Methods\",\r\n            \"GET, HEAD, OPTIONS\"); // POST, DELETE, PUT, PATCH\r\n\r\n        res.setHeader(\"Access-Control-Allow-Headers\",\r\n            \"Content-Type, Content-Length, Accept-Ranges, Link, Transfer-Encoding\");\r\n    }\r\n\r\n    public addPublications(pubs: string[]): string[] {\r\n        pubs.forEach((pub) => {\r\n            if (this.publications.indexOf(pub) < 0) {\r\n                this.publicationsOPDSfeedNeedsUpdate = true;\r\n                this.publications.push(pub);\r\n            }\r\n        });\r\n\r\n        return pubs.map((pub) => {\r\n            const pubid = new Buffer(pub).toString(\"base64\");\r\n            return `/pub/${pubid}/manifest.json`;\r\n        });\r\n    }\r\n\r\n    public removePublications(pubs: string[]): string[] {\r\n        pubs.forEach((pub) => {\r\n            this.uncachePublication(pub);\r\n            const i = this.publications.indexOf(pub);\r\n            if (i >= 0) {\r\n                this.publicationsOPDSfeedNeedsUpdate = true;\r\n                this.publications.splice(i, 1);\r\n            }\r\n        });\r\n\r\n        return pubs.map((pub) => {\r\n            const pubid = new Buffer(pub).toString(\"base64\");\r\n            return `/pub/${pubid}/manifest.json`;\r\n        });\r\n    }\r\n\r\n    public getPublications(): string[] {\r\n        return this.publications;\r\n    }\r\n\r\n    public async loadOrGetCachedPublication(filePath: string): Promise<Publication> {\r\n\r\n        let publication = this.cachedPublication(filePath);\r\n        if (!publication) {\r\n\r\n            // const fileName = path.basename(pathBase64Str);\r\n            // const ext = path.extname(fileName).toLowerCase();\r\n\r\n            try {\r\n                publication = await PublicationParsePromise(filePath);\r\n            } catch (err) {\r\n                debug(err);\r\n                return Promise.reject(err);\r\n            }\r\n\r\n            this.cachePublication(filePath, publication);\r\n        }\r\n        // return Promise.resolve(publication);\r\n        return publication;\r\n    }\r\n\r\n    public isPublicationCached(filePath: string): boolean {\r\n        return typeof this.cachedPublication(filePath) !== \"undefined\";\r\n    }\r\n\r\n    public cachedPublication(filePath: string): Publication | undefined {\r\n        return this.pathPublicationMap[filePath];\r\n    }\r\n\r\n    public cachePublication(filePath: string, pub: Publication) {\r\n        // TODO: implement LRU caching algorithm? Anything smarter than this will do!\r\n        if (!this.isPublicationCached(filePath)) {\r\n            this.pathPublicationMap[filePath] = pub;\r\n        }\r\n    }\r\n\r\n    public uncachePublication(filePath: string) {\r\n        if (this.isPublicationCached(filePath)) {\r\n            const pub = this.cachedPublication(filePath);\r\n            if (pub) {\r\n                pub.freeDestroy();\r\n            }\r\n            this.pathPublicationMap[filePath] = undefined;\r\n            delete this.pathPublicationMap[filePath];\r\n        }\r\n    }\r\n\r\n    public uncachePublications() {\r\n        Object.keys(this.pathPublicationMap).forEach((filePath) => {\r\n            this.uncachePublication(filePath);\r\n        });\r\n    }\r\n\r\n    public publicationsOPDS(): OPDSFeed | undefined {\r\n\r\n        if (this.publicationsOPDSfeedNeedsUpdate) {\r\n            this.publicationsOPDSfeed = undefined;\r\n            if (fs.existsSync(this.opdsJsonFilePath)) {\r\n                fs.unlinkSync(this.opdsJsonFilePath);\r\n            }\r\n        }\r\n\r\n        if (this.publicationsOPDSfeed) {\r\n            return this.publicationsOPDSfeed;\r\n        }\r\n\r\n        debug(`OPDS2.json => ${this.opdsJsonFilePath}`);\r\n        if (!fs.existsSync(this.opdsJsonFilePath)) {\r\n            if (!this.creatingPublicationsOPDS) {\r\n                this.creatingPublicationsOPDS = true;\r\n\r\n                this.publicationsOPDSfeedNeedsUpdate = false;\r\n\r\n                const jsFile = path.join(__dirname, \"opds2-create-cli.js\");\r\n                const args = [jsFile, this.opdsJsonFilePath];\r\n                this.publications.forEach((pub) => {\r\n                    const filePathBase64 = new Buffer(pub).toString(\"base64\");\r\n                    args.push(filePathBase64);\r\n                });\r\n                // debug(\"SPAWN OPDS2 create: %o\", args);\r\n                debug(`SPAWN OPDS2-create: ${args[0]}`);\r\n\r\n                const child = child_process.spawn(\"node\", args, {\r\n                    cwd: process.cwd(),\r\n                    // detached: true,\r\n                    env: process.env,\r\n                    // stdio: [\"ignore\"],\r\n                })\r\n                    // .unref()\r\n                    ;\r\n                child.stdout.on(\"data\", (data) => {\r\n                    debug(data.toString());\r\n                });\r\n                child.stderr.on(\"data\", (data) => {\r\n                    debug(data.toString());\r\n                });\r\n            }\r\n            return undefined;\r\n        }\r\n        this.creatingPublicationsOPDS = false;\r\n        const jsonStr = fs.readFileSync(this.opdsJsonFilePath, { encoding: \"utf8\" });\r\n        if (!jsonStr) {\r\n            return undefined;\r\n        }\r\n        const json = global.JSON.parse(jsonStr);\r\n\r\n        this.publicationsOPDSfeed = TAJSON.deserialize<OPDSFeed>(json, OPDSFeed);\r\n        return this.publicationsOPDSfeed;\r\n    }\r\n}\r\n"]}