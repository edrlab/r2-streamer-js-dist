{"version":3,"file":"ava.js","sourceRoot":"","sources":["../../../test/ava.ts"],"names":[],"mappings":"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","sourcesContent":["// This is a straight port to TypeScript of ./nodes_modules/ava/profile.js\r\n// with added support for multiple test files (sequential invoke of test runner / worker)\r\n\r\nimport * as EventEmitter from \"events\";\r\n// import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\n\r\nimport * as  arrify from \"arrify\";\r\nimport * as  babelConfigHelper from \"ava/lib/babel-config\";\r\nimport * as  CachingPrecompiler from \"ava/lib/caching-precompiler\";\r\nimport * as  globals from \"ava/lib/globals\";\r\nimport * as  Promise from \"bluebird\";\r\n// import * as _eval from \"eval\";\r\nimport * as  findCacheDir from \"find-cache-dir\";\r\nimport * as  meow from \"meow\";\r\nimport * as  pkgConf from \"pkg-conf\";\r\nimport * as  resolveCwd from \"resolve-cwd\";\r\nimport * as  uniqueTempDir from \"unique-temp-dir\";\r\n\r\n// const workerPath = fs.realpathSync(path.join(__dirname, \"../../../node_modules/ava/lib/test-worker.js\"));\r\n// console.log(workerPath);\r\n// const workerCode = fs.readFileSync(workerPath, { encoding: \"utf8\" });\r\n\r\nfunction resolveModules(modules: any) {\r\n    return arrify(modules).map((name: any) => {\r\n        const modulePath = resolveCwd(name);\r\n\r\n        if (modulePath === null) {\r\n            throw new Error(`Could not resolve required module '${name}'`);\r\n        }\r\n\r\n        return modulePath;\r\n    });\r\n}\r\n\r\n// Chrome gets upset when the `this` value is non-null for these functions\r\nglobals.setTimeout = setTimeout.bind(null);\r\nglobals.clearTimeout = clearTimeout.bind(null);\r\n\r\nPromise.longStackTraces();\r\n\r\nconst conf = pkgConf.sync(\"ava\", {\r\n    defaults: {\r\n        babel: \"default\",\r\n    },\r\n});\r\n\r\n// Define a minimal set of options from the main CLI\r\nconst cli = meow(`\r\nUsage\r\n    $ iron-node node_modules/ava/profile.js <test-files>\r\nOptions\r\n    --fail-fast   Stop after first test failure\r\n    --serial, -s  Run tests serially\r\n`, {\r\n        alias: {\r\n            s: \"serial\",\r\n        },\r\n        boolean: [\r\n            \"fail-fast\",\r\n            \"verbose\",\r\n            \"serial\",\r\n            \"tap\",\r\n        ],\r\n        default: conf,\r\n        string: [\r\n            \"_\",\r\n        ],\r\n    });\r\n\r\nif (cli.input.length <= 0) {\r\n    throw new Error(\"Specify test files\");\r\n}\r\n// console.log(cli.input);\r\nconst files = cli.input.map((file: any) => {\r\n    const f = path.resolve(file);\r\n    console.log(f);\r\n    return f;\r\n});\r\nconst cacheDir = findCacheDir({\r\n    files,\r\n    name: \"ava\",\r\n}) || uniqueTempDir();\r\n\r\nbabelConfigHelper.build(process.cwd(), cacheDir, conf.babel, true)\r\n    .then((result: any) => {\r\n        const precompiler = new CachingPrecompiler({\r\n            babelCacheKeys: result.cacheKeys,\r\n            getBabelOptions: result.getOptions,\r\n            path: cacheDir,\r\n        });\r\n\r\n        const precompiled: any = {};\r\n        files.forEach((file: any) => {\r\n            precompiled[file] = precompiler.precompileFile(file);\r\n        });\r\n\r\n        const resolvedModules = resolveModules(conf.require);\r\n\r\n        let uncaughtExceptionCount = 0;\r\n\r\n        let currentIndex = 0;\r\n        function runTest() {\r\n            if (currentIndex >= files.length) {\r\n                return;\r\n            }\r\n            const file = files[currentIndex];\r\n            console.log(`============> ${file}`);\r\n\r\n            const opts = {\r\n                cacheDir,\r\n                failFast: cli.flags.failFast,\r\n                file,\r\n                precompiled,\r\n                require: resolvedModules,\r\n                serial: cli.flags.serial,\r\n                tty: false,\r\n            };\r\n\r\n            uncaughtExceptionCount = 0;\r\n\r\n            // `test-worker` will read process.argv[2] for options\r\n            process.argv[2] = JSON.stringify(opts);\r\n            process.argv.length = 3;\r\n\r\n            if (console.profile) {\r\n                console.profile(\"AVA test-worker process\");\r\n            }\r\n\r\n            setImmediate(() => {\r\n                console.log(\"setImmediate ava/lib/test-worker REQUIRE EVAL\");\r\n                console.log(process.argv[2]);\r\n\r\n                // eslint-disable-next-line import/no-unassigned-import\r\n                require(\"ava/lib/test-worker\");\r\n\r\n                // // eslint-disable-next-line import/no-unassigned-import\r\n                // require(file);\r\n\r\n                // _eval(workerCode,\r\n                //     `${workerPath}`, // _${currentIndex}.js\r\n                //     {},\r\n                //     true);\r\n            });\r\n        }\r\n\r\n        const events = new EventEmitter();\r\n\r\n        // Mock the behavior of a parent process\r\n        (process as any).channel = {\r\n            // tslint:disable-next-line:no-empty\r\n            ref() {\r\n            },\r\n            // tslint:disable-next-line:no-empty\r\n            unref() {\r\n            },\r\n        };\r\n        process.send = (data: any) => {\r\n            if (data && data.ava) {\r\n                const name = data.name.replace(/^ava-/, \"\");\r\n\r\n                if (events.listeners(name).length > 0) {\r\n                    events.emit(name, data.data);\r\n                } else {\r\n                    console.log(\"UNHANDLED AVA EVENT:\", name, data.data);\r\n                }\r\n\r\n                return;\r\n            }\r\n\r\n            console.log(\"NON AVA EVENT:\", data);\r\n        };\r\n\r\n        events.on(\"test\", (data: any) => {\r\n            console.log(\"TEST:\", data.title, data.error);\r\n        });\r\n\r\n        events.on(\"results\", (data: any) => {\r\n\r\n            console.log(\"RESULTS:\", data.stats);\r\n            currentIndex++;\r\n            if (currentIndex < files.length) {\r\n                runTest();\r\n            } else {\r\n                console.log(\"ALL TESTS DONE.\");\r\n\r\n                if (console.profileEnd) {\r\n                    console.profileEnd();\r\n                }\r\n\r\n                if (process.exit) {\r\n                    console.log(\"EXIT ...\");\r\n                    // eslint-disable-next-line unicorn/no-process-exit\r\n                    process.exit(data.stats.failCount + uncaughtExceptionCount);\r\n                }\r\n            }\r\n        });\r\n\r\n        events.on(\"stats\", () => {\r\n            setImmediate(() => {\r\n                (process as any).emit(\"ava-run\", {});\r\n            });\r\n        });\r\n\r\n        events.on(\"uncaughtException\", (data: any) => {\r\n            uncaughtExceptionCount++;\r\n            let stack = data && data.exception && data.exception.stack;\r\n            stack = stack || data;\r\n            console.log(stack);\r\n        });\r\n\r\n        runTest();\r\n    });\r\n"]}